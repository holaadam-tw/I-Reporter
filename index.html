<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>I-Reporter v1.7 | æˆå“çµ„è£ Ã— åŒ…è£å…¥åº« æ ¸å°ç³»çµ±</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#F0EDE6;--surface:#FAFAF7;--border:#D8D3CA;--text:#2C2A26;--muted:#8A857C;--primary:#1A6B4E;--primary-light:#E8F5EE;--primary-dark:#0F4030;--danger:#C4362C;--danger-light:#FDF0EF;--warning:#B8860B;--warning-light:#FFF8E7;--success:#1A6B4E;--success-light:#E8F5EE;--accent:#2D5F8A}
body{font-family:'Noto Sans TC','Helvetica Neue',sans-serif;background:var(--bg);color:var(--text);font-size:14px}
code{font-family:'JetBrains Mono',monospace}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.header{background:var(--primary-dark);border-bottom:3px solid var(--primary)}
.header-inner{max-width:1400px;margin:0 auto;padding:14px 24px;display:flex;align-items:center;justify-content:space-between}
.header-logo{width:38px;height:38px;border-radius:8px;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:18px}
.header-title{color:#fff;font-size:17px;font-weight:700;letter-spacing:.02em}
.header-sub{color:rgba(255,255,255,.5);font-size:11px}
.tab-bar{background:var(--surface);border-bottom:1px solid var(--border)}
.tab-bar-inner{max-width:1400px;margin:0 auto;padding:0 24px;display:flex;gap:0;overflow-x:auto}
.tab-btn{padding:12px 20px;border:none;background:none;cursor:pointer;font-size:13px;font-weight:500;color:var(--muted);border-bottom:3px solid transparent;transition:all .15s;display:flex;align-items:center;gap:6px;white-space:nowrap;font-family:inherit}
.tab-btn.active{font-weight:700;color:var(--primary);border-bottom-color:var(--primary)}
.tab-btn:hover{color:var(--primary)}
.content{max-width:1400px;margin:0 auto;padding:20px 24px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;transition:all .15s}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-bottom:20px}
.stat-card{display:flex;align-items:center;gap:14px;cursor:pointer;user-select:none}
.stat-card:hover{border-color:var(--primary);transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.06)}
.stat-card.active{border-width:2px;box-shadow:0 2px 12px rgba(0,0,0,.1)}
.stat-icon{width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff;flex-shrink:0}
.stat-value{font-size:26px;font-weight:700;font-family:'JetBrains Mono',monospace}
.stat-label{font-size:12px;color:var(--muted)}
.badge{display:inline-flex;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;white-space:nowrap}
.badge-error{background:var(--danger-light);color:var(--danger);border:1px solid rgba(196,54,44,.2)}
.badge-warning{background:var(--warning-light);color:var(--warning);border:1px solid rgba(184,134,11,.2)}
.badge-success{background:var(--success-light);color:var(--success);border:1px solid rgba(26,107,78,.2)}
.badge-info{background:#EDF4FA;color:var(--accent);border:1px solid rgba(45,95,138,.2)}
.badge-neutral{background:#F0EDE6;color:var(--muted);border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:13px}
thead tr{background:var(--primary-dark)}
thead th{padding:10px 10px;color:#fff;font-weight:600;text-align:left;font-size:12px;cursor:pointer;user-select:none;white-space:nowrap}
thead th:hover{background:rgba(255,255,255,.1)}
thead th .sort-arrow{margin-left:4px;font-size:10px;opacity:.6}
thead th.sorted .sort-arrow{opacity:1}
tbody td{padding:8px 10px;color:var(--text)}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
tbody tr:nth-child(even){background:var(--surface)}
tbody tr:nth-child(odd){background:#fff}
tbody tr:hover{background:var(--primary-light)}
tbody tr.clickable{cursor:pointer}
.table-wrap{border:1px solid var(--border);border-radius:8px;overflow:hidden;overflow-x:auto}
.expand-row{background:#f8f7f4!important;animation:fadeIn .2s}
.expand-row td{padding:0}
.expand-content{padding:16px 20px}
.expand-section{margin-bottom:16px;background:#f5f4f0;border-radius:8px;padding:14px 16px;border-left:4px solid var(--accent)}
.expand-section:last-child{border-left-color:var(--primary)}
.expand-title{font-size:13px;font-weight:700;color:var(--primary);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.expand-table{width:100%;font-size:12px;border:1px solid var(--border);border-radius:6px;overflow:hidden;border-collapse:separate;border-spacing:0}
.expand-table thead tr{background:#2a4a3e}
.expand-table thead th{padding:8px 10px;font-size:11px;font-weight:700;cursor:default;letter-spacing:.3px}
.expand-table tbody td{padding:8px 10px;font-size:12px;border-bottom:1px solid var(--border)}
.expand-table tbody tr:last-child td{border-bottom:none}
.expand-table .qty-cell{font-family:'JetBrains Mono',monospace;font-size:1.2em;font-weight:700;color:#1a1a1a;text-align:right}
.match-status-ok{color:#2e7d32;font-weight:600;white-space:nowrap}
.match-status-pending{color:#e65100;font-weight:600;white-space:nowrap}
.match-status-over{color:#c62828;font-weight:600;white-space:nowrap}
.match-num{font-size:1.3em;font-weight:700}
.btn{padding:7px 16px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;font-family:inherit;transition:all .15s}
.btn-primary{border:none;background:var(--primary);color:#fff}
.btn-primary:hover{background:var(--primary-dark)}
.btn-secondary{border:1px solid var(--border);background:var(--surface);color:var(--text)}
.btn-sm{padding:4px 10px;font-size:12px}
.btn-edit{padding:2px 8px;font-size:11px;border:1px solid var(--accent);background:#EDF4FA;color:var(--accent);border-radius:4px;cursor:pointer;font-weight:600}
.btn-edit:hover{background:var(--accent);color:#fff}
.input{padding:7px 10px;border-radius:6px;border:1px solid var(--border);font-size:13px;color:var(--text);background:#fff;outline:none;font-family:inherit;transition:border .15s}
.input:focus{border-color:var(--primary);box-shadow:0 0 0 2px rgba(26,107,78,.12)}
select.input{cursor:pointer}
.form-box{background:var(--surface);border:2px solid rgba(26,107,78,.2);border-radius:8px;padding:16px;margin-bottom:16px;animation:fadeIn .2s}
.form-title{font-weight:700;margin-bottom:12px;color:var(--primary);font-size:14px}
.form-row{display:flex;gap:6px;margin-bottom:6px;align-items:center;flex-wrap:wrap}
.order-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px 16px;margin-bottom:6px;cursor:pointer;transition:all .15s}
.order-card:hover,.order-card.selected{border-color:var(--primary);background:var(--primary-light)}
.order-no{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:14px}
.order-date{font-size:12px;color:var(--muted);margin-top:2px}
.split-view{display:flex;gap:16px}
.split-left{flex:1;min-width:0;max-height:70vh;overflow-y:auto}
.split-right{flex:1.8;min-width:0}
.search-select{position:relative;display:inline-block}
.search-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--border);border-radius:0 0 6px 6px;max-height:200px;overflow-y:auto;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,.1)}
.search-dropdown-item{padding:6px 10px;cursor:pointer;font-size:13px;border-bottom:1px solid #f0f0f0}
.search-dropdown-item:hover{background:var(--primary-light)}
.search-dropdown-item code{font-size:12px;color:var(--muted);margin-right:6px}
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite;margin:50px auto}
.toast{position:fixed;top:16px;right:16px;padding:10px 18px;border-radius:8px;color:#fff;font-size:13px;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,.15);display:flex;align-items:center;gap:10px;max-width:400px;animation:fadeIn .2s}
.toast-close{background:none;border:none;color:#fff;font-size:16px;cursor:pointer;padding:0}
.filter-bar{display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.filter-label{font-size:12px;color:var(--muted);font-weight:600}
.row-error{background:var(--danger-light)!important}
.row-warning{background:var(--warning-light)!important}
.row-resolved{opacity:.55}
.row-confirmed{background:rgba(39,174,96,.08)!important}
.row-hidden{opacity:.3}
.resolve-check{width:18px;height:18px;accent-color:var(--primary);cursor:pointer}
.supplement-box{background:#EDF4FA;border:2px solid rgba(45,95,138,.3);border-radius:8px;padding:14px;margin-top:10px;animation:fadeIn .2s}
.supplement-title{font-size:13px;font-weight:700;color:var(--accent);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.staff-select-wrap{position:relative;display:inline-flex;align-items:center;gap:2px}
.staff-add-btn{padding:4px 8px;border:1px solid var(--border);border-radius:4px;background:var(--primary-light);color:var(--primary);font-size:11px;cursor:pointer;font-weight:700;white-space:nowrap}
.staff-add-btn:hover{background:var(--primary);color:#fff}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;display:flex;align-items:center;justify-content:center}
.modal{background:#fff;border-radius:12px;padding:24px;max-width:420px;width:90%;box-shadow:0 8px 30px rgba(0,0,0,.2);animation:fadeIn .15s}
.modal-wide{max-width:720px}
.modal-title{font-size:16px;font-weight:700;margin-bottom:16px}
.modal-field{margin-bottom:12px}
.modal-field label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:600}
.resolve-actions{display:flex;align-items:center;gap:6px;white-space:nowrap}
.resolve-tag{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;background:var(--primary-light);color:var(--primary);border:1px solid rgba(26,107,78,.2)}
.hide-tag{background:var(--warning-light);color:var(--warning);border:1px solid rgba(184,134,11,.2)}
.confirmed-tag{background:rgba(39,174,96,.12);color:#1a6b4e;border:1px solid rgba(39,174,96,.3)}
.row-confirmed-entry{background:rgba(39,174,96,.07)!important}
.row-confirmed-entry:hover{background:rgba(39,174,96,.13)!important}
.toggle-switch{position:relative;display:inline-block;width:40px;height:22px;border-radius:11px;cursor:pointer;transition:all .2s;border:none;padding:0;outline:none;vertical-align:middle;flex-shrink:0}
.toggle-switch.off{background:#ccc}
.toggle-switch.on{background:var(--success)}
.toggle-switch::after{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#fff;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);pointer-events:none}
.toggle-switch.on::after{transform:translateX(18px)}
.footer{text-align:center;padding:20px;color:var(--muted);font-size:11px;border-top:1px solid var(--border);margin-top:30px}
.show-resolved-toggle{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);cursor:pointer;user-select:none}
.show-resolved-toggle input{accent-color:var(--primary)}
@media(max-width:768px){
  .split-view{flex-direction:column}
  .stat-grid{grid-template-columns:repeat(2,1fr)}
  .form-row{flex-direction:column}
  .form-row .input,.form-row select,.form-row .search-select{width:100%!important;min-width:0!important}
}
@media print{
  .header,.tab-bar,.filter-bar,.stat-grid,.no-print,.footer,.btn,.btn-edit,.resolve-actions,.search-row input{display:none!important}
  .content{padding:0!important;max-width:100%!important}
  .table-wrap{border:none!important;box-shadow:none!important}
  table{font-size:11px!important}
  thead tr{background:#333!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .expand-row,.row-error,.row-warning,.row-resolved{-webkit-print-color-adjust:exact;print-color-adjust:exact}
  body{background:#fff!important}
  .print-header{display:block!important;text-align:center;padding:16px 0;border-bottom:2px solid #333;margin-bottom:16px}
  .print-header h1{font-size:18px;margin:0}
  .print-header p{font-size:12px;color:#666;margin-top:4px}
}
.print-header{display:none}
.action-bar{display:flex;gap:6px;flex-wrap:wrap}
.btn-icon{padding:6px 12px;font-size:12px;display:flex;align-items:center;gap:4px}
.import-mapping{background:#f8f7f4;border-radius:8px;padding:12px;margin-bottom:12px}
.import-mapping-row{display:flex;align-items:center;gap:8px;padding:4px 0;flex-wrap:wrap}
.import-mapping-code{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:13px;min-width:60px;background:#fff;border:1px solid #e0ddd5;border-radius:4px;padding:2px 8px}
.import-error-row{background:#fef2f2!important}
.import-error-row td{color:#b91c1c}
.import-stats{display:flex;gap:16px;font-size:12px;color:var(--muted);padding:8px 0;flex-wrap:wrap}
.import-stats strong{color:var(--text)}
.import-sheet-tabs{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap}
.import-sheet-tab{padding:4px 12px;border-radius:4px;font-size:12px;cursor:pointer;border:1px solid #e0ddd5;background:#fff}
.import-sheet-tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.import-preview{max-height:360px;overflow:auto;border:1px solid #e0ddd5;border-radius:6px}
.import-preview table{font-size:11px}
.import-preview td,.import-preview th{padding:4px 8px;white-space:nowrap}
.import-step-indicator{display:flex;gap:8px;margin-bottom:16px;font-size:12px;color:var(--muted)}
.import-step-indicator .active-step{color:var(--primary);font-weight:700}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const SUPABASE_URL="https://ndyyicskqplybpdtbksm.supabase.co";
const SUPABASE_ANON_KEY="sb_publishable_YPtz-9UqNdO1KyeFdPNrQw_KZH3Wt9a";

async function supaFetch(table,{method="GET",body,query="",headers:extra={}}={}){
  const url=`${SUPABASE_URL}/rest/v1/${table}${query?"?"+query:""}`;
  const headers={apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`,"Content-Type":"application/json",...(method==="POST"||method==="PATCH"?{Prefer:"return=representation"}:{}), ...extra};
  const res=await fetch(url,{method,headers,body:body?JSON.stringify(body):undefined});
  if(!res.ok){const e=await res.text();throw new Error(`${res.status}: ${e}`);}
  const text=await res.text(); return text?JSON.parse(text):null;
}
async function supaRpc(fn,params={}){
  const res=await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`,{method:"POST",headers:{apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`,"Content-Type":"application/json"},body:JSON.stringify(params)});
  if(!res.ok)throw new Error(await res.text()); return res.json();
}
async function supaDelete(table,query){
  const url=`${SUPABASE_URL}/rest/v1/${table}?${query}`;
  const res=await fetch(url,{method:"DELETE",headers:{apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`}});
  if(!res.ok)throw new Error(await res.text());
}
async function supaPatch(table,query,body){
  const url=`${SUPABASE_URL}/rest/v1/${table}?${query}`;
  const res=await fetch(url,{method:"PATCH",headers:{apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`,"Content-Type":"application/json",Prefer:"return=representation"},body:JSON.stringify(body)});
  if(!res.ok)throw new Error(await res.text());
  const text=await res.text();return text?JSON.parse(text):null;
}

// Fetch all rows, paginating past Supabase 1000-row default limit
async function supaFetchAll(table,baseQuery){
  const pageSize=1000;let all=[];let offset=0;
  while(true){
    const rows=await supaFetch(table,{query:baseQuery+"&limit="+pageSize+"&offset="+offset});
    if(!rows||rows.length===0)break;
    all=all.concat(rows);
    if(rows.length<pageSize)break;
    offset+=pageSize;
  }
  return all;
}

const{useState,useEffect,useCallback,useRef,useMemo}=React;

function exportToExcel(data,columns,filename){
  const ws_data=[columns.map(c=>c.label)];
  data.forEach(r=>{ws_data.push(columns.map(c=>c.value(r)));});
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  ws['!cols']=columns.map(c=>({wch:Math.max(c.label.length*2.5,12)}));
  XLSX.utils.book_append_sheet(wb,ws,"Sheet1");
  XLSX.writeFile(wb,filename);
}

// === Excel Import Utilities ===
function fullWidthToHalf(str){
  if(!str)return"";
  return String(str).replace(/[ï¼-ï¼™]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xFEE0))
    .replace(/ï¼/g,"/").replace(/ï¼š/g,":").replace(/ã€€/g," ").replace(/ï¼‹/g,"+");
}
function parseExcelDate(raw,yearHint){
  if(!raw)return null;
  const s=fullWidthToHalf(String(raw)).trim();
  // Already yyyy-mm-dd or yyyy/mm/dd
  let m=s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
  if(m)return `${m[1]}-${m[2].padStart(2,"0")}-${m[3].padStart(2,"0")}`;
  // mm/dd (no year) â€” use yearHint or current year
  m=s.match(/^(\d{1,2})[\/\-:\.](\d{1,2})$/);
  if(m){const y=yearHint||new Date().getFullYear();return `${y}-${m[1].padStart(2,"0")}-${m[2].padStart(2,"0")}`;}
  // Excel serial number (number)
  if(typeof raw==="number"&&raw>40000&&raw<60000){
    const d=new Date((raw-25569)*86400000);
    if(!isNaN(d))return d.toISOString().slice(0,10);
  }
  return null;
}
function getCellValue(sheet,row,col){
  const addr=XLSX.utils.encode_cell({r:row,c:col});
  return sheet[addr]?.v;
}
function extractDataRows(sheet){
  const rows=[];const stopWords=["æ–°å¢","ä¿å­˜","ä¸»ç®¡","ç¶“ç†","ç°½æ ¸","å¯©æ ¸"];
  const range=XLSX.utils.decode_range(sheet["!ref"]||"A1");
  for(let r=8;r<=range.e.r;r+=4){
    const val=getCellValue(sheet,r,0);
    if(val==null||val==="")break;
    if(stopWords.some(w=>String(val).includes(w)))break;
    rows.push(r);
  }
  return rows;
}
function parseAssemblySheet(sheet,products){
  const items=[];const errors=[];const staffCodes=new Set();
  // orderDate from row0, col AS(44)
  const rawDate=getCellValue(sheet,0,44);
  const orderDate=parseExcelDate(rawDate);
  if(!orderDate)return{orderDate:null,items,errors:["ç„¡æ³•è§£æå·¥å–®æ—¥æœŸ"],staffCodes};
  const yearHint=parseInt(orderDate.slice(0,4));
  const dataRows=extractDataRows(sheet);
  dataRows.forEach((r,idx)=>{
    const code=fullWidthToHalf(String(getCellValue(sheet,r,0)||"")).trim();
    const name=String(getCellValue(sheet,r,6)||"").trim();
    const qty=parseInt(getCellValue(sheet,r,21));
    const asmCode1=fullWidthToHalf(String(getCellValue(sheet,r,25)||"")).trim();
    const asmCode2=fullWidthToHalf(String(getCellValue(sheet,r,27)||"")).trim();
    const serial=fullWidthToHalf(String(getCellValue(sheet,r,31)||"")).trim();
    const whDateRaw=getCellValue(sheet,r,33);
    // æ ¼å¼ "MM/DD:æ•¸é‡" or "MM/DD:æ•¸é‡/æ•¸é‡" â€” å–å†’è™Ÿå‰é¢
    let whDateStr=fullWidthToHalf(String(whDateRaw||"")).trim();
    const colonIdx=whDateStr.indexOf(":");
    if(colonIdx>0)whDateStr=whDateStr.substring(0,colonIdx);
    const whDate=parseExcelDate(whDateStr,yearHint);
    const noteRaw=String(getCellValue(sheet,r,45)||"").trim();
    // Collect staff codes
    if(asmCode1)staffCodes.add(asmCode1);
    if(asmCode2)staffCodes.add(asmCode2);
    // Find product
    const prod=products.find(p=>p.product_id===code);
    const errs=[];
    if(!prod)errs.push("ç”¢å“ç·¨è™Ÿæ‰¾ä¸åˆ°");
    if(!qty||isNaN(qty)||qty<=0)errs.push("æ•¸é‡ç„¡æ•ˆ");
    if(prod&&name&&prod.product_name!==name)errs.push(`åç¨±ä¸ç¬¦(${prod.product_name})`);
    const assembler=[asmCode1,asmCode2].filter(Boolean).join(",");
    const note=[serial?`S/N:${serial}`:"",noteRaw].filter(Boolean).join(" ");
    items.push({row:idx+1,code,name,qty:qty||0,assembler,assemblerCodes:[asmCode1,asmCode2].filter(Boolean),warehouse_date:whDate,note,product_id:prod?.id||null,product_name:prod?.product_name||name,errors:errs,hasError:errs.some(e=>e==="ç”¢å“ç·¨è™Ÿæ‰¾ä¸åˆ°"||e==="æ•¸é‡ç„¡æ•ˆ")});
  });
  return{orderDate,items,errors,staffCodes};
}
function parsePackagingSheet(sheet,products,customers){
  const items=[];const errors=[];const staffCodes=new Set();const customerNames=new Set();
  const rawDate=getCellValue(sheet,0,43);
  const orderDate=parseExcelDate(rawDate);
  if(!orderDate)return{orderDate:null,items,errors:["ç„¡æ³•è§£æå·¥å–®æ—¥æœŸ"],staffCodes,customerNames};
  const yearHint=parseInt(orderDate.slice(0,4));
  const dataRows=extractDataRows(sheet);
  dataRows.forEach((r,idx)=>{
    const code=fullWidthToHalf(String(getCellValue(sheet,r,0)||"")).trim();
    const name=String(getCellValue(sheet,r,6)||"").trim();
    const qty=parseInt(getCellValue(sheet,r,21));
    let custName=fullWidthToHalf(String(getCellValue(sheet,r,25)||"")).trim();
    custName=custName.replace(/\+åº«å­˜$/,"").trim(); // "ä¸Šæµ·+åº«å­˜" â†’ "ä¸Šæµ·"
    const testerCode=fullWidthToHalf(String(getCellValue(sheet,r,33)||"")).trim();
    const assemblerCode=fullWidthToHalf(String(getCellValue(sheet,r,35)||"")).trim();
    const asmDateRaw=getCellValue(sheet,r,37);
    const asmDate=parseExcelDate(asmDateRaw,yearHint);
    const noteRaw=String(getCellValue(sheet,r,43)||"").trim();
    if(testerCode)staffCodes.add(testerCode);
    if(assemblerCode)staffCodes.add(assemblerCode);
    const isStock=!custName||custName==="åº«å­˜";
    if(!isStock)customerNames.add(custName);
    const prod=products.find(p=>p.product_id===code);
    const errs=[];
    if(!prod)errs.push("ç”¢å“ç·¨è™Ÿæ‰¾ä¸åˆ°");
    if(!qty||isNaN(qty)||qty<=0)errs.push("æ•¸é‡ç„¡æ•ˆ");
    if(prod&&name&&prod.product_name!==name)errs.push(`åç¨±ä¸ç¬¦(${prod.product_name})`);
    items.push({row:idx+1,code,name,qty:qty||0,customerName:isStock?"åº«å­˜":custName,testerCode,assemblerCode,assembly_date:asmDate,note:noteRaw,product_id:prod?.id||null,product_name:prod?.product_name||name,is_stock:isStock,errors:errs,hasError:errs.some(e=>e==="ç”¢å“ç·¨è™Ÿæ‰¾ä¸åˆ°"||e==="æ•¸é‡ç„¡æ•ˆ")});
  });
  return{orderDate,items,errors,staffCodes,customerNames};
}

function printSection(title,subtitle){
  const header=document.querySelector('.print-header');
  if(header){header.querySelector('h1').textContent=title;header.querySelector('p').textContent=subtitle||`åˆ—å°æ—¥æœŸ: ${new Date().toISOString().slice(0,10)}`;}
  window.print();
}

function Toast({message,type,onClose}){
  if(!message)return null;
  const bg=type==="error"?"var(--danger)":type==="success"?"var(--primary)":"var(--warning)";
  return <div className="toast" style={{background:bg}}><span style={{flex:1}}>{message}</span><button className="toast-close" onClick={onClose}>Ã—</button></div>;
}
function Badge({type,children}){return <span className={`badge badge-${type||"neutral"}`}>{children}</span>;}

function StaffSelect({staff,value,onChange,onAdd,placeholder,roleFilter,style,multi}){
  const filtered=roleFilter?staff.filter(s=>s.role===roleFilter||s.role==="general"):staff;
  const[open,setOpen]=useState(false);
  const ref=useRef(null);
  useEffect(()=>{const h=e=>{if(ref.current&&!ref.current.contains(e.target))setOpen(false);};document.addEventListener("mousedown",h);return()=>document.removeEventListener("mousedown",h);},[]);
  if(!multi){
    return <div className="staff-select-wrap" style={style}><select className="input" style={{flex:1,minWidth:0}} value={value||""} onChange={e=>onChange(e.target.value)}><option value="">{placeholder||"é¸æ“‡äººå“¡"}</option>{filtered.map(s=><option key={s.id} value={s.name}>{s.code?`[${s.code}] `:""}{s.name}</option>)}</select><button className="staff-add-btn" onClick={onAdd} title="æ–°å¢äººå“¡">ï¼‹</button></div>;
  }
  const selected=(value||"").split(",").filter(Boolean);
  const toggle=(name)=>{const newSel=selected.includes(name)?selected.filter(n=>n!==name):[...selected,name];onChange(newSel.join(","));};
  return <div className="staff-select-wrap" ref={ref} style={{...style,flexDirection:"column",alignItems:"stretch"}}><div style={{display:"flex",gap:2}}><div className="input" style={{flex:1,minWidth:0,cursor:"pointer",minHeight:34,display:"flex",alignItems:"center",flexWrap:"wrap",gap:3,padding:"4px 8px"}} onClick={()=>setOpen(!open)}>{selected.length===0?<span style={{color:"var(--muted)",fontSize:13}}>{placeholder||"é¸æ“‡äººå“¡ï¼ˆå¯è¤‡é¸ï¼‰"}</span>:selected.map(n=><span key={n} style={{background:"var(--primary-light)",color:"var(--primary)",padding:"1px 6px",borderRadius:4,fontSize:11,fontWeight:600,display:"inline-flex",alignItems:"center",gap:3}}>{n}<span style={{cursor:"pointer",fontSize:13}} onClick={e=>{e.stopPropagation();toggle(n);}}>Ã—</span></span>)}</div><button className="staff-add-btn" onClick={onAdd} title="æ–°å¢äººå“¡">ï¼‹</button></div>{open&&<div style={{position:"absolute",top:"100%",left:0,right:0,background:"#fff",border:"1px solid var(--border)",borderRadius:"0 0 6px 6px",maxHeight:180,overflowY:"auto",zIndex:100,boxShadow:"0 4px 12px rgba(0,0,0,.1)"}}>{filtered.map(s=><div key={s.id} style={{padding:"8px 10px",cursor:"pointer",fontSize:13,display:"flex",alignItems:"center",gap:6,borderBottom:"1px solid #f0f0f0",background:selected.includes(s.name)?"var(--primary-light)":"transparent"}} onClick={()=>toggle(s.name)}><span style={{width:16,height:16,borderRadius:3,border:"2px solid "+(selected.includes(s.name)?"var(--primary)":"var(--border)"),background:selected.includes(s.name)?"var(--primary)":"transparent",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:11,flexShrink:0}}>{selected.includes(s.name)?"âœ“":""}</span>{s.code?<span style={{color:"var(--muted)",fontSize:11,marginRight:2}}>[{s.code}]</span>:null}{s.name}</div>)}</div>}</div>;
}

function AddStaffModal({show,onClose,onSave,defaultRole}){
  const[name,setName]=useState("");const[code,setCode]=useState("");const[role,setRole]=useState(defaultRole||"general");
  if(!show)return null;
  const save=()=>{if(!name.trim())return;onSave(name.trim(),role,code.trim()||null);setName("");setCode("");onClose();};
  return <div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-title">æ–°å¢äººå“¡</div><div className="modal-field"><label>ä»£è™Ÿ <span style={{fontSize:11,color:"var(--muted)"}}>(å¦‚ R, B, N)</span></label><input className="input" style={{width:"100%"}} value={code} onChange={e=>setCode(e.target.value)} placeholder="ä»£è™Ÿï¼ˆé¸å¡«ï¼‰"/></div><div className="modal-field"><label>å§“å</label><input className="input" style={{width:"100%"}} value={name} onChange={e=>setName(e.target.value)} placeholder="è«‹è¼¸å…¥å§“å" autoFocus onKeyDown={e=>e.key==="Enter"&&save()}/></div><div className="modal-field"><label>è§’è‰²</label><select className="input" style={{width:"100%"}} value={role} onChange={e=>setRole(e.target.value)}><option value="assembler">çµ„è£äººå“¡</option><option value="tester">æ¸¬è©¦äººå“¡</option><option value="inspector">æª¢é©—äººå“¡</option><option value="general">ä¸€èˆ¬</option></select></div><div style={{display:"flex",gap:8,justifyContent:"flex-end"}}><button className="btn btn-secondary" onClick={onClose}>å–æ¶ˆ</button><button className="btn btn-primary" onClick={save}>æ–°å¢</button></div></div></div>;
}

function EditQtyModal({show,onClose,onSave,item,tableName,staff,onAddStaff}){
  const[newQty,setNewQty]=useState(item?.qty||0);const[editedBy,setEditedBy]=useState("");const[reason,setReason]=useState("");
  useEffect(()=>{if(item){setNewQty(item.qty);setEditedBy("");setReason("");}},[item]);
  if(!show||!item)return null;
  const save=()=>{if(!editedBy.trim()){alert("è«‹é¸æ“‡ä¿®æ”¹äººå“¡");return;}if(!reason.trim()){alert("è«‹å¡«å¯«ä¿®æ”¹åŸå› ");return;}if(parseInt(newQty)===0){alert("æ•¸é‡ä¸å¯ç‚º 0ï¼Œå¦‚éœ€ç§»é™¤è«‹ä½¿ç”¨åˆªé™¤åŠŸèƒ½");return;}if(parseInt(newQty)===item.qty){alert("æ•¸é‡æœªè®Šæ›´");return;}onSave({recordId:item.id,tableName,oldQty:item.qty,newQty:parseInt(newQty),editedBy:editedBy.trim(),reason:reason.trim()});};
  return <div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-title">âœï¸ ä¿®æ”¹æ•¸é‡</div><div style={{background:"#f8f7f4",borderRadius:6,padding:10,marginBottom:14,fontSize:12}}><div><strong>å–®è™Ÿï¼š</strong>{item.orderNo}</div><div><strong>ç”¢å“ï¼š</strong>{item.productCode} - {item.productName}</div></div><div className="modal-field"><label>åŸå§‹æ•¸é‡</label><div style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:18,color:"var(--muted)"}}>{item.qty}</div></div><div className="modal-field"><label>æ–°æ•¸é‡ <span style={{color:"var(--danger)"}}>*</span></label><input type="number" className="input" style={{width:"100%",fontSize:16,fontWeight:700}} min="0" value={newQty} onChange={e=>setNewQty(e.target.value)} autoFocus/></div><div className="modal-field"><label>ä¿®æ”¹äººå“¡ <span style={{color:"var(--danger)"}}>*</span></label><StaffSelect staff={staff} value={editedBy} onChange={setEditedBy} onAdd={onAddStaff} style={{width:"100%"}}/></div><div className="modal-field"><label>ä¿®æ”¹åŸå›  <span style={{color:"var(--danger)"}}>*</span></label><input className="input" style={{width:"100%"}} value={reason} onChange={e=>setReason(e.target.value)} placeholder="ä¾‹ï¼šæ•¸é‡è¨ˆç®—éŒ¯èª¤ã€è£œæ•¸ã€å®¢æˆ¶è¦æ±‚è®Šæ›´..." onKeyDown={e=>e.key==="Enter"&&save()}/></div><div style={{fontSize:11,color:"var(--muted)",marginBottom:12}}>ä¿®æ”¹æ—¥æœŸï¼š{new Date().toISOString().slice(0,10)} Â· æ‰€æœ‰ä¿®æ”¹è¨˜éŒ„å°‡è¢«ä¿å­˜</div><div style={{display:"flex",gap:8,justifyContent:"flex-end"}}><button className="btn btn-secondary" onClick={onClose}>å–æ¶ˆ</button><button className="btn btn-primary" onClick={save}>ç¢ºèªä¿®æ”¹</button></div></div></div>;
}

function EditFullItemModal({show,onClose,onSave,item,type,products,customers,staff,onAddStaff}){
  const isAsm=type==="assembly";
  const[form,setForm]=useState({});
  useEffect(()=>{if(item){
    if(isAsm)setForm({product_id:item.product_id||"",qty:item.qty||1,assembler:item.assembler||"",warehouse_date:item.warehouse_date||"",note:item.note||""});
    else setForm({product_id:item.product_id||"",qty:item.qty||1,customer_id:item.customer_id||"",is_stock:item.is_stock??true,tester:item.tester||"",assembler:item.assembler||"",assembly_date:item.assembly_date||"",note:item.note||""});
  }},[item,type]);
  if(!show||!item)return null;
  const save=()=>{const q=parseInt(form.qty);if(!q||q<=0){alert("æ•¸é‡ä¸å¯ç‚º 0ï¼Œè«‹ä½¿ç”¨åˆªé™¤åŠŸèƒ½");return;}if(!form.product_id){alert("è«‹é¸æ“‡ç”¢å“");return;}onSave(form);};
  return <div className="modal-overlay" onClick={onClose}><div className="modal modal-wide" onClick={e=>e.stopPropagation()}>
    <div className="modal-title">{item.id?"âœï¸ ä¿®æ”¹æ˜ç´°":"â• æ–°å¢æ˜ç´°"}</div>
    <div className="modal-field"><label>ç”¢å“</label><ProductSearch products={products} value={form.product_id} onChange={v=>setForm({...form,product_id:v})} style={{width:"100%"}}/></div>
    <div className="modal-field"><label>æ•¸é‡</label><input type="number" className="input" style={{width:"100%"}} min="1" value={form.qty} onChange={e=>setForm({...form,qty:e.target.value})} autoFocus/></div>
    {isAsm?<>
      <div className="modal-field"><label>çµ„è£äººå“¡</label><StaffSelect staff={staff} value={form.assembler} onChange={v=>setForm({...form,assembler:v})} onAdd={()=>onAddStaff("assembler")} roleFilter="assembler" multi style={{width:"100%"}}/></div>
      <div className="modal-field"><label>å…¥åº«æ—¥æœŸ</label><input type="date" className="input" style={{width:"100%"}} value={form.warehouse_date} onChange={e=>setForm({...form,warehouse_date:e.target.value})}/></div>
    </>:<>
      <div className="modal-field"><label>å®¢æˆ¶</label><select className="input" style={{width:"100%"}} value={form.customer_id} onChange={e=>setForm({...form,customer_id:e.target.value,is_stock:!e.target.value})}><option value="">åº«å­˜ï¼ˆç„¡å®¢æˆ¶ï¼‰</option>{(customers||[]).map(c=><option key={c.id} value={c.id}>{c.customer_code?c.customer_code+" - ":""}{c.name}</option>)}</select></div>
      <div className="modal-field"><label>æ¸¬è©¦äººå“¡</label><StaffSelect staff={staff} value={form.tester} onChange={v=>setForm({...form,tester:v})} onAdd={()=>onAddStaff("tester")} roleFilter="tester" multi style={{width:"100%"}}/></div>
      <div className="modal-field"><label>çµ„è£äººå“¡</label><StaffSelect staff={staff} value={form.assembler} onChange={v=>setForm({...form,assembler:v})} onAdd={()=>onAddStaff("assembler")} roleFilter="assembler" multi style={{width:"100%"}}/></div>
      <div className="modal-field"><label>çµ„è£æ—¥æœŸ</label><input type="date" className="input" style={{width:"100%"}} value={form.assembly_date} onChange={e=>setForm({...form,assembly_date:e.target.value})}/></div>
    </>}
    <div className="modal-field"><label>å‚™è¨»</label><input className="input" style={{width:"100%"}} value={form.note} onChange={e=>setForm({...form,note:e.target.value})} placeholder="å‚™è¨»" onKeyDown={e=>e.key==="Enter"&&save()}/></div>
    <div style={{display:"flex",gap:8,justifyContent:"flex-end",marginTop:12}}><button className="btn btn-secondary" onClick={onClose}>å–æ¶ˆ</button><button className="btn btn-primary" onClick={save}>{item.id?"ç¢ºèªä¿®æ”¹":"ç¢ºèªæ–°å¢"}</button></div>
  </div></div>;
}

function ImportExcelModal({show,type,onClose,products,customers,staff,toast,onImportDone,onAddStaff}){
  const[step,setStep]=useState(1);const[sheets,setSheets]=useState([]);const[activeSheet,setActiveSheet]=useState(0);
  const[staffMapping,setStaffMapping]=useState({});const[customerMapping,setCustomerMapping]=useState({});
  const[importing,setImporting]=useState(false);const[result,setResult]=useState(null);
  const fileRef=useRef(null);
  const isAsm=type==="assembly";
  const label=isAsm?"çµ„è£":"åŒ…è£";
  const keyword=isAsm?"çµ„è£":"åŒ…è£";

  useEffect(()=>{if(show){setStep(1);setSheets([]);setActiveSheet(0);setStaffMapping({});setCustomerMapping({});setImporting(false);setResult(null);}},[show]);

  const handleFile=e=>{
    const file=e.target.files?.[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const wb=XLSX.read(ev.target.result,{type:"array"});
        const parsed=[];
        wb.SheetNames.forEach(name=>{
          const ws=wb.Sheets[name];
          if(!ws)return;
          // Try parsing regardless of sheet name, let user decide
          const matchesKeyword=name.includes(keyword);
          let data;
          if(isAsm)data=parseAssemblySheet(ws,products);
          else data=parsePackagingSheet(ws,products,customers||[]);
          if(data.items.length>0||matchesKeyword)parsed.push({name,data});
        });
        if(!parsed.length){toast("æœªæ‰¾åˆ°å¯è§£æçš„å·¥ä½œè¡¨","error");return;}
        setSheets(parsed);
        // Build initial staff mapping (match by code first, then by name)
        const sm={};
        parsed.forEach(s=>s.data.staffCodes.forEach(code=>{
          if(!sm[code]){const found=staff.find(st=>(st.code||"").toLowerCase()===code.toLowerCase())||staff.find(st=>st.name===code);sm[code]=found?found.name:"";}
        }));
        setStaffMapping(sm);
        // Build initial customer mapping (packaging only)
        if(!isAsm){
          const cm={};
          parsed.forEach(s=>(s.data.customerNames||new Set()).forEach(cn=>{
            if(!cm[cn]){const found=(customers||[]).find(c=>c.name===cn);cm[cn]=found?found.id:"";}
          }));
          setCustomerMapping(cm);
        }
        setStep(2);
      }catch(ex){toast("Excel è§£æå¤±æ•—: "+ex.message,"error");}
    };
    reader.readAsArrayBuffer(file);
  };

  const doImport=async()=>{
    setImporting(true);let success=0,failed=0;
    try{
      for(const s of sheets){
        const d=s.data;
        if(!d.orderDate){failed+=d.items.length;continue;}
        const orderBody=isAsm?{order_date:d.orderDate,status:"draft"}:{order_date:d.orderDate,status:"draft"};
        let order;
        try{
          const tableName=isAsm?"assembly_orders":"packaging_orders";
          [order]=await supaFetch(tableName,{method:"POST",body:orderBody});
        }catch(ex){failed+=d.items.length;continue;}
        for(const it of d.items){
          if(it.hasError){failed++;continue;}
          try{
            if(isAsm){
              const assemblerNames=it.assemblerCodes.map(c=>staffMapping[c]||c).filter(Boolean).join(",");
              await supaFetch("assembly_items",{method:"POST",body:{order_id:order.id,product_id:it.product_id,qty:it.qty,assembler:assemblerNames,warehouse_date:it.warehouse_date||null,note:it.note||null}});
            }else{
              const testerName=staffMapping[it.testerCode]||it.testerCode||"";
              const assemblerName=staffMapping[it.assemblerCode]||it.assemblerCode||"";
              const custId=it.is_stock?null:(customerMapping[it.customerName]||null);
              await supaFetch("packaging_items",{method:"POST",body:{order_id:order.id,product_id:it.product_id,qty:it.qty,customer_id:custId,is_stock:it.is_stock,tester:testerName,assembler:assemblerName,assembly_date:it.assembly_date||null,note:it.note||null}});
            }
            success++;
          }catch(ex){failed++;}
        }
      }
      setResult({success,failed});setStep(3);
      if(success>0)onImportDone();
    }catch(ex){toast("åŒ¯å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤: "+ex.message,"error");}
    setImporting(false);
  };

  if(!show)return null;
  const cur=sheets[activeSheet]?.data;
  const totalItems=sheets.reduce((s,sh)=>s+sh.data.items.length,0);
  const totalErrors=sheets.reduce((s,sh)=>s+sh.data.items.filter(i=>i.hasError).length,0);
  const allStaffCodes=Object.keys(staffMapping);
  const allCustNames=Object.keys(customerMapping);
  const hasUnmappedStaff=allStaffCodes.some(c=>!staffMapping[c]);
  const hasUnmappedCust=!isAsm&&allCustNames.some(c=>!customerMapping[c]);

  return <div className="modal-overlay" onClick={onClose}><div className="modal" style={{maxWidth:900,width:"95vw",maxHeight:"90vh",overflow:"auto"}} onClick={e=>e.stopPropagation()}>
    <div className="modal-title">ğŸ“¤ åŒ¯å…¥{label} Excel</div>
    <div className="import-step-indicator">
      <span className={step===1?"active-step":""}>1.é¸æ“‡æª”æ¡ˆ</span>â†’
      <span className={step===2?"active-step":""}>2.å°æ‡‰é è¦½</span>â†’
      <span className={step===3?"active-step":""}>3.çµæœ</span>
    </div>

    {step===1&&<div style={{textAlign:"center",padding:"30px 0"}}>
      <p style={{marginBottom:16,color:"var(--muted)",fontSize:13}}>é¸æ“‡{label}å ±è¡¨ Excel æª”æ¡ˆ (.xlsx / .xls)</p>
      <input ref={fileRef} type="file" accept=".xlsx,.xls" onChange={handleFile} style={{display:"none"}}/>
      <button className="btn btn-primary" onClick={()=>fileRef.current?.click()}>é¸æ“‡æª”æ¡ˆ</button>
    </div>}

    {step===2&&cur&&<div>
      {/* Staff mapping */}
      {allStaffCodes.length>0&&<div className="import-mapping">
        <div style={{fontWeight:600,fontSize:13,marginBottom:8}}>äººå“¡ä»£ç¢¼å°æ‡‰ ({allStaffCodes.length} ä½)</div>
        {allStaffCodes.map(code=><div key={code} className="import-mapping-row">
          <span className="import-mapping-code">{code}</span><span>â†’</span>
          <StaffSelect staff={staff} value={staffMapping[code]||""} onChange={v=>setStaffMapping(p=>({...p,[code]:v}))} onAdd={onAddStaff} placeholder="é¸æ“‡äººå“¡" style={{width:180}}/>
          {!staffMapping[code]&&<span style={{fontSize:11,color:"var(--warning)"}}>æœªå°æ‡‰</span>}
        </div>)}
      </div>}
      {/* Customer mapping (packaging) */}
      {!isAsm&&allCustNames.length>0&&<div className="import-mapping">
        <div style={{fontWeight:600,fontSize:13,marginBottom:8}}>å®¢æˆ¶å°æ‡‰ ({allCustNames.length} ä½)</div>
        {allCustNames.map(cn=><div key={cn} className="import-mapping-row">
          <span className="import-mapping-code">{cn}</span><span>â†’</span>
          <select className="input" style={{width:200}} value={customerMapping[cn]||""} onChange={e=>setCustomerMapping(p=>({...p,[cn]:e.target.value}))}>
            <option value="">-- é¸æ“‡å®¢æˆ¶ --</option>
            {(customers||[]).map(c=><option key={c.id} value={c.id}>{c.customer_code?c.customer_code+" - ":""}{c.name}</option>)}
          </select>
          {!customerMapping[cn]&&<span style={{fontSize:11,color:"var(--warning)"}}>æœªå°æ‡‰</span>}
        </div>)}
      </div>}
      {/* Sheet tabs */}
      {sheets.length>1&&<div className="import-sheet-tabs">
        {sheets.map((s,i)=><span key={i} className={`import-sheet-tab ${activeSheet===i?"active":""}`} onClick={()=>setActiveSheet(i)}>{s.name}</span>)}
      </div>}
      {/* Stats */}
      <div className="import-stats">
        <span>å·¥ä½œè¡¨: <strong>{sheets[activeSheet]?.name}</strong></span>
        <span>æ—¥æœŸ: <strong>{cur.orderDate||"ç„¡æ³•è§£æ"}</strong></span>
        <span>è§£æ: <strong>{cur.items.length}</strong> ç­†</span>
        <span>éŒ¯èª¤: <strong style={{color:cur.items.filter(i=>i.hasError).length?"var(--danger)":"inherit"}}>{cur.items.filter(i=>i.hasError).length}</strong> ç­†</span>
      </div>
      {/* Preview table */}
      <div className="import-preview">
        <table><thead><tr>
          <th>#</th><th>ç”¢å“ç·¨è™Ÿ</th><th>ç”¢å“åç¨±</th><th>æ•¸é‡</th>
          {isAsm?<><th>çµ„è£äººå“¡</th><th>å…¥åº«æ—¥æœŸ</th></>:<><th>å®¢æˆ¶</th><th>æ¸¬è©¦å“¡</th><th>çµ„è£å“¡</th><th>çµ„è£æ—¥æœŸ</th></>}
          <th>å‚™è¨»</th><th>ç‹€æ…‹</th>
        </tr></thead><tbody>
          {cur.items.map((it,i)=><tr key={i} className={it.hasError?"import-error-row":""}>
            <td>{it.row}</td><td><code>{it.code}</code></td><td>{it.product_name||it.name}</td>
            <td style={{fontWeight:700}}>{it.qty}</td>
            {isAsm?<><td>{it.assemblerCodes?.map(c=>staffMapping[c]||c).join(", ")}</td><td>{it.warehouse_date||"-"}</td></>
              :<><td>{it.customerName}</td><td>{staffMapping[it.testerCode]||it.testerCode||"-"}</td><td>{staffMapping[it.assemblerCode]||it.assemblerCode||"-"}</td><td>{it.assembly_date||"-"}</td></>}
            <td style={{maxWidth:120,overflow:"hidden",textOverflow:"ellipsis"}}>{it.note||""}</td>
            <td>{it.errors.length?<span style={{color:"var(--danger)",fontSize:11}}>{it.errors.join("; ")}</span>:"âœ“"}</td>
          </tr>)}
        </tbody></table>
      </div>
      {/* Action bar */}
      <div style={{display:"flex",gap:8,justifyContent:"flex-end",marginTop:14}}>
        <button className="btn btn-secondary" onClick={()=>{setStep(1);setSheets([]);}}>é‡é¸æª”æ¡ˆ</button>
        <button className="btn btn-primary" onClick={doImport} disabled={importing||totalItems===totalErrors}>
          {importing?"åŒ¯å…¥ä¸­...":hasUnmappedStaff||hasUnmappedCust?`ç¢ºèªåŒ¯å…¥ (${totalItems-totalErrors} ç­†ï¼Œéƒ¨åˆ†æœªå°æ‡‰)`:`ç¢ºèªåŒ¯å…¥ (${totalItems-totalErrors} ç­†)`}
        </button>
      </div>
    </div>}

    {step===3&&result&&<div style={{textAlign:"center",padding:"24px 0"}}>
      <div style={{fontSize:48,marginBottom:12}}>{result.failed===0?"âœ…":"âš ï¸"}</div>
      <div style={{fontSize:16,fontWeight:600,marginBottom:8}}>åŒ¯å…¥å®Œæˆ</div>
      <div className="import-stats" style={{justifyContent:"center"}}>
        <span>æˆåŠŸ: <strong style={{color:"var(--success)"}}>{result.success}</strong> ç­†</span>
        {result.failed>0&&<span>å¤±æ•—/è·³é: <strong style={{color:"var(--danger)"}}>{result.failed}</strong> ç­†</span>}
      </div>
      <button className="btn btn-primary" style={{marginTop:16}} onClick={onClose}>é—œé–‰</button>
    </div>}
  </div></div>;
}

// Shared: load assembly/packaging/conversion items for a product within a date range
async function loadDetailItems(productCode,dateFrom,dateTo,productId){
  const df1=dateFrom?`&assembly_orders.order_date=gte.${dateFrom}`:"";
  const df2=dateTo?`&assembly_orders.order_date=lte.${dateTo}`:"";
  const df3=dateFrom?`&packaging_orders.order_date=gte.${dateFrom}`:"";
  const df4=dateTo?`&packaging_orders.order_date=lte.${dateTo}`:"";
  const dfCnv1=dateFrom?`&conversion_date=gte.${dateFrom}`:"";
  const dfCnv2=dateTo?`&conversion_date=lte.${dateTo}`:"";
  const cnvSelect=`select=*,from_product:products!from_product_id(product_id,product_name),to_product:products!to_product_id(product_id,product_name)`;
  const fetches=[
    supaFetch("assembly_items",{query:`select=*,assembly_orders!inner(order_no,order_date),products!inner(product_id,product_name)&products.product_id=eq.${encodeURIComponent(productCode)}${df1}${df2}&order=created_at.desc`}),
    supaFetch("packaging_items",{query:`select=*,packaging_orders!inner(order_no,order_date),products!inner(product_id,product_name),customers(name)&products.product_id=eq.${encodeURIComponent(productCode)}${df3}${df4}&order=created_at.desc`})
  ];
  if(productId){
    fetches.push(
      supaFetch("conversion_orders",{query:`${cnvSelect}&from_product_id=eq.${productId}${dfCnv1}${dfCnv2}&order=conversion_date.desc`}),
      supaFetch("conversion_orders",{query:`${cnvSelect}&to_product_id=eq.${productId}${dfCnv1}${dfCnv2}&order=conversion_date.desc`})
    );
  }
  const results=await Promise.all(fetches);
  const asmItems=results[0],pkgItems=results[1];
  let cnv=[];
  if(productId){
    const seen=new Set();
    [...(results[2]||[]),...(results[3]||[])].forEach(c=>{if(!seen.has(c.id)){seen.add(c.id);cnv.push(c);}});
  }
  return{asm:asmItems||[],pkg:pkgItems||[],cnv};
}

// é€å–®ç´¯è¨ˆé…å°ï¼šåˆä½µçµ„è£/åŒ…è£ï¼ŒæŒ‰æ—¥æœŸ ASC æ’åºï¼Œç”¨æœ€çµ‚ç¸½æ•¸å›åˆ¤æ¯ç­†é…å°ç‹€æ…‹
function computeMatchStatus(asmItems,pkgItems){
  const merged=[];
  (asmItems||[]).forEach(a=>merged.push({...a,_type:"asm",_date:a.assembly_orders?.order_date||"",_qty:a.qty||0}));
  (pkgItems||[]).forEach(p=>merged.push({...p,_type:"pkg",_date:p.packaging_orders?.order_date||"",_qty:p.qty||0}));
  merged.sort((a,b)=>{if(a._date<b._date)return -1;if(a._date>b._date)return 1;if(a._type==="asm"&&b._type==="pkg")return -1;if(a._type==="pkg"&&b._type==="asm")return 1;return 0;});
  // å…ˆç®—æœ€çµ‚ç¸½æ•¸
  const asmTotal=(asmItems||[]).reduce((s,a)=>s+(a.qty||0),0);
  const pkgTotal=(pkgItems||[]).reduce((s,p)=>s+(p.qty||0),0);
  // é€ç­†ç´¯è¨ˆï¼Œç”¨æœ€çµ‚ç¸½æ•¸å›åˆ¤
  let asmRunning=0,pkgRunning=0;
  const statusMap={};
  merged.forEach(r=>{
    if(r._type==="asm")asmRunning+=r._qty; else pkgRunning+=r._qty;
    if(r._type==="asm"){
      if(pkgTotal>=asmRunning){statusMap[r.id]={label:"âœ… å·²é…å°",color:"#2e7d32",asmRunning,pkgRunning};}
      else{const n=asmRunning-pkgTotal;statusMap[r.id]={label:`ğŸ”¸ å¾…åŒ…è£ <span class="match-num">${n}</span>`,color:"#e65100",asmRunning,pkgRunning};}
    }else{
      if(asmTotal>=pkgRunning){statusMap[r.id]={label:"âœ… å·²é…å°",color:"#2e7d32",asmRunning,pkgRunning};}
      else{const n=pkgRunning-asmTotal;statusMap[r.id]={label:`âš ï¸ è¶…å‡º <span class="match-num">${n}</span>`,color:"#c62828",asmRunning,pkgRunning};}
    }
  });
  return statusMap;
}

// Shared: expand detail rows for asm/pkg items with clickable order numbers
// Optional props: checkedIds, confirmedIds, onCheck â€” ç”¨æ–¼æœ‰å·®ç•°è¡Œçš„é€ç­†å‹¾é¸ç¢ºèª
function ExpandDetailSection({expandData,onOrderClick,onEditClick,onDeleteClick,checkedIds,confirmedIds,onCheck,onUnlockItem}){
  const matchStatus=useMemo(()=>computeMatchStatus(expandData.asm,expandData.pkg),[expandData.asm,expandData.pkg]);
  const showCheck=!!onCheck;
  return <div className="expand-content">
    <div className="expand-section"><div className="expand-title">ğŸ”§ çµ„è£å–®è¨˜éŒ„ ({expandData.asm.length}ç­†)</div>{expandData.asm.length>0?<table className="expand-table"><thead><tr>{showCheck&&<th style={{width:30}}></th>}<th>å–®è™Ÿ</th><th>çµ„è£æ—¥æœŸ</th><th style={{textAlign:"right"}}>æ•¸é‡</th><th>çµ„è£äººå“¡</th><th>å…¥åº«æ—¥æœŸ</th><th>é…å°ç‹€æ…‹</th><th>å‚™è¨»</th>{(onEditClick||onDeleteClick)&&<th style={{width:90}}>æ“ä½œ</th>}</tr></thead><tbody>{expandData.asm.map(a=>{const ms=matchStatus[a.id];const isOk=ms?.color==="#2e7d32";const msCls=isOk?"match-status-ok":ms?.color==="#e65100"?"match-status-pending":"match-status-over";const alreadyConfirmed=confirmedIds&&confirmedIds.has(a.id);return <tr key={a.id} style={alreadyConfirmed?{opacity:.5}:{}}>{showCheck&&<td style={{textAlign:"center"}}>{isOk&&!alreadyConfirmed?<input type="checkbox" style={{width:15,height:15,cursor:"pointer"}} checked={checkedIds?.has(a.id)||false} onChange={()=>onCheck(a.id)}/>:alreadyConfirmed?<span title="é»æ“Šè§£é–" style={{color:"var(--success)",fontSize:14,cursor:onUnlockItem?"pointer":"default"}} onClick={()=>onUnlockItem&&onUnlockItem(a.id)}>ğŸ”’</span>:null}</td>}<td><code style={{fontWeight:600,color:"var(--accent)",cursor:"pointer",textDecoration:"underline"}} onClick={e=>{e.stopPropagation();onOrderClick(a.assembly_orders?.order_no,"assembly");}}>{a.assembly_orders?.order_no}</code></td><td>{a.assembly_orders?.order_date}</td><td className="qty-cell">{a.qty}</td><td>{a.assembler||"-"}</td><td>{a.warehouse_date||"-"}</td><td className={msCls} dangerouslySetInnerHTML={{__html:ms?.label||"-"}}/><td>{a.note||"-"}</td>{(onEditClick||onDeleteClick)&&<td>{onEditClick&&<button className="btn-edit" onClick={e=>{e.stopPropagation();onEditClick("assembly_items",a);}}>ä¿®æ”¹</button>}{onDeleteClick&&!alreadyConfirmed&&<button className="btn-edit" style={{borderColor:"var(--danger)",color:"var(--danger)",marginLeft:4}} onClick={e=>{e.stopPropagation();onDeleteClick("assembly_items",a);}}>åˆªé™¤</button>}</td>}</tr>;})}</tbody></table>:<div style={{color:"var(--muted)",fontSize:12,padding:8}}>ç„¡çµ„è£è¨˜éŒ„</div>}</div>
    <div className="expand-section"><div className="expand-title">ğŸ“¦ åŒ…è£å‡ºè²¨å…¥åº«è¨˜éŒ„ ({expandData.pkg.length}ç­†)</div>{expandData.pkg.length>0?<table className="expand-table"><thead><tr>{showCheck&&<th style={{width:30}}></th>}<th>å–®è™Ÿ</th><th>åŒ…è£æ—¥æœŸ</th><th style={{textAlign:"right"}}>æ•¸é‡</th><th>å®¢æˆ¶</th><th>æ¸¬è©¦äººå“¡</th><th>çµ„è£äººå“¡</th><th>çµ„è£æ—¥æœŸ</th><th>é…å°ç‹€æ…‹</th><th>å‚™è¨»</th>{(onEditClick||onDeleteClick)&&<th style={{width:90}}>æ“ä½œ</th>}</tr></thead><tbody>{expandData.pkg.map(p=>{const ms=matchStatus[p.id];const isOk=ms?.color==="#2e7d32";const msCls=isOk?"match-status-ok":ms?.color==="#c62828"?"match-status-over":"match-status-pending";const alreadyConfirmed=confirmedIds&&confirmedIds.has(p.id);return <tr key={p.id} style={alreadyConfirmed?{opacity:.5}:{}}>{showCheck&&<td style={{textAlign:"center"}}>{isOk&&!alreadyConfirmed?<input type="checkbox" style={{width:15,height:15,cursor:"pointer"}} checked={checkedIds?.has(p.id)||false} onChange={()=>onCheck(p.id)}/>:alreadyConfirmed?<span title="é»æ“Šè§£é–" style={{color:"var(--success)",fontSize:14,cursor:onUnlockItem?"pointer":"default"}} onClick={()=>onUnlockItem&&onUnlockItem(p.id)}>ğŸ”’</span>:null}</td>}<td><code style={{fontWeight:600,color:"var(--accent)",cursor:"pointer",textDecoration:"underline"}} onClick={e=>{e.stopPropagation();onOrderClick(p.packaging_orders?.order_no,"packaging");}}>{p.packaging_orders?.order_no}</code></td><td>{p.packaging_orders?.order_date}</td><td className="qty-cell">{p.qty}</td><td>{p.is_stock?"åº«å­˜":p.customers?.name||"-"}</td><td>{p.tester||"-"}</td><td>{p.assembler||"-"}</td><td>{p.assembly_date||"-"}</td><td className={msCls} dangerouslySetInnerHTML={{__html:ms?.label||"-"}}/><td>{p.note||"-"}</td>{(onEditClick||onDeleteClick)&&<td>{onEditClick&&<button className="btn-edit" onClick={e=>{e.stopPropagation();onEditClick("packaging_items",p);}}>ä¿®æ”¹</button>}{onDeleteClick&&!alreadyConfirmed&&<button className="btn-edit" style={{borderColor:"var(--danger)",color:"var(--danger)",marginLeft:4}} onClick={e=>{e.stopPropagation();onDeleteClick("packaging_items",p);}}>åˆªé™¤</button>}</td>}</tr>;})}</tbody></table>:<div style={{color:"var(--muted)",fontSize:12,padding:8}}>ç„¡åŒ…è£è¨˜éŒ„</div>}</div>
  </div>;
}

function OrderDetailModal({show,orderNo,orderType,onClose}){
  const[loading,setLoading]=useState(false);const[order,setOrder]=useState(null);const[items,setItems]=useState([]);
  useEffect(()=>{if(!show||!orderNo)return;setLoading(true);setOrder(null);setItems([]);
    (async()=>{try{
      if(orderType==="assembly"){
        const orders=await supaFetch("assembly_orders",{query:`select=*&order_no=eq.${encodeURIComponent(orderNo)}`});
        if(orders&&orders.length>0){setOrder(orders[0]);const its=await supaFetch("assembly_items",{query:`select=*,products(product_id,product_name)&order_id=eq.${orders[0].id}&order=created_at`});setItems(its||[]);}
      }else{
        const orders=await supaFetch("packaging_orders",{query:`select=*,customers(name,customer_code)&order_no=eq.${encodeURIComponent(orderNo)}`});
        if(orders&&orders.length>0){setOrder(orders[0]);const its=await supaFetch("packaging_items",{query:`select=*,products(product_id,product_name),customers(name)&order_id=eq.${orders[0].id}&order=created_at`});setItems(its||[]);}
      }
    }catch(e){console.error(e);}finally{setLoading(false);}})();
  },[show,orderNo,orderType]);
  if(!show)return null;
  const isAsm=orderType==="assembly";
  const totalQty=items.reduce((s,it)=>s+(it.qty||0),0);
  return <div className="modal-overlay" onClick={onClose}><div className="modal modal-wide" onClick={e=>e.stopPropagation()}>
    <div className="modal-title">{isAsm?"ğŸ”§ çµ„è£å–®":"ğŸ“¦ åŒ…è£å‡ºè²¨å–®"} â€” {orderNo}</div>
    {loading?<div className="spinner"/>:!order?<div style={{color:"var(--muted)",padding:20,textAlign:"center"}}>æ‰¾ä¸åˆ°å–®è™Ÿ {orderNo}</div>:<>
      <div style={{background:"#f8f7f4",borderRadius:6,padding:10,marginBottom:14,fontSize:12,display:"flex",gap:20}}>
        <div><strong>å–®è™Ÿï¼š</strong>{order.order_no}</div>
        <div><strong>æ—¥æœŸï¼š</strong>{order.order_date}</div>
        <div><strong>ç‹€æ…‹ï¼š</strong>{order.status==="approved"?"å·²æ ¸å‡†":"è‰ç¨¿"}</div>
        {!isAsm&&order.customers&&<div><strong>å®¢æˆ¶ï¼š</strong>{order.customers.customer_code?order.customers.customer_code+" - ":""}{order.customers.name}</div>}
        <div><strong>åˆè¨ˆï¼š</strong><span style={{fontWeight:700}}>{totalQty}</span></div>
      </div>
      {items.length===0?<div style={{color:"var(--muted)",padding:20,textAlign:"center"}}>ç„¡æ˜ç´°é …ç›®</div>:
      <div className="table-wrap" style={{maxHeight:400,overflow:"auto"}}><table>
        <thead><tr><th>#</th><th>ç”¢å“ç·¨è™Ÿ</th><th>ç”¢å“åç¨±</th><th style={{textAlign:"right"}}>æ•¸é‡</th>
          {isAsm?<><th>çµ„è£äººå“¡</th><th>å…¥åº«æ—¥æœŸ</th></>:<><th>å®¢æˆ¶</th><th>æ¸¬è©¦äººå“¡</th><th>çµ„è£äººå“¡</th><th>çµ„è£æ—¥æœŸ</th></>}
          <th>å‚™è¨»</th></tr></thead>
        <tbody>{items.map((it,i)=><tr key={it.id}>
          <td style={{color:"var(--muted)"}}>{i+1}</td>
          <td><code style={{fontWeight:600}}>{it.products?.product_id||"-"}</code></td>
          <td>{it.products?.product_name||"-"}</td>
          <td style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,textAlign:"right"}}>{it.qty}</td>
          {isAsm?<><td>{it.assembler||"-"}</td><td>{it.warehouse_date||"-"}</td></>:<><td>{it.is_stock?"åº«å­˜":it.customers?.name||"-"}</td><td>{it.tester||"-"}</td><td>{it.assembler||"-"}</td><td>{it.assembly_date||"-"}</td></>}
          <td>{it.note||"-"}</td>
        </tr>)}</tbody>
      </table></div>}
    </>}
    <div style={{display:"flex",justifyContent:"flex-end",marginTop:16}}><button className="btn btn-secondary" onClick={onClose}>é—œé–‰</button></div>
  </div></div>;
}

function ProductSearch({products,value,onChange,style}){
  const[search,setSearch]=useState("");const[open,setOpen]=useState(false);const ref=useRef(null);
  const selected=products.find(p=>p.id===value);
  useEffect(()=>{const h=e=>{if(ref.current&&!ref.current.contains(e.target))setOpen(false);};document.addEventListener("mousedown",h);return()=>document.removeEventListener("mousedown",h);},[]);
  const filtered=products.filter(p=>{if(!search)return true;const s=search.toLowerCase();return p.product_id.toLowerCase().includes(s)||p.product_name.toLowerCase().includes(s);}).slice(0,50);
  return <div className="search-select" ref={ref} style={style}><input className="input" style={{width:"100%"}} placeholder={selected?`${selected.product_id} - ${selected.product_name}`:"ğŸ” æœå°‹ç”¢å“..."} value={open?search:""} onFocus={()=>{setOpen(true);setSearch("");}} onChange={e=>{setSearch(e.target.value);setOpen(true);}}/>{open&&<div className="search-dropdown">{filtered.length===0&&<div style={{padding:10,color:"var(--muted)",textAlign:"center"}}>ç„¡ç¬¦åˆç”¢å“</div>}{filtered.map(p=><div key={p.id} className="search-dropdown-item" onClick={()=>{onChange(p.id);setOpen(false);setSearch("");}}><code>{p.product_id}</code>{p.product_name}</div>)}</div>}</div>;
}

function SupplementForm({supplementing,suppForm,setSuppForm,customers,staff,onSubmit,onCancel,onAddStaff}){
  if(!supplementing)return null;
  return <div className="supplement-box" style={{margin:"8px 16px 12px"}}>
    <div className="supplement-title">{supplementing.type==="asm"?"ğŸ”§ è£œå»ºçµ„è£å–®":"ğŸ“¦ è£œå»ºåŒ…è£å‡ºè²¨å–®"} â€” {supplementing.product_code} {supplementing.product_name}</div>
    <div className="form-row">
      <span className="filter-label">æ•¸é‡ï¼š</span>
      <input type="number" className="input" style={{width:80}} min="1" value={suppForm.qty} onChange={e=>setSuppForm({...suppForm,qty:e.target.value})}/>
      {supplementing.type==="asm"&&<>
        <span className="filter-label">çµ„è£äººå“¡ï¼š</span>
        <StaffSelect staff={staff} value={suppForm.assembler} onChange={v=>setSuppForm({...suppForm,assembler:v})} onAdd={()=>onAddStaff("assembler")} roleFilter="assembler" multi style={{width:180}}/>
        <span className="filter-label">çµ„è£æ—¥æœŸï¼š</span>
        <input type="date" className="input" style={{width:140}} value={suppForm.order_date||""} onChange={e=>setSuppForm({...suppForm,order_date:e.target.value})}/>
        <span className="filter-label">å…¥åº«æ—¥æœŸï¼š</span>
        <input type="date" className="input" style={{width:140}} value={suppForm.assembly_date} onChange={e=>setSuppForm({...suppForm,assembly_date:e.target.value})}/>
      </>}
      {supplementing.type==="pkg"&&<>
        <span className="filter-label">å®¢æˆ¶ï¼š</span>
        <select className="input" style={{width:110}} value={suppForm.customer_id} onChange={e=>setSuppForm({...suppForm,customer_id:e.target.value})}>
          <option value="">åº«å­˜</option>{customers.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
        </select>
        <span className="filter-label">æ¸¬è©¦äººå“¡ï¼š</span>
        <StaffSelect staff={staff} value={suppForm.tester} onChange={v=>setSuppForm({...suppForm,tester:v})} onAdd={()=>onAddStaff("tester")} roleFilter="tester" multi style={{width:160}}/>
        <span className="filter-label">çµ„è£äººå“¡ï¼š</span>
        <StaffSelect staff={staff} value={suppForm.pkgAssembler} onChange={v=>setSuppForm({...suppForm,pkgAssembler:v})} onAdd={()=>onAddStaff("assembler")} roleFilter="assembler" multi style={{width:160}}/>
        <span className="filter-label">çµ„è£æ—¥æœŸï¼š</span>
        <input type="date" className="input" style={{width:140}} value={suppForm.pkgAsmDate||""} onChange={e=>setSuppForm({...suppForm,pkgAsmDate:e.target.value})}/>
        <span className="filter-label">åŒ…è£æ—¥æœŸï¼š</span>
        <input type="date" className="input" style={{width:140}} value={suppForm.pkgOrderDate||""} onChange={e=>setSuppForm({...suppForm,pkgOrderDate:e.target.value})}/>
      </>}
    </div>
    <div className="form-row" style={{marginTop:6}}>
      <span className="filter-label">å‚™è¨»ï¼š</span>
      <input className="input" style={{flex:1}} value={suppForm.note} onChange={e=>setSuppForm({...suppForm,note:e.target.value})} placeholder="è£œå–®åŸå› "/>
      <button className="btn btn-primary" onClick={onSubmit}>ç¢ºèªè£œå–®</button>
      <button className="btn btn-secondary" onClick={onCancel}>å–æ¶ˆ</button>
    </div>
  </div>;
}

function ReconciliationTab({products,customers,staff,toast,reloadStaff}){
  const[data,setData]=useState([]);const[loading,setLoading]=useState(true);
  const[orderModal,setOrderModal]=useState({show:false,orderNo:null,orderType:null});
  const today=new Date().toISOString().slice(0,10);const d10=new Date(Date.now()-10*86400000).toISOString().slice(0,10);const d5=new Date(Date.now()+5*86400000).toISOString().slice(0,10);
  const[dateFrom,setDateFrom]=useState(d10);const[dateTo,setDateTo]=useState(d5);
  const[filter,setFilter]=useState("all");const[sortCol,setSortCol]=useState("status");const[sortDir,setSortDir]=useState("asc");
  const[colSearch,setColSearch]=useState({keyword:"",status_desc:""});
  const[expandedRow,setExpandedRow]=useState(null);const[expandData,setExpandData]=useState({asm:[],pkg:[],cnv:[]});
  const[showHidden,setShowHidden]=useState(false);const[showMatched,setShowMatched]=useState(false);
  const[supplementing,setSupplementing]=useState(null);
  const[suppForm,setSuppForm]=useState({qty:1,assembler:"",tester:"",pkgAssembler:"",customer_id:"",assembly_date:"",pkgAsmDate:"",pkgOrderDate:"",note:""});
  const[staffModal,setStaffModal]=useState({show:false,role:"general"});
  const[editModal,setEditModal]=useState({show:false,item:null,tableName:"",type:""});
  const[checkedIds,setCheckedIds]=useState(new Set());
  const[confirmedIds,setConfirmedIds]=useState(new Set());
  const[itemToRecordMap,setItemToRecordMap]=useState({});
  const[page,setPage]=useState(1);const[pageSize,setPageSize]=useState(50);

  // å‰ç«¯æ‰£é™¤å·²ç¢ºèªæ•¸é‡ + ç”¢ç”Ÿç¢ºèªè¡Œ
  const adjustWithConfirmed=(rows,confRows)=>{
    // 1. å½™ç¸½æ¯å€‹ç”¢å“çš„ç¢ºèªé‡
    const cm={};
    (confRows||[]).forEach(c=>{
      const pid=c.product_id;
      if(!cm[pid])cm[pid]={asm:0,pkg:0,at:null,by:null};
      cm[pid].asm+=(c.assembly_qty||0);
      cm[pid].pkg+=(c.packaging_qty||0);
      if(!cm[pid].at||c.confirmed_at>cm[pid].at){cm[pid].at=c.confirmed_at;cm[pid].by=c.confirmed_by;}
    });
    // 2. èª¿æ•´åŸç”¢å“è¡Œ
    const adjusted=rows.map(r=>{
      const cf=cm[r.product_id];
      if(!cf)return r;
      const rawAsm=(r.assembly_qty||0)+(r.confirmed_asm_qty||0);
      const rawPkg=(r.packaging_qty||0)+(r.confirmed_pkg_qty||0);
      const adjAsm=Math.max(rawAsm-cf.asm,0);
      const adjPkg=Math.max(rawPkg-cf.pkg,0);
      const adjDiff=adjAsm-adjPkg;
      let status,status_desc;
      if(adjAsm===0&&adjPkg===0){status="fully_confirmed";status_desc="å®Œå…¨ç¢ºèª";}
      else if(adjAsm===adjPkg){status="matched";status_desc="æ ¸å°ä¸€è‡´";}
      else if(adjAsm===0){status="missing_asm";status_desc="æœ‰åŒ…è£ç„¡çµ„è£";}
      else if(adjPkg===0){status="missing_pkg";status_desc="æœ‰çµ„è£ç„¡åŒ…è£";}
      else if(adjAsm>adjPkg&&adjPkg>0){status="wip_normal";status_desc="åœ¨è£½å“(æ­£å¸¸)";}
      else if(adjPkg>adjAsm){status="over_packaged";status_desc="åŒ…è£è¶…å‡ºçµ„è£";}
      else{status="qty_mismatch";status_desc="æ•¸é‡å·®ç•°";}
      return{...r,assembly_qty:adjAsm,packaging_qty:adjPkg,diff:adjDiff,
        confirmed_asm_qty:cf.asm,confirmed_pkg_qty:cf.pkg,confirmed_at:cf.at,confirmed_by:cf.by,
        status,status_desc};
    }).filter(r=>r.status!=="fully_confirmed");
    // 3. ç”¢ç”Ÿç¢ºèªè¡Œï¼ˆæ¯ç­† reconciliation_confirmed è¨˜éŒ„ â†’ ä¸€è¡Œæ ¸å°ä¸€è‡´ï¼‰
    const confirmedEntries=(confRows||[]).filter(c=>(c.assembly_qty||0)>0||(c.packaging_qty||0)>0).map(c=>{
      const src=rows.find(r=>r.product_id===c.product_id)||{};
      return{
        product_id:c.product_id,product_code:src.product_code||"?",product_name:src.product_name||"?",
        order_date:src.order_date,first_asm_date:src.first_asm_date,first_pkg_date:src.first_pkg_date,
        assembly_qty:c.assembly_qty||0,packaging_qty:c.packaging_qty||0,diff:0,
        status:"matched",status_desc:"æ ¸å°ä¸€è‡´",
        is_confirmed_entry:true,confirmed_record_id:c.id,
        confirmed_item_ids:c.confirmed_item_ids||[],
        confirmed_at:c.confirmed_at,confirmed_by:c.confirmed_by,
        confirmed_asm_qty:0,confirmed_pkg_qty:0,
        date_from:c.date_from,date_to:c.date_to,
        resolved_at:null,resolved_by:null,hidden:false
      };
    });
    return[...adjusted,...confirmedEntries];
  };

  const load=useCallback(async()=>{setLoading(true);try{const df=dateFrom||"2020-01-01";const dt=dateTo||new Date().toISOString().slice(0,10);try{
    const[rpcData,confData]=await Promise.all([
      supaRpc("fn_reconcile_by_date_range",{p_date_from:df,p_date_to:dt}),
      supaFetch("reconciliation_confirmed",{query:`select=id,product_id,assembly_qty,packaging_qty,confirmed_at,confirmed_by,confirmed_item_ids,date_from,date_to&date_from=lte.${dt}&date_to=gte.${df}`})
    ]);
    console.log('RPC result count:', (rpcData||[]).length);
    if(rpcData&&rpcData[0])console.log('RPC sample keys:', Object.keys(rpcData[0]), 'sample:', JSON.stringify(rpcData[0]).slice(0,300));
    setData(adjustWithConfirmed(rpcData||[],confData||[]));
  }catch(rpcErr){console.error("RPC failed, fallback to view:",rpcErr);toast("âš  å€é–“ç´¯è¨ˆå‡½æ•¸åŸ·è¡Œå¤±æ•—ï¼Œå·²åˆ‡æ›ç‚ºèˆŠç‰ˆé€æ—¥æ¯”å°æ¨¡å¼","warning");let query=`select=*&order_date=gte.${df}&order_date=lte.${dt}`;setData(await supaFetch("v_reconciliation",{query})||[]);}}catch(e){console.error(e);}setLoading(false);},[dateFrom,dateTo]);
  useEffect(()=>{load();},[load]);

  const searchByDate=async()=>{const df=dateFrom||"2020-01-01";const dt=dateTo||new Date().toISOString().slice(0,10);setLoading(true);try{setData(await supaRpc("fn_reconcile_by_date_range",{p_date_from:df,p_date_to:dt})||[]);}catch(e){console.error(e);load();}setLoading(false);};

  const loadConfirmedIds=async(productId)=>{
    try{
      const rows=await supaFetch("reconciliation_confirmed",{query:`select=id,confirmed_item_ids&product_id=eq.${productId}`});
      const ids=new Set();
      const map={};
      (rows||[]).forEach(r=>{
        (r.confirmed_item_ids||[]).forEach(itemId=>{
          ids.add(itemId);
          map[itemId]=r.id;
        });
      });
      setConfirmedIds(ids);
      setItemToRecordMap(map);
    }catch(e){console.error("loadConfirmedIds error:",e);setConfirmedIds(new Set());setItemToRecordMap({});}
  };

  const loadDetail=async(row)=>{
    const rowKey=row.is_confirmed_entry?(row.product_code+"_conf_"+row.confirmed_record_id):(row.product_code+"_"+(row.order_date||"all"));
    if(expandedRow===rowKey){setExpandedRow(null);return;}
    setExpandedRow(rowKey);setSupplementing(null);setCheckedIds(new Set());
    try{
      const detail=await loadDetailItems(row.product_code,dateFrom,dateTo,row.product_id);
      // ç¢ºèªè¡Œï¼šåªé¡¯ç¤ºè¢«ç¢ºèªçš„é‚£äº›å–®æ“š
      if(row.is_confirmed_entry&&row.confirmed_item_ids&&row.confirmed_item_ids.length>0){
        const ids=new Set(row.confirmed_item_ids);
        setExpandData({asm:(detail.asm||[]).filter(a=>ids.has(a.id)),pkg:(detail.pkg||[]).filter(p=>ids.has(p.id)),cnv:detail.cnv||[]});
      }else{
        setExpandData(detail);
        // è¼‰å…¥ confirmedIdsï¼ˆç”¨æ–¼å‹¾é¸ç¢ºèª + ğŸ”’ é¡¯ç¤ºï¼‰
        if(!row.is_confirmed_entry){await loadConfirmedIds(row.product_id);}
      }
    }catch(e){console.error(e);setExpandData({asm:[],pkg:[],cnv:[]});}
  };

  const handleCheck=(id)=>{setCheckedIds(prev=>{const next=new Set(prev);if(next.has(id))next.delete(id);else next.add(id);return next;});};

  const handleUnlockItem=async(itemId)=>{
    const recordId=itemToRecordMap[itemId];
    if(!recordId){toast("æ‰¾ä¸åˆ°å°æ‡‰çš„ç¢ºèªè¨˜éŒ„","error");return;}
    if(!confirm("ç¢ºå®šè¦è§£é–é€™ç­†å–®æ“šå—ï¼Ÿ"))return;
    try{
      await supaDelete("reconciliation_confirmed",`id=eq.${recordId}`);
      toast("å·²è§£é–","success");
      reloadAndReexpand();
    }catch(e){toast("è§£é–å¤±æ•—: "+e.message,"error");}
  };

  const handleConfirmBatch=async(row)=>{
    if(checkedIds.size===0)return;
    const asmChecked=(expandData.asm||[]).filter(a=>checkedIds.has(a.id));
    const pkgChecked=(expandData.pkg||[]).filter(p=>checkedIds.has(p.id));
    const asmQty=asmChecked.reduce((s,a)=>s+(a.qty||0),0);
    const pkgQty=pkgChecked.reduce((s,p)=>s+(p.qty||0),0);
    if(asmQty===0&&pkgQty===0){toast("è«‹è‡³å°‘å‹¾é¸ä¸€ç­†å·²é…å°çš„å–®æ“š","warning");return;}
    const df=dateFrom||"2020-01-01";const dt=dateTo||new Date().toISOString().slice(0,10);
    const firstItem=asmChecked[0]||pkgChecked[0];
    const productId=firstItem?.product_id;
    if(!productId){toast("æ‰¾ä¸åˆ°ç”¢å“ ID","error");return;}
    const itemIds=[...checkedIds];
    try{
      await supaFetch("reconciliation_confirmed",{method:"POST",body:{product_id:productId,date_from:df,date_to:dt,assembly_qty:asmQty,packaging_qty:pkgQty,confirmed_item_ids:itemIds,confirmed_by:"ç³»çµ±ä½¿ç”¨è€…"}});
      toast(`å·²ç¢ºèª ${asmChecked.length+pkgChecked.length} ç­†ï¼ˆçµ„è£ ${asmQty} + åŒ…è£ ${pkgQty}ï¼‰`,"success");
      setCheckedIds(new Set());
      reloadAndReexpand();
    }catch(e){toast("ç¢ºèªå¤±æ•—: "+e.message,"error");}
  };

  const updateLocal=(productId,updates)=>{setData(prev=>prev.map(r=>r.product_id===productId?{...r,...updates}:r));};
  const markResolved=async(productId)=>{updateLocal(productId,{resolved_at:new Date().toISOString(),resolved_by:"ç³»çµ±ä½¿ç”¨è€…",hidden:false});try{await supaFetch("reconciliation_resolved",{method:"POST",body:{product_id:productId,resolved_by:"ç³»çµ±ä½¿ç”¨è€…",note:"å·²è™•ç†",hidden:false}});}catch(e){toast("æ¨™è¨˜å¤±æ•—: "+e.message,"error");updateLocal(productId,{resolved_at:null,resolved_by:null,hidden:false});}};
  const unmarkResolved=async(productId)=>{const prev=data.find(r=>r.product_id===productId);updateLocal(productId,{resolved_at:null,resolved_by:null,hidden:false});try{await supaDelete("reconciliation_resolved",`product_id=eq.${productId}`);}catch(e){toast("å–æ¶ˆå¤±æ•—: "+e.message,"error");if(prev)updateLocal(productId,{resolved_at:prev.resolved_at,resolved_by:prev.resolved_by,hidden:prev.hidden});}};
  const markHidden=async(productId)=>{updateLocal(productId,{hidden:true});try{await supaPatch("reconciliation_resolved",`product_id=eq.${productId}`,{hidden:true});}catch(e){toast("æ¨™è¨˜å¤±æ•—: "+e.message,"error");updateLocal(productId,{hidden:false});}};
  const unmarkHidden=async(productId)=>{updateLocal(productId,{hidden:false});try{await supaPatch("reconciliation_resolved",`product_id=eq.${productId}`,{hidden:false});}catch(e){toast("å–æ¶ˆå¤±æ•—: "+e.message,"error");updateLocal(productId,{hidden:true});}};

  // ç¢ºèªé–å®šï¼ˆtoggleï¼‰â€” é€å–®é…å°ï¼Œplain INSERT + confirmed_item_ids
  const confirmReconciliation=async(row)=>{
    const df=dateFrom||"2020-01-01";const dt=dateTo||new Date().toISOString().slice(0,10);
    // å¦‚æœå±•é–‹å€æ²’æœ‰è³‡æ–™ï¼Œå…ˆè¼‰å…¥æ˜ç´°
    let detail=expandData;
    let cIds=confirmedIds;
    if(!detail.asm||detail.asm.length===0){
      detail=await loadDetailItems(row.product_code,dateFrom,dateTo,row.product_id);
      // è¼‰å…¥å·²ç¢ºèª IDs
      try{
        const confRows=await supaFetch("reconciliation_confirmed",{query:`select=id,confirmed_item_ids&product_id=eq.${row.product_id}`});
        cIds=new Set();
        (confRows||[]).forEach(r=>{(r.confirmed_item_ids||[]).forEach(id=>cIds.add(id));});
      }catch(e){cIds=new Set();}
    }
    // æ”¶é›†æ‰€æœ‰æœªç¢ºèªçš„ item IDs
    const allIds=[];
    (detail.asm||[]).forEach(a=>{if(!cIds.has(a.id))allIds.push(a.id);});
    (detail.pkg||[]).forEach(p=>{if(!cIds.has(p.id))allIds.push(p.id);});
    if(allIds.length===0){toast("æ²’æœ‰å¯ç¢ºèªçš„å–®æ“š","warning");return;}
    const asmItems=(detail.asm||[]).filter(a=>!cIds.has(a.id));
    const pkgItems=(detail.pkg||[]).filter(p=>!cIds.has(p.id));
    const asmQty=asmItems.reduce((s,a)=>s+(a.qty||0),0);
    const pkgQty=pkgItems.reduce((s,p)=>s+(p.qty||0),0);
    try{
      await supaFetch("reconciliation_confirmed",{method:"POST",body:{product_id:row.product_id,date_from:df,date_to:dt,assembly_qty:asmQty,packaging_qty:pkgQty,confirmed_item_ids:allIds,confirmed_by:"ç³»çµ±ä½¿ç”¨è€…"}});
      toast(`${row.product_code} å·²ç¢ºèªé–å®š (${allIds.length} ç­†)`,"success");
      reloadAndReexpand();
    }catch(e){toast("ç¢ºèªå¤±æ•—: "+e.message,"error");}
  };
  const unconfirmReconciliation=async(row)=>{
    if(!confirm(`ç¢ºå®šè¦å–æ¶ˆã€Œ${row.product_code}ã€çš„ç¢ºèªé–å®šå—ï¼Ÿ`))return;
    try{
      if(row.confirmed_record_id){
        await supaDelete("reconciliation_confirmed",`id=eq.${row.confirmed_record_id}`);
      }else{
        await supaDelete("reconciliation_confirmed",`product_id=eq.${row.product_id}`);
      }
      toast(`å·²å–æ¶ˆ ${row.product_code} çš„ç¢ºèªé–å®š`,"success");
      setExpandedRow(null);
      load();
    }catch(e){toast("å–æ¶ˆç¢ºèªå¤±æ•—: "+e.message,"error");}
  };

  const reloadAndReexpand=async()=>{const pc=expandedRow?expandedRow.split("_")[0]:null;setExpandedRow(null);await load();if(pc){setTimeout(()=>{const row=data.find(r=>r.product_code===pc&&!r.is_confirmed_entry);if(row)loadDetail(row);},300);}};
  const handleEditItem=async(form)=>{const{item,tableName}=editModal;try{
    const body=tableName==="assembly_items"
      ?{product_id:form.product_id,qty:parseInt(form.qty),assembler:form.assembler||null,warehouse_date:form.warehouse_date||null,note:form.note||null}
      :{product_id:form.product_id,qty:parseInt(form.qty),customer_id:form.customer_id||null,is_stock:!form.customer_id,tester:form.tester||null,assembler:form.assembler||null,assembly_date:form.assembly_date||null,note:form.note||null};
    await supaPatch(tableName,`id=eq.${item.id}`,body);
    toast("æ˜ç´°å·²ä¿®æ”¹","success");setEditModal({show:false,item:null,tableName:"",type:""});
    reloadAndReexpand();
  }catch(e){toast("ä¿®æ”¹å¤±æ•—: "+e.message,"error");}};

  const handleDeleteItem=async(tableName,item)=>{const pid=item.product_id;const conf=await supaFetch("reconciliation_confirmed",{query:`select=id&product_id=eq.${pid}`});if(conf&&conf.length>0){toast("æ­¤ç”¢å“å·²åœ¨æ ¸å°å ±å‘Šä¸­ç¢ºèªï¼Œç„¡æ³•åˆªé™¤","error");return;}if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†æ˜ç´°ï¼Ÿæ­¤æ“ä½œä¸å¯å¾©åŸã€‚"))return;try{await supaDelete(tableName,`id=eq.${item.id}`);toast("å·²åˆªé™¤","success");reloadAndReexpand();}catch(e){toast("åˆªé™¤å¤±æ•—: "+e.message,"error");}};

  const submitSupplement=async()=>{if(!supplementing)return;const{product_id,type}=supplementing;const qty=parseInt(suppForm.qty);if(!qty||qty<=0){toast("è«‹è¼¸å…¥æ­£ç¢ºæ•¸é‡","error");return;}try{if(type==="asm"){const[order]=await supaFetch("assembly_orders",{method:"POST",body:{order_date:suppForm.order_date||new Date().toISOString().slice(0,10),status:"draft"}});await supaFetch("assembly_items",{method:"POST",body:{order_id:order.id,product_id,qty,assembler:suppForm.assembler||null,warehouse_date:suppForm.assembly_date||null,note:suppForm.note||"è£œå–®"}});toast(`çµ„è£è£œå–®æˆåŠŸï¼${order.order_no}`,"success");}else{const[order]=await supaFetch("packaging_orders",{method:"POST",body:{order_date:suppForm.pkgOrderDate||new Date().toISOString().slice(0,10),status:"draft"}});await supaFetch("packaging_items",{method:"POST",body:{order_id:order.id,product_id,qty,customer_id:suppForm.customer_id||null,is_stock:!suppForm.customer_id,tester:suppForm.tester||null,assembler:suppForm.pkgAssembler||null,assembly_date:suppForm.pkgAsmDate||null,note:suppForm.note||"è£œå–®"}});toast(`åŒ…è£è£œå–®æˆåŠŸï¼${order.order_no}`,"success");}setSupplementing(null);setSuppForm({qty:1,assembler:"",tester:"",pkgAssembler:"",customer_id:"",assembly_date:"",pkgAsmDate:"",pkgOrderDate:"",note:""});load();}catch(e){toast("è£œå–®å¤±æ•—: "+e.message,"error");}};

  const setFilterAndReset=(f)=>{setFilter(f);setPage(1);};
  const statusFilter=r=>{if(filter==="all")return true;if(filter==="matched")return r.status==="matched";if(filter==="mismatch")return r.status==="qty_mismatch";if(filter==="missing")return r.status==="missing_pkg"||r.status==="missing_asm";if(filter==="wip")return r.status==="wip_normal";if(filter==="over")return r.status==="over_packaged";return true;};
  const colFilter=r=>{if(colSearch.keyword){const q=colSearch.keyword.toLowerCase();if(!String(r.product_code||"").toLowerCase().includes(q)&&!String(r.product_name||"").toLowerCase().includes(q))return false;}if(colSearch.status_desc){if(!String(r.status_desc||"").toLowerCase().includes(colSearch.status_desc.toLowerCase()))return false;}return true;};
  const hiddenFilter=r=>{if(showHidden)return true;return !r.hidden;};
  const matchedFilter=r=>{if(showMatched)return true;if(filter==="all"||filter==="matched")return true;return r.status!=="matched";};

  const statusOrder={missing_pkg:0,missing_asm:1,over_packaged:2,qty_mismatch:3,wip_normal:4,matched:5};
  const sortFn=(a,b)=>{let va,vb;if(sortCol==="status"){va=statusOrder[a.status]??6;vb=statusOrder[b.status]??6;}else if(["assembly_qty","packaging_qty","diff"].includes(sortCol)){va=Number(a[sortCol])||0;vb=Number(b[sortCol])||0;}else if(sortCol==="order_date"){va=a.order_date||"9999";vb=b.order_date||"9999";}else{va=String(a[sortCol]||"").toLowerCase();vb=String(b[sortCol]||"").toLowerCase();}if(va<vb)return sortDir==="asc"?-1:1;if(va>vb)return sortDir==="asc"?1:-1;return 0;};
  const toggleSort=col=>{if(sortCol===col)setSortDir(d=>d==="asc"?"desc":"asc");else{setSortCol(col);setSortDir("asc");}};

  const filtered=data.filter(statusFilter).filter(colFilter).filter(hiddenFilter).filter(matchedFilter).sort(sortFn);
  const totalPages=Math.max(1,Math.ceil(filtered.length/pageSize));
  const safePage=Math.min(page,totalPages);
  const paged=filtered.slice((safePage-1)*pageSize,safePage*pageSize);
  const allVisible=data.filter(hiddenFilter);
  const errors=allVisible.filter(d=>d.status==="missing_pkg"||d.status==="missing_asm").length;
  const warnings=allVisible.filter(d=>d.status==="qty_mismatch").length;
  const matched=allVisible.filter(d=>d.status==="matched").length;
  const confirmedCount=allVisible.filter(d=>d.status==="matched"&&d.confirmed_at&&(d.assembly_qty||0)===0&&(d.packaging_qty||0)===0).length;
  const wip=allVisible.filter(d=>d.status==="wip_normal").length;
  const overPkg=allVisible.filter(d=>d.status==="over_packaged").length;
  const hiddenCount=data.filter(d=>d.hidden).length;

  const statusMap={missing_pkg:"error",missing_asm:"warning",qty_mismatch:"warning",matched:"success",wip_normal:"info",over_packaged:"error"};
  const iconBg={total:"var(--accent)",success:"var(--success)",warning:"var(--warning)",error:"var(--danger)",info:"#2D5F8A"};
  const SortTh=({col,children,style:s})=>(<th onClick={()=>toggleSort(col)} className={sortCol===col?"sorted":""} style={s}>{children}<span className="sort-arrow">{sortCol===col?(sortDir==="asc"?"â–²":"â–¼"):"â‡…"}</span></th>);
  const stats=[{key:"all",l:"ç¸½ç”¢å“æ•¸",v:allVisible.length,t:"total",i:"ğŸ“¦"},{key:"matched",l:`æ ¸å°ä¸€è‡´`,v:matched,t:"success",i:"âœ“",sub:matched>0?`å·²ç¢ºèª ${confirmedCount} / æœªç¢ºèª ${matched-confirmedCount}`:null},{key:"wip",l:"åœ¨è£½å“",v:wip,t:"info",i:"ğŸ”„"},{key:"mismatch",l:"æ•¸é‡å·®ç•°",v:warnings,t:"warning",i:"âš "},{key:"over",l:"åŒ…è£è¶…å‡º",v:overPkg,t:"error",i:"ğŸ“›"},{key:"missing",l:"æ¼å–®",v:errors,t:"error",i:"âœ•"}];
  const addStaff=async(name,role,code)=>{try{await supaFetch("staff",{method:"POST",body:{name,role,code:code||null}});toast(`äººå“¡ã€Œ${name}ã€æ–°å¢æˆåŠŸ`,"success");reloadStaff();}catch(e){toast("æ–°å¢å¤±æ•—: "+e.message,"error");}};

  return <div>
    <AddStaffModal show={staffModal.show} defaultRole={staffModal.role} onClose={()=>setStaffModal({show:false,role:"general"})} onSave={addStaff}/>
    <EditFullItemModal show={editModal.show} item={editModal.item} type={editModal.type} products={products} customers={customers} staff={staff} onClose={()=>setEditModal({show:false,item:null,tableName:"",type:""})} onSave={handleEditItem} onAddStaff={r=>setStaffModal({show:true,role:r})}/>
    <OrderDetailModal show={orderModal.show} orderNo={orderModal.orderNo} orderType={orderModal.orderType} onClose={()=>setOrderModal({show:false,orderNo:null,orderType:null})}/>
    <div className="filter-bar">
      <span className="filter-label">æ—¥æœŸç¯„åœï¼š</span>
      <input type="date" className="input" value={dateFrom} onChange={e=>setDateFrom(e.target.value)}/>
      <span style={{color:"var(--muted)"}}>ï½</span>
      <input type="date" className="input" value={dateTo} onChange={e=>setDateTo(e.target.value)}/>
      <button className="btn btn-primary" onClick={load}>æŸ¥è©¢</button>
      <button className="btn btn-secondary" onClick={()=>{setDateFrom("");setDateTo("");}}>é‡ç½®</button>
      <button className="btn btn-secondary" onClick={()=>{const d30=new Date(Date.now()-30*86400000).toISOString().slice(0,10);setDateFrom(d30);setDateTo(today);}}>éå»30å¤©</button>
      {filter!=="all"&&<button className="btn btn-sm btn-secondary" style={{color:"var(--danger)"}} onClick={()=>setFilterAndReset("all")}>âœ• æ¸…é™¤ç¯©é¸</button>}
      <div className="action-bar no-print">
        <button className="btn btn-secondary btn-sm btn-icon" onClick={()=>{exportToExcel(filtered,[{label:"ç”¢å“ç·¨è™Ÿ",value:r=>r.product_code},{label:"ç”¢å“åç¨±",value:r=>r.product_name},{label:"çµ„è£æ•¸",value:r=>r.assembly_qty},{label:"åŒ…è£æ•¸",value:r=>r.packaging_qty},{label:"å·®ç•°",value:r=>r.diff},{label:"ç‹€æ…‹",value:r=>r.status_desc}],`æ ¸å°å ±å‘Š_${new Date().toISOString().slice(0,10)}.xlsx`);toast("å·²åŒ¯å‡º Excel","success");}}>ğŸ“¥ åŒ¯å‡ºExcel</button>
        <button className="btn btn-secondary btn-sm btn-icon" onClick={()=>printSection("æ ¸å°å ±å‘Š",`${dateFrom||"å…¨éƒ¨"}ï½${dateTo||"å…¨éƒ¨"} Â· ${filtered.length}ç­†`)}>ğŸ–¨ åˆ—å°</button>
      </div>
      <div style={{flex:1}}/>
      <label className="show-resolved-toggle"><input type="checkbox" checked={showMatched} onChange={e=>setShowMatched(e.target.checked)}/>é¡¯ç¤ºå·²å®Œæˆ ({matched})</label>
      <label className="show-resolved-toggle"><input type="checkbox" checked={showHidden} onChange={e=>setShowHidden(e.target.checked)}/>é¡¯ç¤ºå·²éš±è— ({hiddenCount})</label>
    </div>
    <div className="stat-grid">{stats.map(s=>(<div key={s.key} className={`card stat-card ${filter===s.key?"active":""}`} style={filter===s.key?{borderColor:iconBg[s.t],borderWidth:2}:{}} onClick={()=>setFilterAndReset(filter===s.key?"all":s.key)}><div className="stat-icon" style={{background:iconBg[s.t]}}>{s.i}</div><div><div className="stat-value">{s.v}</div><div className="stat-label">{s.l}{filter===s.key?" âœ“":""}</div>{s.sub&&<div style={{fontSize:10,color:"var(--success)",marginTop:1}}>{s.sub}</div>}</div></div>))}</div>
    <div style={{display:"flex",gap:8,marginBottom:8,alignItems:"center",flexWrap:"wrap"}}>
      <span style={{fontSize:12,color:"var(--muted)",whiteSpace:"nowrap"}}>ç¯©é¸ï¼š</span>
      <input className="input" style={{padding:"4px 8px",fontSize:12,width:220}} placeholder="æœå°‹ç”¢å“ç·¨è™Ÿæˆ–åç¨±..." value={colSearch.keyword} onChange={e=>setColSearch({...colSearch,keyword:e.target.value})}/>
      <input className="input" style={{padding:"4px 8px",fontSize:12,width:140}} placeholder="ç‹€æ…‹æœå°‹..." value={colSearch.status_desc} onChange={e=>setColSearch({...colSearch,status_desc:e.target.value})}/>
      {(colSearch.keyword||colSearch.status_desc)&&<button className="btn btn-sm btn-secondary" style={{padding:"3px 8px",fontSize:11}} onClick={()=>setColSearch({keyword:"",status_desc:""})}>æ¸…é™¤</button>}
    </div>
    {loading?<div className="spinner"/>:filtered.length===0?<div style={{textAlign:"center",padding:40,color:"var(--muted)"}}>ç„¡ç¬¦åˆè³‡æ–™</div>:
    <div className="table-wrap"><table>
      <thead><tr><th style={{width:30}}></th><SortTh col="order_date">æ—¥æœŸ</SortTh><SortTh col="product_code">ç”¢å“ç·¨è™Ÿ</SortTh><SortTh col="product_name">ç”¢å“åç¨±</SortTh><SortTh col="assembly_qty" style={{textAlign:"right"}}>çµ„è£æ•¸</SortTh><SortTh col="packaging_qty" style={{textAlign:"right"}}>åŒ…è£æ•¸</SortTh><SortTh col="diff" style={{textAlign:"right"}}>å·®ç•°</SortTh><SortTh col="status">ç‹€æ…‹</SortTh><th style={{width:130}}>è™•ç†</th></tr></thead>
      <tbody>{paged.map((r,i)=>{
        const isResolved=!!r.resolved_at;const isHidden=!!r.hidden;const needsAction=r.status!=="matched";
        const isConfEntry=!!r.is_confirmed_entry;
        const hasAnyConfirm=!!r.confirmed_at;const isFullyConfirmed=hasAnyConfirm&&(r.assembly_qty||0)===0&&(r.packaging_qty||0)===0;const isConfirmed=isFullyConfirmed;const hasPartialConfirm=hasAnyConfirm&&!isFullyConfirmed;const isMatched=r.status==="matched";
        const cls=(isConfEntry?"row-confirmed-entry":r.status==="missing_pkg"||r.status==="missing_asm"?"row-error":r.status==="qty_mismatch"||r.status==="over_packaged"?"row-warning":"")+(isHidden?" row-hidden":isConfirmed&&isMatched&&!isConfEntry?" row-confirmed":isResolved?" row-resolved":"")+" clickable";
        const rowKey=isConfEntry?(r.product_code+"_conf_"+r.confirmed_record_id):(r.product_code+"_"+(r.order_date||"all"));
        const isExpanded=expandedRow===rowKey;
        return <React.Fragment key={rowKey+"_"+i}>
          <tr className={cls} onClick={()=>loadDetail(r)}>
            <td style={{textAlign:"center",fontSize:16,color:"var(--muted)"}}>{isExpanded?"â–¼":"â–¶"}</td>
            <td style={{fontFamily:"'JetBrains Mono',monospace",fontSize:12,color:"var(--muted)"}}>{r.order_date||r.first_asm_date||r.first_pkg_date||"-"}</td>
            <td><code style={{fontWeight:600}}>{r.product_code}</code></td>
            <td>{r.product_name}</td>
            <td style={{fontFamily:"'JetBrains Mono',monospace",fontSize:"1.15em",fontWeight:700,textAlign:"right",color:"#1a1a1a"}}>{r.assembly_qty}{!isConfEntry&&r.confirmed_asm_qty>0&&<span style={{fontSize:10,color:"var(--success)",marginLeft:3}} title={`å·²ç¢ºèª ${r.confirmed_asm_qty}`}>(+{r.confirmed_asm_qty})</span>}</td>
            <td style={{fontFamily:"'JetBrains Mono',monospace",fontSize:"1.15em",fontWeight:700,textAlign:"right",color:"#1a1a1a"}}>{r.packaging_qty}{!isConfEntry&&r.confirmed_pkg_qty>0&&<span style={{fontSize:10,color:"var(--success)",marginLeft:3}} title={`å·²ç¢ºèª ${r.confirmed_pkg_qty}`}>(+{r.confirmed_pkg_qty})</span>}</td>
            <td style={{fontFamily:"'JetBrains Mono',monospace",fontSize:"1.2em",fontWeight:800,textAlign:"right",color:r.diff>0?"var(--danger)":r.diff<0?"var(--warning)":"var(--success)"}}>{r.diff>0?`+${r.diff}`:r.diff}</td>
            <td>{isConfEntry?<><Badge type="success">æ ¸å°ä¸€è‡´</Badge><span className="resolve-tag confirmed-tag" style={{marginLeft:4}}>å·²ç¢ºèª</span></>:<><Badge type={statusMap[r.status]}>{r.status_desc}</Badge>{isConfirmed&&isMatched&&<span className="resolve-tag confirmed-tag" style={{marginLeft:4}}>å·²ç¢ºèª</span>}{hasPartialConfirm&&isMatched&&<span className="resolve-tag" style={{marginLeft:4,background:"#fff3e0",color:"#e65100",border:"1px solid #ffcc80"}}>éƒ¨åˆ†ç¢ºèª</span>}{isResolved&&!isHidden&&needsAction&&<span className="resolve-tag" style={{marginLeft:4}}>å·²è™•ç†</span>}{isHidden&&<span className="resolve-tag hide-tag" style={{marginLeft:4}}>å·²éš±è—</span>}</>}</td>
            <td style={{textAlign:"center"}} onClick={e=>e.stopPropagation()}>{isConfEntry?<div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:6}}><div className="toggle-switch on" role="button" tabIndex={0} title="é»æ“Šå–æ¶ˆç¢ºèª" onClick={e=>{e.stopPropagation();e.preventDefault();unconfirmReconciliation(r);}}></div><span style={{fontSize:10,color:"var(--success)"}}>å·²ç¢ºèª</span></div>:isMatched?<div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:6}}><div className={`toggle-switch ${isConfirmed?"on":"off"}`} style={hasPartialConfirm?{background:"#ff9800"}:{}} role="button" tabIndex={0} title={isConfirmed?"é»æ“Šå–æ¶ˆç¢ºèª":hasPartialConfirm?"é»æ“Šç¢ºèªå‰©é¤˜å–®æ“š":"é»æ“Šç¢ºèªé–å®š"} onClick={e=>{e.stopPropagation();e.preventDefault();if(isConfirmed){unconfirmReconciliation(r);}else{confirmReconciliation(r);}}}></div><span style={{fontSize:10,color:isConfirmed?"var(--success)":hasPartialConfirm?"#e65100":"var(--muted)"}}>{isConfirmed?"å·²ç¢ºèª":hasPartialConfirm?"éƒ¨åˆ†ç¢ºèª":"æœªç¢ºèª"}</span></div>:needsAction&&<div className="resolve-actions"><label title="å·²è™•ç†" style={{display:"flex",alignItems:"center",gap:2,cursor:"pointer",fontSize:11}}><input type="checkbox" className="resolve-check" style={{width:15,height:15}} checked={isResolved} onChange={e=>{e.stopPropagation();isResolved?unmarkResolved(r.product_id):markResolved(r.product_id);}}/><span>å·²è™•ç†</span></label>{isResolved&&<label title="ä¸å†é¡¯ç¤º" style={{display:"flex",alignItems:"center",gap:2,cursor:"pointer",fontSize:11}}><input type="checkbox" className="resolve-check" style={{width:15,height:15}} checked={isHidden} onChange={e=>{e.stopPropagation();isHidden?unmarkHidden(r.product_id):markHidden(r.product_id);}}/><span>éš±è—</span></label>}</div>}</td>
          </tr>
          {isExpanded&&<tr className="expand-row"><td colSpan={9}>
            <ExpandDetailSection expandData={expandData}
              onOrderClick={(no,type)=>setOrderModal({show:true,orderNo:no,orderType:type})}
              onEditClick={isConfEntry?null:(tableName,item)=>{const isAsm=tableName==="assembly_items";setEditModal({show:true,tableName,type:isAsm?"assembly":"packaging",item:isAsm?{id:item.id,product_id:item.product_id,qty:item.qty,assembler:item.assembler||"",warehouse_date:item.warehouse_date||"",note:item.note||""}:{id:item.id,product_id:item.product_id,qty:item.qty,customer_id:item.customer_id||"",is_stock:item.is_stock,tester:item.tester||"",assembler:item.assembler||"",assembly_date:item.assembly_date||"",note:item.note||""}});}}
              onDeleteClick={isConfEntry?null:handleDeleteItem}
              {...(!isConfEntry?{checkedIds,confirmedIds,onCheck:handleCheck,onUnlockItem:handleUnlockItem}:{})}/>
            {expandData.cnv&&expandData.cnv.length>0&&<div className="expand-content" style={{paddingTop:0}}><div className="expand-section" style={{borderLeftColor:"#B8860B"}}><div className="expand-title">ğŸ”„ è½‰æ›è¨˜éŒ„ ({expandData.cnv.length}ç­†)</div><table className="expand-table"><thead><tr><th>å–®è™Ÿ</th><th>è½‰æ›æ—¥æœŸ</th><th>ä¾†æºç”¢å“</th><th>ç›®æ¨™ç”¢å“</th><th style={{textAlign:"right"}}>æ•¸é‡</th><th>ç‹€æ…‹</th><th>è½‰æ›åŸå› </th></tr></thead><tbody>{expandData.cnv.map(c=><tr key={c.id}><td><code style={{fontWeight:600,color:"#B8860B"}}>{c.order_no}</code></td><td>{c.conversion_date}</td><td>{c.from_product?.product_id} - {c.from_product?.product_name}</td><td>{c.to_product?.product_id} - {c.to_product?.product_name}</td><td className="qty-cell">{c.qty}</td><td><Badge type={c.status==="completed"?"success":c.status==="cancelled"?"error":"warning"}>{c.status==="completed"?"å·²å®Œæˆ":c.status==="cancelled"?"å·²å–æ¶ˆ":"å¾…è™•ç†"}</Badge></td><td>{c.reason||"-"}</td></tr>)}</tbody></table></div></div>}
            {!isConfEntry&&checkedIds.size>0&&<div style={{display:"flex",gap:8,padding:"4px 16px 12px",alignItems:"center"}}><button className="btn btn-sm btn-primary" style={{background:"var(--success)"}} onClick={()=>handleConfirmBatch(r)}>ç¢ºèªå·²å‹¾é¸ ({checkedIds.size} ç­†)</button><button className="btn btn-sm btn-secondary" onClick={()=>setCheckedIds(new Set())}>æ¸…é™¤å‹¾é¸</button></div>}
            {needsAction&&!isConfEntry&&!supplementing&&<div style={{display:"flex",gap:8,padding:"0 16px 12px"}}>
              <button className="btn btn-sm btn-primary" onClick={e=>{e.stopPropagation();setSupplementing({product_id:r.product_id,product_code:r.product_code,product_name:r.product_name,order_date:r.order_date,type:"asm",diff:Math.abs(r.diff)});setSuppForm({...suppForm,qty:Math.abs(r.diff)||1,order_date:r.order_date||""});}}>ï¼‹ è£œçµ„è£å–®</button>
              <button className="btn btn-sm btn-primary" style={{background:"var(--accent)"}} onClick={e=>{e.stopPropagation();setSupplementing({product_id:r.product_id,product_code:r.product_code,product_name:r.product_name,order_date:r.order_date,type:"pkg",diff:Math.abs(r.diff)});setSuppForm({...suppForm,qty:Math.abs(r.diff)||1});}}>ï¼‹ è£œåŒ…è£å‡ºè²¨å–®</button>
            </div>}
            {supplementing&&supplementing.product_code===r.product_code&&<SupplementForm
              supplementing={supplementing} suppForm={suppForm} setSuppForm={setSuppForm}
              customers={customers} staff={staff} onSubmit={submitSupplement}
              onCancel={()=>setSupplementing(null)} onAddStaff={role=>setStaffModal({show:true,role})}/>}
          </td></tr>}
        </React.Fragment>;
      })}</tbody>
    </table></div>}
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:10,fontSize:12,color:"var(--muted)",flexWrap:"wrap",gap:8}}>
      <span>é¡¯ç¤º {(safePage-1)*pageSize+1}~{Math.min(safePage*pageSize,filtered.length)} / {filtered.length} ç­† (å…± {data.length} ç­†) Â· å·²éš±è— {hiddenCount} ç­†</span>
      <div style={{display:"flex",alignItems:"center",gap:8}}>
        <span>æ¯é </span>
        {[50,100].map(n=><button key={n} className={`btn btn-sm ${pageSize===n?"btn-primary":"btn-secondary"}`} style={{padding:"2px 8px",fontSize:11,minWidth:36}} onClick={()=>{setPageSize(n);setPage(1);}}>{n}</button>)}
        <span style={{margin:"0 4px"}}>ç­†</span>
        <button className="btn btn-sm btn-secondary" disabled={safePage<=1} onClick={()=>setPage(p=>p-1)}>â† ä¸Šä¸€é </button>
        <span style={{fontWeight:600,color:"var(--text)"}}>ç¬¬ {safePage}/{totalPages} é </span>
        <button className="btn btn-sm btn-secondary" disabled={safePage>=totalPages} onClick={()=>setPage(p=>p+1)}>ä¸‹ä¸€é  â†’</button>
      </div>
    </div>
  </div>;
}

function AssemblyTab({products,staff,toast,reloadStaff}){
  const[orders,setOrders]=useState([]);const[items,setItems]=useState([]);const[sel,setSel]=useState(null);const[loading,setLoading]=useState(true);const[showForm,setShowForm]=useState(false);const[orderDate,setOrderDate]=useState(new Date().toISOString().slice(0,10));const[newItems,setNewItems]=useState([{product_id:"",qty:1,assembler:"",warehouse_date:"",note:""}]);
  const[staffModal,setStaffModal]=useState(false);const[editModal,setEditModal]=useState({show:false,item:null});const[showImport,setShowImport]=useState(false);
  const[dateFromF,setDateFromF]=useState("");const[dateToF,setDateToF]=useState("");
  const[confirmedPids,setConfirmedPids]=useState(new Set());const[editingDate,setEditingDate]=useState(false);const[editDateVal,setEditDateVal]=useState("");
  const load=useCallback(async()=>{setLoading(true);try{let q="select=*&order=order_date.desc,created_at.desc";if(dateFromF)q+=`&order_date=gte.${dateFromF}`;if(dateToF)q+=`&order_date=lte.${dateToF}`;setOrders(await supaFetchAll("assembly_orders",q)||[]);}catch(e){}setLoading(false);},[dateFromF,dateToF]);
  useEffect(()=>{load();},[load]);
  const loadItems=async id=>{try{const its=await supaFetchAll("assembly_items",`select=*,products(product_id,product_name)&order_id=eq.${id}`)||[];setItems(its);setSel(id);
    const pids=[...new Set(its.map(it=>it.product_id).filter(Boolean))];const cSet=new Set();
    for(const pid of pids){const c=await supaFetch("reconciliation_confirmed",{query:`select=id&product_id=eq.${pid}&limit=1`});if(c&&c.length>0)cSet.add(pid);}
    setConfirmedPids(cSet);}catch(e){}};
  const create=async()=>{const valid=newItems.filter(it=>it.product_id&&it.qty>0);if(!valid.length){toast("è«‹è‡³å°‘æ–°å¢ä¸€å€‹ç”¢å“","error");return;}try{const[order]=await supaFetch("assembly_orders",{method:"POST",body:{order_date:orderDate,status:"draft"}});for(const it of valid)await supaFetch("assembly_items",{method:"POST",body:{order_id:order.id,product_id:it.product_id,qty:parseInt(it.qty),assembler:it.assembler,warehouse_date:it.warehouse_date||null,note:it.note}});toast("çµ„è£å–®å»ºç«‹æˆåŠŸï¼å–®è™Ÿ: "+order.order_no,"success");setShowForm(false);setNewItems([{product_id:"",qty:1,assembler:"",warehouse_date:"",note:""}]);load();}catch(e){toast("å»ºç«‹å¤±æ•—: "+e.message,"error");}};
  const approveOrder=async(id)=>{try{await supaPatch("assembly_orders",`id=eq.${id}`,{status:"approved"});toast("å·²æ ¸å‡†","success");load();}catch(e){toast("æ ¸å‡†å¤±æ•—: "+e.message,"error");}};
  const revertDraft=async(id)=>{try{await supaPatch("assembly_orders",`id=eq.${id}`,{status:"draft"});toast("å·²é€€å›è‰ç¨¿","success");load();}catch(e){toast("æ“ä½œå¤±æ•—: "+e.message,"error");}};
  const saveOrderDate=async()=>{if(!editDateVal)return;try{await supaPatch("assembly_orders",`id=eq.${sel}`,{order_date:editDateVal});toast("æ—¥æœŸå·²ä¿®æ”¹","success");setEditingDate(false);load();}catch(e){toast("ä¿®æ”¹å¤±æ•—: "+e.message,"error");}};
  const handleEditItem=async(form)=>{const it=editModal.item;try{const body={product_id:form.product_id,qty:parseInt(form.qty),assembler:form.assembler||null,warehouse_date:form.warehouse_date||null,note:form.note||null};
    if(it.id){await supaPatch("assembly_items",`id=eq.${it.id}`,body);toast("æ˜ç´°å·²ä¿®æ”¹","success");}
    else{await supaFetch("assembly_items",{method:"POST",body:{...body,order_id:sel}});toast("æ˜ç´°å·²æ–°å¢","success");}
    setEditModal({show:false,item:null});loadItems(sel);}catch(e){toast("æ“ä½œå¤±æ•—: "+e.message,"error");}};
  const addStaff=async(name,role,code)=>{try{await supaFetch("staff",{method:"POST",body:{name,role,code:code||null}});toast(`äººå“¡ã€Œ${name}ã€æ–°å¢æˆåŠŸ`,"success");reloadStaff();}catch(e){toast("æ–°å¢å¤±æ•—: "+e.message,"error");}};
  const deleteItem=async(it)=>{if(confirmedPids.has(it.product_id)){toast("æ­¤ç”¢å“å·²åœ¨æ ¸å°å ±å‘Šä¸­ç¢ºèªï¼Œç„¡æ³•åˆªé™¤","error");return;}if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†æ˜ç´°ï¼Ÿæ­¤æ“ä½œä¸å¯å¾©åŸã€‚"))return;try{await supaDelete("assembly_items",`id=eq.${it.id}`);toast("å·²åˆªé™¤","success");const remaining=await supaFetch("assembly_items",{query:`select=id&order_id=eq.${sel}&limit=1`});if(!remaining||remaining.length===0){if(confirm("æ­¤å–®æ“šå·²ç„¡æ˜ç´°ï¼Œæ˜¯å¦ä¸€ä½µåˆªé™¤æ•´å¼µå–®æ“šï¼Ÿ")){await supaDelete("assembly_orders",`id=eq.${sel}`);setSel(null);load();return;}}loadItems(sel);}catch(e){toast("åˆªé™¤å¤±æ•—: "+e.message,"error");}};
  const isConfirmed=(it)=>confirmedPids.has(it.product_id);
  const sC={draft:"neutral",submitted:"info",approved:"success",rejected:"error"};const sL={draft:"è‰ç¨¿",submitted:"å·²é€ç°½",approved:"å·²æ ¸å‡†",rejected:"å·²é€€å›"};const selOrder=orders.find(o=>o.id===sel);
  return <div><AddStaffModal show={staffModal} defaultRole="assembler" onClose={()=>setStaffModal(false)} onSave={addStaff}/><EditFullItemModal show={editModal.show} item={editModal.item} type="assembly" products={products} staff={staff} onClose={()=>setEditModal({show:false,item:null})} onSave={handleEditItem} onAddStaff={r=>setStaffModal(true)}/><ImportExcelModal show={showImport} type="assembly" onClose={()=>setShowImport(false)} products={products} staff={staff} toast={toast} onImportDone={load} onAddStaff={()=>setStaffModal(true)}/><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16,flexWrap:"wrap",gap:8}}><div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}><span style={{fontSize:12,color:"var(--muted)"}}>å…± {orders.length} ç­†çµ„è£å–®</span><span className="filter-label">æ—¥æœŸï¼š</span><input type="date" className="input" style={{width:130,padding:"4px 6px",fontSize:12}} value={dateFromF} onChange={e=>setDateFromF(e.target.value)}/><span style={{color:"var(--muted)"}}>ï½</span><input type="date" className="input" style={{width:130,padding:"4px 6px",fontSize:12}} value={dateToF} onChange={e=>setDateToF(e.target.value)}/>{(dateFromF||dateToF)&&<button className="btn btn-sm btn-secondary" style={{padding:"3px 8px",fontSize:11}} onClick={()=>{setDateFromF("");setDateToF("");}}>æ¸…é™¤</button>}</div><div className="action-bar"><button className="btn btn-secondary btn-sm btn-icon" onClick={()=>setShowImport(true)}>ğŸ“¤ åŒ¯å…¥Excel</button>{sel&&items.length>0&&<><button className="btn btn-secondary btn-sm btn-icon" onClick={()=>{exportToExcel(items,[{label:"ç”¢å“ç·¨è™Ÿ",value:r=>r.products?.product_id},{label:"ç”¢å“åç¨±",value:r=>r.products?.product_name},{label:"æ•¸é‡",value:r=>r.qty},{label:"çµ„è£äººå“¡",value:r=>r.assembler||""},{label:"å…¥åº«æ—¥æœŸ",value:r=>r.warehouse_date||""},{label:"å‚™è¨»",value:r=>r.note||""}],`çµ„è£å–®_${selOrder?.order_no||"export"}.xlsx`);toast("å·²åŒ¯å‡º","success");}}>ğŸ“¥ Excel</button><button className="btn btn-secondary btn-sm btn-icon" onClick={()=>printSection(`çµ„è£å–® ${selOrder?.order_no}`,`çµ„è£æ—¥æœŸ: ${selOrder?.order_date}`)}>ğŸ–¨ åˆ—å°</button></>}<button className="btn btn-primary" onClick={()=>setShowForm(!showForm)}>{showForm?"å–æ¶ˆ":"+ æ–°å¢çµ„è£å–®"}</button></div></div>
  {showForm&&<div className="form-box"><div className="form-title">æ–°å¢çµ„è£å–®</div><div className="form-row" style={{marginBottom:12}}><span className="filter-label">çµ„è£æ—¥æœŸï¼š</span><input type="date" className="input" value={orderDate} onChange={e=>setOrderDate(e.target.value)} style={{width:160}}/></div>{newItems.map((it,idx)=><div key={idx} className="form-row"><ProductSearch products={products} value={it.product_id} onChange={v=>{const n=[...newItems];n[idx].product_id=v;setNewItems(n);}} style={{minWidth:240,flex:2}}/><input type="number" className="input" style={{width:65}} min="1" value={it.qty} onChange={e=>{const n=[...newItems];n[idx].qty=e.target.value;setNewItems(n);}} placeholder="æ•¸é‡"/><StaffSelect staff={staff} value={it.assembler} onChange={v=>{const n=[...newItems];n[idx].assembler=v;setNewItems(n);}} onAdd={()=>setStaffModal(true)} roleFilter="assembler" placeholder="çµ„è£äººå“¡" multi style={{width:180}}/><input type="date" className="input" style={{width:140}} value={it.warehouse_date} onChange={e=>{const n=[...newItems];n[idx].warehouse_date=e.target.value;setNewItems(n);}}/><input className="input" style={{flex:1,minWidth:80}} value={it.note} onChange={e=>{const n=[...newItems];n[idx].note=e.target.value;setNewItems(n);}} placeholder="å‚™è¨»"/>{newItems.length>1&&<button className="btn btn-secondary btn-sm" style={{color:"var(--danger)"}} onClick={()=>setNewItems(newItems.filter((_,i)=>i!==idx))}>âœ•</button>}</div>)}<div style={{display:"flex",gap:8,marginTop:10}}><button className="btn btn-secondary btn-sm" onClick={()=>setNewItems([...newItems,{product_id:"",qty:1,assembler:"",warehouse_date:"",note:""}])}>+ æ–°å¢ç”¢å“è¡Œ</button><button className="btn btn-primary" onClick={create}>ç¢ºèªå»ºç«‹</button></div></div>}
  {loading?<div className="spinner"/>:<div className="split-view"><div className="split-left">{orders.map(o=><div key={o.id} className={`order-card ${sel===o.id?"selected":""}`} onClick={()=>loadItems(o.id)}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><code className="order-no">{o.order_no}</code><Badge type={sC[o.status]}>{sL[o.status]}</Badge></div><div className="order-date">ğŸ“… {o.order_date}</div></div>)}{!orders.length&&<div style={{textAlign:"center",padding:30,color:"var(--muted)"}}>å°šç„¡çµ„è£å–®</div>}</div>{sel&&<div className="split-right">{selOrder&&<div style={{display:"flex",gap:8,marginBottom:10,alignItems:"center",flexWrap:"wrap"}}>
    {selOrder.status==="draft"&&<><button className="btn btn-primary btn-sm" style={{background:"var(--success)"}} onClick={()=>approveOrder(sel)}>âœ“ æ ¸å‡†</button><button className="btn btn-secondary btn-sm" style={{color:"var(--danger)"}} onClick={()=>{if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤çµ„è£å–®ï¼Ÿ")){(async()=>{try{const its=await supaFetch("assembly_items",{query:`select=product_id&order_id=eq.${sel}`});for(const it of(its||[])){const conf=await supaFetch("reconciliation_confirmed",{query:`select=id&product_id=eq.${it.product_id}&limit=1`});if(conf&&conf.length>0){toast("æ­¤å–®æ“šå«æœ‰å·²ç¢ºèªæ ¸å°çš„ç”¢å“ï¼Œç„¡æ³•åˆªé™¤","error");return;}}await supaDelete("assembly_items",`order_id=eq.${sel}`);await supaDelete("assembly_orders",`id=eq.${sel}`);toast("å·²åˆªé™¤","success");setSel(null);load();}catch(e){toast("åˆªé™¤å¤±æ•—: "+e.message,"error");}})();}}}>ğŸ—‘ åˆªé™¤</button></>}
    {selOrder.status==="approved"&&<button className="btn btn-secondary btn-sm" onClick={()=>revertDraft(sel)}>â†© é€€å›è‰ç¨¿</button>}
    <div style={{flex:1}}/>
    <span style={{fontSize:12,color:"var(--muted)"}}>ğŸ“…</span>
    {editingDate?<><input type="date" className="input" style={{width:140,padding:"3px 6px",fontSize:12}} value={editDateVal} onChange={e=>setEditDateVal(e.target.value)}/><button className="btn btn-sm btn-primary" style={{padding:"2px 8px"}} onClick={saveOrderDate}>å„²å­˜</button><button className="btn btn-sm btn-secondary" style={{padding:"2px 8px"}} onClick={()=>setEditingDate(false)}>å–æ¶ˆ</button></>
    :<><span style={{fontSize:13,fontWeight:600}}>{selOrder.order_date}</span><button className="btn-edit" style={{marginLeft:4}} onClick={()=>{setEditDateVal(selOrder.order_date);setEditingDate(true);}}>ä¿®æ”¹æ—¥æœŸ</button></>}
  </div>}
  <div className="table-wrap"><table><thead><tr>{["ç”¢å“ç·¨è™Ÿ","ç”¢å“åç¨±","æ•¸é‡","çµ„è£äººå“¡","å…¥åº«æ—¥æœŸ","å‚™è¨»",""].map(h=><th key={h}>{h}</th>)}</tr></thead><tbody>{items.map(it=>{const locked=isConfirmed(it);return <tr key={it.id} style={locked?{opacity:.6}:{}}>
    <td><code style={{fontWeight:600}}>{it.products?.product_id}</code></td><td>{it.products?.product_name}</td>
    <td style={{fontWeight:700,fontFamily:"'JetBrains Mono',monospace"}}>{it.qty}</td><td>{it.assembler||"-"}</td><td>{it.warehouse_date||"-"}</td><td>{it.note||"-"}</td>
    <td>{locked?<span style={{fontSize:11,color:"var(--muted)"}} title="å·²ç¢ºèªæ ¸å°ï¼Œç„¡æ³•ä¿®æ”¹">ğŸ”’ å·²ç¢ºèª</span>:<>
      <button className="btn-edit" onClick={()=>setEditModal({show:true,item:{id:it.id,product_id:it.product_id,qty:it.qty,assembler:it.assembler||"",warehouse_date:it.warehouse_date||"",note:it.note||""}})}>ä¿®æ”¹</button>
      <button className="btn-edit" style={{borderColor:"var(--danger)",color:"var(--danger)",marginLeft:4}} onClick={()=>deleteItem(it)}>åˆªé™¤</button>
    </>}</td></tr>;})}</tbody></table></div>
  <div style={{marginTop:8}}><button className="btn btn-sm btn-secondary" onClick={()=>setEditModal({show:true,item:{id:null,product_id:"",qty:1,assembler:"",warehouse_date:"",note:""}})}>+ æ–°å¢æ˜ç´°</button></div>
  </div>}</div>}</div>;
}

function PackagingTab({products,customers,staff,toast,reloadStaff}){
  const[orders,setOrders]=useState([]);const[items,setItems]=useState([]);const[sel,setSel]=useState(null);const[loading,setLoading]=useState(true);const[showForm,setShowForm]=useState(false);const[orderDate,setOrderDate]=useState(new Date().toISOString().slice(0,10));const[orderCustomerId,setOrderCustomerId]=useState("");const[newItems,setNewItems]=useState([{product_id:"",qty:1,customer_id:"",tester:"",assembler:"",assembly_date:"",note:""}]);
  const[staffModal,setStaffModal]=useState({show:false,role:"tester"});const[editModal,setEditModal]=useState({show:false,item:null});const[showImport,setShowImport]=useState(false);
  const[customerFilter,setCustomerFilter]=useState("");
  const[dateFromF,setDateFromF]=useState("");const[dateToF,setDateToF]=useState("");
  const[confirmedPids,setConfirmedPids]=useState(new Set());const[editingDate,setEditingDate]=useState(false);const[editDateVal,setEditDateVal]=useState("");
  const load=useCallback(async()=>{setLoading(true);try{let q="select=*,customers(name,customer_code)&order=order_date.desc,created_at.desc";if(dateFromF)q+=`&order_date=gte.${dateFromF}`;if(dateToF)q+=`&order_date=lte.${dateToF}`;setOrders(await supaFetchAll("packaging_orders",q)||[]);}catch(e){}setLoading(false);},[dateFromF,dateToF]);
  useEffect(()=>{load();},[load]);
  const loadItems=async id=>{try{const its=await supaFetchAll("packaging_items",`select=*,products(product_id,product_name),customers(name)&order_id=eq.${id}`)||[];setItems(its);setSel(id);
    const pids=[...new Set(its.map(it=>it.product_id).filter(Boolean))];const cSet=new Set();
    for(const pid of pids){const c=await supaFetch("reconciliation_confirmed",{query:`select=id&product_id=eq.${pid}&limit=1`});if(c&&c.length>0)cSet.add(pid);}
    setConfirmedPids(cSet);}catch(e){console.error(e);}};
  const create=async()=>{const valid=newItems.filter(it=>it.product_id&&it.qty>0);if(!valid.length){toast("è«‹è‡³å°‘æ–°å¢ä¸€å€‹ç”¢å“","error");return;}try{const[order]=await supaFetch("packaging_orders",{method:"POST",body:{order_date:orderDate,status:"draft",customer_id:orderCustomerId||null}});for(const it of valid)await supaFetch("packaging_items",{method:"POST",body:{order_id:order.id,product_id:it.product_id,qty:parseInt(it.qty),customer_id:it.customer_id||orderCustomerId||null,is_stock:!(it.customer_id||orderCustomerId),tester:it.tester,assembler:it.assembler,assembly_date:it.assembly_date||null,note:it.note}});toast("åŒ…è£å‡ºè²¨å…¥åº«å–®å»ºç«‹æˆåŠŸï¼å–®è™Ÿ: "+order.order_no,"success");setShowForm(false);setOrderCustomerId("");setNewItems([{product_id:"",qty:1,customer_id:"",tester:"",assembler:"",assembly_date:"",note:""}]);load();}catch(e){toast("å»ºç«‹å¤±æ•—: "+e.message,"error");}};
  const approveOrder=async(id)=>{try{await supaPatch("packaging_orders",`id=eq.${id}`,{status:"approved"});toast("å·²æ ¸å‡†","success");load();}catch(e){toast("æ ¸å‡†å¤±æ•—: "+e.message,"error");}};
  const revertDraft=async(id)=>{try{await supaPatch("packaging_orders",`id=eq.${id}`,{status:"draft"});toast("å·²é€€å›è‰ç¨¿","success");load();}catch(e){toast("æ“ä½œå¤±æ•—: "+e.message,"error");}};
  const saveOrderDate=async()=>{if(!editDateVal)return;try{await supaPatch("packaging_orders",`id=eq.${sel}`,{order_date:editDateVal});toast("æ—¥æœŸå·²ä¿®æ”¹","success");setEditingDate(false);load();}catch(e){toast("ä¿®æ”¹å¤±æ•—: "+e.message,"error");}};
  const handleEditItem=async(form)=>{const it=editModal.item;try{const body={product_id:form.product_id,qty:parseInt(form.qty),customer_id:form.customer_id||null,is_stock:!form.customer_id,tester:form.tester||null,assembler:form.assembler||null,assembly_date:form.assembly_date||null,note:form.note||null};
    if(it.id){await supaPatch("packaging_items",`id=eq.${it.id}`,body);toast("æ˜ç´°å·²ä¿®æ”¹","success");}
    else{await supaFetch("packaging_items",{method:"POST",body:{...body,order_id:sel}});toast("æ˜ç´°å·²æ–°å¢","success");}
    setEditModal({show:false,item:null});loadItems(sel);}catch(e){toast("æ“ä½œå¤±æ•—: "+e.message,"error");}};
  const addStaff=async(name,role,code)=>{try{await supaFetch("staff",{method:"POST",body:{name,role,code:code||null}});toast(`äººå“¡ã€Œ${name}ã€æ–°å¢æˆåŠŸ`,"success");reloadStaff();}catch(e){toast("æ–°å¢å¤±æ•—: "+e.message,"error");}};
  const deleteItem=async(it)=>{if(confirmedPids.has(it.product_id)){toast("æ­¤ç”¢å“å·²åœ¨æ ¸å°å ±å‘Šä¸­ç¢ºèªï¼Œç„¡æ³•åˆªé™¤","error");return;}if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†æ˜ç´°ï¼Ÿæ­¤æ“ä½œä¸å¯å¾©åŸã€‚"))return;try{await supaDelete("packaging_items",`id=eq.${it.id}`);toast("å·²åˆªé™¤","success");const remaining=await supaFetch("packaging_items",{query:`select=id&order_id=eq.${sel}&limit=1`});if(!remaining||remaining.length===0){if(confirm("æ­¤å–®æ“šå·²ç„¡æ˜ç´°ï¼Œæ˜¯å¦ä¸€ä½µåˆªé™¤æ•´å¼µå–®æ“šï¼Ÿ")){await supaDelete("packaging_orders",`id=eq.${sel}`);setSel(null);load();return;}}loadItems(sel);}catch(e){toast("åˆªé™¤å¤±æ•—: "+e.message,"error");}};
  const isConfirmed=(it)=>confirmedPids.has(it.product_id);
  const sC={draft:"neutral",submitted:"info",approved:"success",rejected:"error"};const sL={draft:"è‰ç¨¿",submitted:"å·²é€ç°½",approved:"å·²æ ¸å‡†",rejected:"å·²é€€å›"};
  const filteredOrders=customerFilter?orders.filter(o=>o.customer_id===customerFilter):orders;
  const selOrder=orders.find(o=>o.id===sel);
  return <div><AddStaffModal show={staffModal.show} defaultRole={staffModal.role} onClose={()=>setStaffModal({show:false,role:"tester"})} onSave={addStaff}/><EditFullItemModal show={editModal.show} item={editModal.item} type="packaging" products={products} customers={customers} staff={staff} onClose={()=>setEditModal({show:false,item:null})} onSave={handleEditItem} onAddStaff={r=>setStaffModal({show:true,role:r})}/><ImportExcelModal show={showImport} type="packaging" onClose={()=>setShowImport(false)} products={products} customers={customers} staff={staff} toast={toast} onImportDone={load} onAddStaff={()=>setStaffModal({show:true,role:"general"})}/><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16,flexWrap:"wrap",gap:8}}><div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}><span style={{fontSize:12,color:"var(--muted)"}}>å…± {orders.length} ç­†åŒ…è£å–®{customerFilter?` (ç¯©é¸: ${filteredOrders.length} ç­†)`:""}</span><span className="filter-label">æ—¥æœŸï¼š</span><input type="date" className="input" style={{width:130,padding:"4px 6px",fontSize:12}} value={dateFromF} onChange={e=>setDateFromF(e.target.value)}/><span style={{color:"var(--muted)"}}>ï½</span><input type="date" className="input" style={{width:130,padding:"4px 6px",fontSize:12}} value={dateToF} onChange={e=>setDateToF(e.target.value)}/>{(dateFromF||dateToF)&&<button className="btn btn-sm btn-secondary" style={{padding:"3px 8px",fontSize:11}} onClick={()=>{setDateFromF("");setDateToF("");}}>æ¸…é™¤</button>}<span className="filter-label">å®¢æˆ¶ï¼š</span><select className="input" style={{width:140}} value={customerFilter} onChange={e=>setCustomerFilter(e.target.value)}><option value="">å…¨éƒ¨å®¢æˆ¶</option>{customers.map(cu=><option key={cu.id} value={cu.id}>{cu.customer_code?cu.customer_code+" - ":""}{cu.name}</option>)}</select></div><div className="action-bar"><button className="btn btn-secondary btn-sm btn-icon" onClick={()=>setShowImport(true)}>ğŸ“¤ åŒ¯å…¥Excel</button>{sel&&items.length>0&&<><button className="btn btn-secondary btn-sm btn-icon" onClick={()=>{exportToExcel(items,[{label:"ç”¢å“ç·¨è™Ÿ",value:r=>r.products?.product_id},{label:"ç”¢å“åç¨±",value:r=>r.products?.product_name},{label:"æ•¸é‡",value:r=>r.qty},{label:"å®¢æˆ¶",value:r=>r.is_stock?"åº«å­˜":r.customers?.name||""},{label:"æ¸¬è©¦äººå“¡",value:r=>r.tester||""},{label:"çµ„è£äººå“¡",value:r=>r.assembler||""},{label:"çµ„è£æ—¥æœŸ",value:r=>r.assembly_date||""},{label:"å‚™è¨»",value:r=>r.note||""}],`åŒ…è£å–®_${selOrder?.order_no||"export"}.xlsx`);toast("å·²åŒ¯å‡º","success");}}>ğŸ“¥ Excel</button><button className="btn btn-secondary btn-sm btn-icon" onClick={()=>printSection(`åŒ…è£å‡ºè²¨å…¥åº«å–® ${selOrder?.order_no}`,`åŒ…è£æ—¥æœŸ: ${selOrder?.order_date}`)}>ğŸ–¨ åˆ—å°</button></>}<button className="btn btn-primary" onClick={()=>setShowForm(!showForm)}>{showForm?"å–æ¶ˆ":"+ æ–°å¢åŒ…è£å–®"}</button></div></div>
  {showForm&&<div className="form-box"><div className="form-title">æ–°å¢åŒ…è£å‡ºè²¨å…¥åº«å–®</div><div className="form-row" style={{marginBottom:12}}><span className="filter-label">åŒ…è£æ—¥æœŸï¼š</span><input type="date" className="input" value={orderDate} onChange={e=>setOrderDate(e.target.value)} style={{width:160}}/><span className="filter-label">å®¢æˆ¶ï¼š</span><select className="input" style={{width:160}} value={orderCustomerId} onChange={e=>setOrderCustomerId(e.target.value)}><option value="">åº«å­˜ï¼ˆç„¡å®¢æˆ¶ï¼‰</option>{customers.map(cu=><option key={cu.id} value={cu.id}>{cu.customer_code?cu.customer_code+" - ":""}{cu.name}</option>)}</select></div>{newItems.map((it,idx)=><div key={idx} className="form-row"><ProductSearch products={products} value={it.product_id} onChange={v=>{const n=[...newItems];n[idx].product_id=v;setNewItems(n);}} style={{minWidth:200,flex:2}}/><input type="number" className="input" style={{width:60}} min="1" value={it.qty} onChange={e=>{const n=[...newItems];n[idx].qty=e.target.value;setNewItems(n);}} placeholder="æ•¸é‡"/><select className="input" style={{width:100}} value={it.customer_id} onChange={e=>{const n=[...newItems];n[idx].customer_id=e.target.value;setNewItems(n);}}><option value="">åº«å­˜</option>{customers.map(cu=><option key={cu.id} value={cu.id}>{cu.name}</option>)}</select><StaffSelect staff={staff} value={it.tester} onChange={v=>{const n=[...newItems];n[idx].tester=v;setNewItems(n);}} onAdd={()=>setStaffModal({show:true,role:"tester"})} roleFilter="tester" placeholder="æ¸¬è©¦äººå“¡" multi style={{width:160}}/><StaffSelect staff={staff} value={it.assembler} onChange={v=>{const n=[...newItems];n[idx].assembler=v;setNewItems(n);}} onAdd={()=>setStaffModal({show:true,role:"assembler"})} roleFilter="assembler" placeholder="çµ„è£äººå“¡" multi style={{width:160}}/><input type="date" className="input" style={{width:135}} value={it.assembly_date} onChange={e=>{const n=[...newItems];n[idx].assembly_date=e.target.value;setNewItems(n);}}/><input className="input" style={{flex:1,minWidth:60}} value={it.note} onChange={e=>{const n=[...newItems];n[idx].note=e.target.value;setNewItems(n);}} placeholder="å‚™è¨»"/>{newItems.length>1&&<button className="btn btn-secondary btn-sm" style={{color:"var(--danger)"}} onClick={()=>setNewItems(newItems.filter((_,i)=>i!==idx))}>âœ•</button>}</div>)}<div style={{display:"flex",gap:8,marginTop:10}}><button className="btn btn-secondary btn-sm" onClick={()=>setNewItems([...newItems,{product_id:"",qty:1,customer_id:"",tester:"",assembler:"",assembly_date:"",note:""}])}>+ æ–°å¢ç”¢å“è¡Œ</button><button className="btn btn-primary" onClick={create}>ç¢ºèªå»ºç«‹</button></div></div>}
  {loading?<div className="spinner"/>:<div className="split-view"><div className="split-left">{filteredOrders.map(o=><div key={o.id} className={`order-card ${sel===o.id?"selected":""}`} onClick={()=>loadItems(o.id)}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><code className="order-no">{o.order_no}</code><Badge type={sC[o.status]}>{sL[o.status]}</Badge></div><div className="order-date">ğŸ“… {o.order_date}{o.customers?<span style={{marginLeft:8,color:"var(--accent)",fontWeight:600}}>{o.customers.customer_code||o.customers.name}</span>:""}</div></div>)}{!filteredOrders.length&&<div style={{textAlign:"center",padding:30,color:"var(--muted)"}}>{customerFilter?"æ­¤å®¢æˆ¶ç„¡åŒ…è£å–®":"å°šç„¡åŒ…è£å–®"}</div>}</div>{sel&&<div className="split-right">{selOrder&&<div style={{display:"flex",gap:8,marginBottom:10,alignItems:"center",flexWrap:"wrap"}}>
    {selOrder.status==="draft"&&<><button className="btn btn-primary btn-sm" style={{background:"var(--success)"}} onClick={()=>approveOrder(sel)}>âœ“ æ ¸å‡†</button><button className="btn btn-secondary btn-sm" style={{color:"var(--danger)"}} onClick={()=>{if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤åŒ…è£å–®ï¼Ÿ")){(async()=>{try{const its=await supaFetch("packaging_items",{query:`select=product_id&order_id=eq.${sel}`});for(const it of(its||[])){const conf=await supaFetch("reconciliation_confirmed",{query:`select=id&product_id=eq.${it.product_id}&limit=1`});if(conf&&conf.length>0){toast("æ­¤å–®æ“šå«æœ‰å·²ç¢ºèªæ ¸å°çš„ç”¢å“ï¼Œç„¡æ³•åˆªé™¤","error");return;}}await supaDelete("packaging_items",`order_id=eq.${sel}`);await supaDelete("packaging_orders",`id=eq.${sel}`);toast("å·²åˆªé™¤","success");setSel(null);load();}catch(e){toast("åˆªé™¤å¤±æ•—: "+e.message,"error");}})();}}}>ğŸ—‘ åˆªé™¤</button></>}
    {selOrder.status==="approved"&&<button className="btn btn-secondary btn-sm" onClick={()=>revertDraft(sel)}>â†© é€€å›è‰ç¨¿</button>}
    <div style={{flex:1}}/>
    <span style={{fontSize:12,color:"var(--muted)"}}>ğŸ“…</span>
    {editingDate?<><input type="date" className="input" style={{width:140,padding:"3px 6px",fontSize:12}} value={editDateVal} onChange={e=>setEditDateVal(e.target.value)}/><button className="btn btn-sm btn-primary" style={{padding:"2px 8px"}} onClick={saveOrderDate}>å„²å­˜</button><button className="btn btn-sm btn-secondary" style={{padding:"2px 8px"}} onClick={()=>setEditingDate(false)}>å–æ¶ˆ</button></>
    :<><span style={{fontSize:13,fontWeight:600}}>{selOrder.order_date}</span><button className="btn-edit" style={{marginLeft:4}} onClick={()=>{setEditDateVal(selOrder.order_date);setEditingDate(true);}}>ä¿®æ”¹æ—¥æœŸ</button></>}
  </div>}
  <div className="table-wrap"><table><thead><tr>{["ç”¢å“ç·¨è™Ÿ","ç”¢å“åç¨±","æ•¸é‡","å®¢æˆ¶","æ¸¬è©¦äººå“¡","çµ„è£äººå“¡","çµ„è£æ—¥æœŸ","å‚™è¨»",""].map(h=><th key={h}>{h}</th>)}</tr></thead><tbody>{items.map(it=>{const locked=isConfirmed(it);return <tr key={it.id} style={locked?{opacity:.6}:{}}>
    <td><code style={{fontWeight:600}}>{it.products?.product_id}</code></td><td>{it.products?.product_name}</td>
    <td style={{fontWeight:700,fontFamily:"'JetBrains Mono',monospace"}}>{it.qty}</td><td>{it.is_stock?"åº«å­˜":it.customers?.name||"-"}</td><td>{it.tester||"-"}</td><td>{it.assembler||"-"}</td><td>{it.assembly_date||"-"}</td><td>{it.note||"-"}</td>
    <td>{locked?<span style={{fontSize:11,color:"var(--muted)"}} title="å·²ç¢ºèªæ ¸å°ï¼Œç„¡æ³•ä¿®æ”¹">ğŸ”’ å·²ç¢ºèª</span>:<>
      <button className="btn-edit" onClick={()=>setEditModal({show:true,item:{id:it.id,product_id:it.product_id,qty:it.qty,customer_id:it.customer_id||"",is_stock:it.is_stock,tester:it.tester||"",assembler:it.assembler||"",assembly_date:it.assembly_date||"",note:it.note||""}})}>ä¿®æ”¹</button>
      <button className="btn-edit" style={{borderColor:"var(--danger)",color:"var(--danger)",marginLeft:4}} onClick={()=>deleteItem(it)}>åˆªé™¤</button>
    </>}</td></tr>;})}</tbody></table></div>
  <div style={{marginTop:8}}><button className="btn btn-sm btn-secondary" onClick={()=>setEditModal({show:true,item:{id:null,product_id:"",qty:1,customer_id:"",is_stock:true,tester:"",assembler:"",assembly_date:"",note:""}})}>+ æ–°å¢æ˜ç´°</button></div>
  </div>}</div>}</div>;
}

function TestingTab({products,staff,toast,reloadStaff}){
  const[orders,setOrders]=useState([]);const[items,setItems]=useState([]);const[sel,setSel]=useState(null);const[loading,setLoading]=useState(true);const[showForm,setShowForm]=useState(false);const[orderDate,setOrderDate]=useState(new Date().toISOString().slice(0,10));const[newItems,setNewItems]=useState([{product_id:"",qty:1,tester:"",note:""}]);
  const[staffModal,setStaffModal]=useState(false);
  const load=useCallback(async()=>{setLoading(true);try{setOrders(await supaFetchAll("testing_orders","select=*&order=order_date.desc,created_at.desc")||[]);}catch(e){}setLoading(false);},[]);
  useEffect(()=>{load();},[load]);
  const loadItems=async id=>{try{setItems(await supaFetchAll("testing_items",`select=*,products(product_id,product_name)&order_id=eq.${id}`)||[]);setSel(id);}catch(e){}};
  const create=async()=>{const valid=newItems.filter(it=>it.product_id&&it.qty>0);if(!valid.length){toast("è«‹è‡³å°‘æ–°å¢ä¸€å€‹ç”¢å“","error");return;}try{const[order]=await supaFetch("testing_orders",{method:"POST",body:{order_date:orderDate,status:"draft"}});for(const it of valid)await supaFetch("testing_items",{method:"POST",body:{order_id:order.id,product_id:it.product_id,qty:parseInt(it.qty),tester:it.tester,note:it.note}});toast("æ¸¬è©¦å–®å»ºç«‹æˆåŠŸï¼å–®è™Ÿ: "+order.order_no,"success");setShowForm(false);setNewItems([{product_id:"",qty:1,tester:"",note:""}]);load();}catch(e){toast("å»ºç«‹å¤±æ•—: "+e.message,"error");}};
  const addStaff=async(name,role,code)=>{try{await supaFetch("staff",{method:"POST",body:{name,role,code:code||null}});toast(`äººå“¡ã€Œ${name}ã€æ–°å¢æˆåŠŸ`,"success");reloadStaff();}catch(e){toast("æ–°å¢å¤±æ•—: "+e.message,"error");}};
  const deleteItem=async(it)=>{if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†æ˜ç´°ï¼Ÿæ­¤æ“ä½œä¸å¯å¾©åŸã€‚"))return;try{await supaDelete("testing_items",`id=eq.${it.id}`);toast("å·²åˆªé™¤","success");const remaining=await supaFetch("testing_items",{query:`select=id&order_id=eq.${sel}&limit=1`});if(!remaining||remaining.length===0){if(confirm("æ­¤å–®æ“šå·²ç„¡æ˜ç´°ï¼Œæ˜¯å¦ä¸€ä½µåˆªé™¤æ•´å¼µå–®æ“šï¼Ÿ")){await supaDelete("testing_orders",`id=eq.${sel}`);setSel(null);load();return;}}loadItems(sel);}catch(e){toast("åˆªé™¤å¤±æ•—: "+e.message,"error");}};
  const selOrder=orders.find(o=>o.id===sel);
  const sC={draft:"neutral",submitted:"info",approved:"success",rejected:"error"};const sL={draft:"è‰ç¨¿",submitted:"å·²é€ç°½",approved:"å·²æ ¸å‡†",rejected:"å·²é€€å›"};
  return <div><AddStaffModal show={staffModal} defaultRole="tester" onClose={()=>setStaffModal(false)} onSave={addStaff}/><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}><span style={{fontSize:12,color:"var(--muted)"}}>å…± {orders.length} ç­†æ¸¬è©¦å–®</span><button className="btn btn-primary" onClick={()=>setShowForm(!showForm)}>{showForm?"å–æ¶ˆ":"+ æ–°å¢æ¸¬è©¦å–®"}</button></div>
  {showForm&&<div className="form-box"><div className="form-title">æ–°å¢æ¸¬è©¦å–®</div><div className="form-row" style={{marginBottom:12}}><span className="filter-label">æ¸¬è©¦æ—¥æœŸï¼š</span><input type="date" className="input" value={orderDate} onChange={e=>setOrderDate(e.target.value)} style={{width:160}}/></div>{newItems.map((it,idx)=><div key={idx} className="form-row"><ProductSearch products={products} value={it.product_id} onChange={v=>{const n=[...newItems];n[idx].product_id=v;setNewItems(n);}} style={{minWidth:240,flex:2}}/><input type="number" className="input" style={{width:65}} min="1" value={it.qty} onChange={e=>{const n=[...newItems];n[idx].qty=e.target.value;setNewItems(n);}} placeholder="æ•¸é‡"/><StaffSelect staff={staff} value={it.tester} onChange={v=>{const n=[...newItems];n[idx].tester=v;setNewItems(n);}} onAdd={()=>setStaffModal(true)} roleFilter="tester" placeholder="æ¸¬è©¦äººå“¡" multi style={{width:180}}/><input className="input" style={{flex:1,minWidth:80}} value={it.note} onChange={e=>{const n=[...newItems];n[idx].note=e.target.value;setNewItems(n);}} placeholder="å‚™è¨»"/>{newItems.length>1&&<button className="btn btn-secondary btn-sm" style={{color:"var(--danger)"}} onClick={()=>setNewItems(newItems.filter((_,i)=>i!==idx))}>âœ•</button>}</div>)}<div style={{display:"flex",gap:8,marginTop:10}}><button className="btn btn-secondary btn-sm" onClick={()=>setNewItems([...newItems,{product_id:"",qty:1,tester:"",note:""}])}>+ æ–°å¢ç”¢å“è¡Œ</button><button className="btn btn-primary" onClick={create}>ç¢ºèªå»ºç«‹</button></div></div>}
  {loading?<div className="spinner"/>:<div className="split-view"><div className="split-left">{orders.map(o=><div key={o.id} className={`order-card ${sel===o.id?"selected":""}`} onClick={()=>loadItems(o.id)}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><code className="order-no">{o.order_no}</code><Badge type={sC[o.status]}>{sL[o.status]}</Badge></div><div className="order-date">ğŸ“… {o.order_date}</div></div>)}{!orders.length&&<div style={{textAlign:"center",padding:30,color:"var(--muted)"}}>å°šç„¡æ¸¬è©¦å–®</div>}</div>{sel&&<div className="split-right">{selOrder&&selOrder.status==="draft"&&<div style={{display:"flex",gap:8,marginBottom:10}}><button className="btn btn-secondary btn-sm" style={{color:"var(--danger)"}} onClick={()=>{if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤æ¸¬è©¦å–®ï¼Ÿ")){(async()=>{try{await supaDelete("testing_items",`order_id=eq.${sel}`);await supaDelete("testing_orders",`id=eq.${sel}`);toast("å·²åˆªé™¤","success");setSel(null);load();}catch(e){toast("åˆªé™¤å¤±æ•—: "+e.message,"error");}})();}}}>ğŸ—‘ åˆªé™¤</button></div>}<div className="table-wrap"><table><thead><tr>{["ç”¢å“ç·¨è™Ÿ","ç”¢å“åç¨±","æ¸¬è©¦æ•¸é‡","æ¸¬è©¦äººå“¡","çµæœ","å‚™è¨»",""].map(h=><th key={h}>{h}</th>)}</tr></thead><tbody>{items.map(it=><tr key={it.id}><td><code style={{fontWeight:600}}>{it.products?.product_id}</code></td><td>{it.products?.product_name}</td><td style={{fontWeight:700,fontFamily:"'JetBrains Mono',monospace"}}>{it.qty}</td><td>{it.tester||"-"}</td><td><Badge type={it.test_result==="pass"?"success":it.test_result==="fail"?"error":"neutral"}>{it.test_result==="pass"?"é€šé":it.test_result==="fail"?"ä¸åˆæ ¼":"å¾…æ¸¬è©¦"}</Badge></td><td>{it.note||"-"}</td><td><button className="btn-edit" style={{borderColor:"var(--danger)",color:"var(--danger)"}} onClick={()=>deleteItem(it)}>åˆªé™¤</button></td></tr>)}</tbody></table></div></div>}</div>}</div>;
}

function ConversionTab({products,toast}){
  const[orders,setOrders]=useState([]);const[sel,setSel]=useState(null);const[loading,setLoading]=useState(true);
  const[showForm,setShowForm]=useState(false);
  const[form,setForm]=useState({conversion_date:new Date().toISOString().slice(0,10),from_product_id:"",to_product_id:"",qty:1,reason:"",note:""});
  const load=useCallback(async()=>{setLoading(true);try{setOrders(await supaFetchAll("conversion_orders","select=*,from_product:products!from_product_id(product_id,product_name),to_product:products!to_product_id(product_id,product_name)&order=conversion_date.desc,created_at.desc")||[]);}catch(e){console.error(e);}setLoading(false);},[]);
  useEffect(()=>{load();},[load]);
  const create=async()=>{
    if(!form.from_product_id){toast("è«‹é¸æ“‡ä¾†æºç”¢å“","error");return;}
    if(!form.to_product_id){toast("è«‹é¸æ“‡ç›®æ¨™ç”¢å“","error");return;}
    if(form.from_product_id===form.to_product_id){toast("ä¾†æºèˆ‡ç›®æ¨™ç”¢å“ä¸èƒ½ç›¸åŒ","error");return;}
    if(!form.qty||parseInt(form.qty)<=0){toast("æ•¸é‡å¿…é ˆå¤§æ–¼ 0","error");return;}
    try{
      const[order]=await supaFetch("conversion_orders",{method:"POST",body:{conversion_date:form.conversion_date,from_product_id:form.from_product_id,to_product_id:form.to_product_id,qty:parseInt(form.qty),reason:form.reason||null,note:form.note||null}});
      toast(`è½‰æ›å–®å»ºç«‹æˆåŠŸï¼å–®è™Ÿ: ${order.order_no}`,"success");
      setShowForm(false);setForm({conversion_date:new Date().toISOString().slice(0,10),from_product_id:"",to_product_id:"",qty:1,reason:"",note:""});load();
    }catch(e){toast("å»ºç«‹å¤±æ•—: "+e.message,"error");}
  };
  const complete=async(id)=>{try{await supaPatch("conversion_orders",`id=eq.${id}`,{status:"completed",completed_at:new Date().toISOString()});toast("å·²å®Œæˆ","success");load();}catch(e){toast("æ“ä½œå¤±æ•—: "+e.message,"error");}};
  const cancel=async(id)=>{if(!confirm("ç¢ºå®šè¦å–æ¶ˆæ­¤è½‰æ›å–®ï¼Ÿ"))return;try{await supaPatch("conversion_orders",`id=eq.${id}`,{status:"cancelled"});toast("å·²å–æ¶ˆ","success");load();}catch(e){toast("æ“ä½œå¤±æ•—: "+e.message,"error");}};
  const sC={pending:"warning",completed:"success",cancelled:"error"};const sL={pending:"å¾…è™•ç†",completed:"å·²å®Œæˆ",cancelled:"å·²å–æ¶ˆ"};
  const selOrder=orders.find(o=>o.id===sel);
  return <div>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16,flexWrap:"wrap",gap:8}}>
      <span style={{fontSize:12,color:"var(--muted)"}}>å…± {orders.length} ç­†è½‰æ›å–®</span>
      <button className="btn btn-primary" onClick={()=>setShowForm(!showForm)}>{showForm?"å–æ¶ˆ":"+ æ–°å¢è½‰æ›å–®"}</button>
    </div>
    {showForm&&<div className="form-box"><div className="form-title">æ–°å¢æˆå“è½‰æ›å–®</div>
      <div className="form-row" style={{marginBottom:8}}><span className="filter-label">è½‰æ›æ—¥æœŸï¼š</span><input type="date" className="input" value={form.conversion_date} onChange={e=>setForm({...form,conversion_date:e.target.value})} style={{width:160}}/></div>
      <div className="form-row" style={{marginBottom:8}}>
        <span className="filter-label">ä¾†æºç”¢å“ï¼š</span><ProductSearch products={products} value={form.from_product_id} onChange={v=>setForm({...form,from_product_id:v})} style={{minWidth:240,flex:2}}/>
        <span className="filter-label" style={{marginLeft:12}}>ç›®æ¨™ç”¢å“ï¼š</span><ProductSearch products={products} value={form.to_product_id} onChange={v=>setForm({...form,to_product_id:v})} style={{minWidth:240,flex:2}}/>
      </div>
      <div className="form-row" style={{marginBottom:8}}>
        <span className="filter-label">æ•¸é‡ï¼š</span><input type="number" className="input" style={{width:80}} min="1" value={form.qty} onChange={e=>setForm({...form,qty:e.target.value})}/>
        <span className="filter-label" style={{marginLeft:12}}>è½‰æ›åŸå› ï¼š</span><input className="input" style={{flex:1}} value={form.reason} onChange={e=>setForm({...form,reason:e.target.value})} placeholder="ä¾‹ï¼šå‡ç´šã€å‹è™Ÿè®Šæ›´..."/>
      </div>
      <div className="form-row"><span className="filter-label">å‚™è¨»ï¼š</span><input className="input" style={{flex:1}} value={form.note} onChange={e=>setForm({...form,note:e.target.value})} placeholder="å‚™è¨»"/><button className="btn btn-primary" onClick={create}>ç¢ºèªå»ºç«‹</button></div>
    </div>}
    {loading?<div className="spinner"/>:<div className="split-view">
      <div className="split-left">{orders.map(o=><div key={o.id} className={`order-card ${sel===o.id?"selected":""}`} onClick={()=>setSel(o.id)}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><code className="order-no">{o.order_no}</code><Badge type={sC[o.status]}>{sL[o.status]}</Badge></div>
        <div className="order-date">ğŸ“… {o.conversion_date}</div>
        <div style={{fontSize:12,marginTop:4,color:"var(--text)"}}>{o.from_product?.product_id} â†’ {o.to_product?.product_id} Ã— <strong>{o.qty}</strong></div>
      </div>)}{!orders.length&&<div style={{textAlign:"center",padding:30,color:"var(--muted)"}}>å°šç„¡è½‰æ›å–®</div>}</div>
      {sel&&selOrder&&<div className="split-right"><div className="card" style={{padding:20}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
          <div><code className="order-no" style={{fontSize:18}}>{selOrder.order_no}</code><Badge type={sC[selOrder.status]} style={{marginLeft:8}}>{sL[selOrder.status]}</Badge></div>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px 24px",fontSize:13}}>
          <div><span style={{color:"var(--muted)"}}>è½‰æ›æ—¥æœŸ</span><div style={{fontWeight:600,marginTop:2}}>{selOrder.conversion_date}</div></div>
          <div><span style={{color:"var(--muted)"}}>æ•¸é‡</span><div style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:20,marginTop:2}}>{selOrder.qty}</div></div>
          <div><span style={{color:"var(--muted)"}}>ä¾†æºç”¢å“</span><div style={{fontWeight:600,marginTop:2}}><code>{selOrder.from_product?.product_id}</code> - {selOrder.from_product?.product_name}</div></div>
          <div><span style={{color:"var(--muted)"}}>ç›®æ¨™ç”¢å“</span><div style={{fontWeight:600,marginTop:2}}><code>{selOrder.to_product?.product_id}</code> - {selOrder.to_product?.product_name}</div></div>
          <div><span style={{color:"var(--muted)"}}>è½‰æ›åŸå› </span><div style={{marginTop:2}}>{selOrder.reason||"-"}</div></div>
          <div><span style={{color:"var(--muted)"}}>å‚™è¨»</span><div style={{marginTop:2}}>{selOrder.note||"-"}</div></div>
          <div><span style={{color:"var(--muted)"}}>å»ºç«‹æ™‚é–“</span><div style={{marginTop:2,fontSize:12}}>{selOrder.created_at?new Date(selOrder.created_at).toLocaleString("zh-TW",{hour12:false}):"-"}</div></div>
          {selOrder.completed_at&&<div><span style={{color:"var(--muted)"}}>å®Œæˆæ™‚é–“</span><div style={{marginTop:2,fontSize:12}}>{new Date(selOrder.completed_at).toLocaleString("zh-TW",{hour12:false})}</div></div>}
        </div>
        {selOrder.status==="pending"&&<div style={{display:"flex",gap:8,marginTop:20}}>
          <button className="btn btn-primary btn-sm" style={{background:"var(--success)"}} onClick={()=>complete(sel)}>âœ“ å®Œæˆ</button>
          <button className="btn btn-secondary btn-sm" style={{color:"var(--danger)"}} onClick={()=>cancel(sel)}>âœ• å–æ¶ˆ</button>
        </div>}
      </div></div>}
    </div>}
  </div>;
}

function ProductsTab({products,reload,toast}){
  const[showForm,setShowForm]=useState(false);const[form,setForm]=useState({product_id:"",product_name:"",category:"",spec:""});const[search,setSearch]=useState("");
  const create=async()=>{if(!form.product_id||!form.product_name){toast("è«‹å¡«å¯«ç”¢å“ç·¨è™Ÿå’Œåç¨±","error");return;}try{await supaFetch("products",{method:"POST",body:form});toast("ç”¢å“æ–°å¢æˆåŠŸ","success");setForm({product_id:"",product_name:"",category:"",spec:""});setShowForm(false);reload();}catch(e){toast("æ–°å¢å¤±æ•—: "+e.message,"error");}};
  const filtered=products.filter(p=>{if(!search)return true;const s=search.toLowerCase();return p.product_id.toLowerCase().includes(s)||p.product_name.toLowerCase().includes(s)||(p.category||"").toLowerCase().includes(s);});
  return <div><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16,flexWrap:"wrap",gap:8}}><div style={{display:"flex",alignItems:"center",gap:10}}><span style={{fontSize:12,color:"var(--muted)"}}>å…± {products.length} å€‹ç”¢å“</span><input className="input" style={{width:250}} placeholder="ğŸ” æœå°‹ç”¢å“..." value={search} onChange={e=>setSearch(e.target.value)}/>{search&&<span style={{fontSize:12,color:"var(--muted)"}}>æ‰¾åˆ° {filtered.length} ç­†</span>}</div><button className="btn btn-primary" onClick={()=>setShowForm(!showForm)}>{showForm?"å–æ¶ˆ":"+ æ–°å¢ç”¢å“"}</button></div>{showForm&&<div className="form-box"><div className="form-title">æ–°å¢ç”¢å“</div><div className="form-row"><input className="input" style={{width:150}} value={form.product_id} onChange={e=>setForm({...form,product_id:e.target.value})} placeholder="ç”¢å“ç·¨è™Ÿ"/><input className="input" style={{flex:1}} value={form.product_name} onChange={e=>setForm({...form,product_name:e.target.value})} placeholder="ç”¢å“åç¨±"/><input className="input" style={{width:80}} value={form.category} onChange={e=>setForm({...form,category:e.target.value})} placeholder="åˆ†é¡"/><input className="input" style={{flex:1}} value={form.spec} onChange={e=>setForm({...form,spec:e.target.value})} placeholder="è¦æ ¼"/><button className="btn btn-primary" onClick={create}>æ–°å¢</button></div></div>}<div className="table-wrap"><table><thead><tr>{["ç”¢å“ç·¨è™Ÿ","ç”¢å“åç¨±","åˆ†é¡"].map(h=><th key={h}>{h}</th>)}</tr></thead><tbody>{filtered.slice(0,200).map(p=><tr key={p.id}><td><code style={{fontWeight:600}}>{p.product_id}</code></td><td>{p.product_name}</td><td><Badge type="info">{p.category||"-"}</Badge></td></tr>)}{filtered.length>200&&<tr><td colSpan={3} style={{textAlign:"center",padding:10,color:"var(--muted)"}}>é¡¯ç¤ºå‰ 200 ç­†</td></tr>}</tbody></table></div></div>;
}

function StaffTab({staff,toast,reloadStaff}){
  const[showForm,setShowForm]=useState(false);const[form,setForm]=useState({name:"",role:"general",code:""});const[search,setSearch]=useState("");const[editingId,setEditingId]=useState(null);const[editForm,setEditForm]=useState({name:"",role:"",code:""});
  const roleLabels={assembler:"çµ„è£äººå“¡",tester:"æ¸¬è©¦äººå“¡",inspector:"æª¢é©—äººå“¡",general:"ä¸€èˆ¬"};const roleBadge={assembler:"info",tester:"warning",inspector:"success",general:"neutral"};
  const create=async()=>{if(!form.name.trim()){toast("è«‹å¡«å¯«å§“å","error");return;}try{await supaFetch("staff",{method:"POST",body:{name:form.name.trim(),role:form.role,code:form.code.trim()||null}});toast(`äººå“¡ã€Œ${form.name}ã€æ–°å¢æˆåŠŸ`,"success");setForm({name:"",role:"general",code:""});setShowForm(false);reloadStaff();}catch(e){toast("æ–°å¢å¤±æ•—: "+e.message,"error");}};
  const[editOriginal,setEditOriginal]=useState(null);
  const startEdit=(s)=>{const orig={name:s.name,role:s.role,code:s.code||""};setEditingId(s.id);setEditForm({...orig});setEditOriginal({...orig});};
  const saveEdit=async()=>{if(!editForm.name.trim()){toast("å§“åä¸èƒ½ç©ºç™½","error");return;}const patch={};if(editForm.name.trim()!==editOriginal.name)patch.name=editForm.name.trim();if(editForm.role!==editOriginal.role)patch.role=editForm.role;if((editForm.code||"").trim()!==(editOriginal.code||""))patch.code=editForm.code.trim()||null;if(Object.keys(patch).length===0){toast("ç„¡ä»»ä½•è®Šæ›´","warning");setEditingId(null);return;}try{await supaPatch("staff",`id=eq.${editingId}`,patch);toast("å·²ä¿®æ”¹","success");setEditingId(null);reloadStaff();}catch(e){toast("ä¿®æ”¹å¤±æ•—: "+e.message,"error");}};
  const deleteStaff=async(s)=>{if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${s.name}ã€ï¼Ÿ`))return;try{await supaPatch("staff",`id=eq.${s.id}`,{is_active:false});toast(`å·²åˆªé™¤ã€Œ${s.name}ã€`,"success");reloadStaff();}catch(e){toast("åˆªé™¤å¤±æ•—: "+e.message,"error");}};
  const filtered=staff.filter(s=>{if(!search)return true;const q=search.toLowerCase();return s.name.toLowerCase().includes(q)||(s.code||"").toLowerCase().includes(q)||(roleLabels[s.role]||"").includes(q);});
  return <div><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16,flexWrap:"wrap",gap:8}}><div style={{display:"flex",alignItems:"center",gap:10}}><span style={{fontSize:12,color:"var(--muted)"}}>å…± {staff.length} ä½äººå“¡</span><input className="input" style={{width:200}} placeholder="ğŸ” æœå°‹äººå“¡..." value={search} onChange={e=>setSearch(e.target.value)}/></div><button className="btn btn-primary" onClick={()=>setShowForm(!showForm)}>{showForm?"å–æ¶ˆ":"+ æ–°å¢äººå“¡"}</button></div>{showForm&&<div className="form-box"><div className="form-title">æ–°å¢äººå“¡</div><div className="form-row"><input className="input" style={{width:80}} value={form.code} onChange={e=>setForm({...form,code:e.target.value})} placeholder="ä»£è™Ÿ" onKeyDown={e=>e.key==="Enter"&&create()}/><input className="input" style={{flex:1}} value={form.name} onChange={e=>setForm({...form,name:e.target.value})} placeholder="å§“å" onKeyDown={e=>e.key==="Enter"&&create()}/><select className="input" style={{width:120}} value={form.role} onChange={e=>setForm({...form,role:e.target.value})}><option value="assembler">çµ„è£äººå“¡</option><option value="tester">æ¸¬è©¦äººå“¡</option><option value="inspector">æª¢é©—äººå“¡</option><option value="general">ä¸€èˆ¬</option></select><button className="btn btn-primary" onClick={create}>æ–°å¢</button></div></div>}<div className="table-wrap"><table><thead><tr><th style={{width:70}}>ä»£è™Ÿ</th><th>å§“å</th><th>è§’è‰²</th><th style={{width:120}}>æ“ä½œ</th></tr></thead><tbody>{filtered.map(s=><tr key={s.id}>{editingId===s.id?<><td><input className="input" style={{width:"100%",padding:"4px 8px"}} value={editForm.code} onChange={e=>setEditForm({...editForm,code:e.target.value})} placeholder="ä»£è™Ÿ"/></td><td><input className="input" style={{width:"100%",padding:"4px 8px"}} value={editForm.name} onChange={e=>setEditForm({...editForm,name:e.target.value})} onKeyDown={e=>e.key==="Enter"&&saveEdit()}/></td><td><select className="input" style={{width:"100%",padding:"4px 8px"}} value={editForm.role} onChange={e=>setEditForm({...editForm,role:e.target.value})}><option value="assembler">çµ„è£äººå“¡</option><option value="tester">æ¸¬è©¦äººå“¡</option><option value="inspector">æª¢é©—äººå“¡</option><option value="general">ä¸€èˆ¬</option></select></td><td><div style={{display:"flex",gap:4}}><button className="btn-edit" style={{background:"var(--primary)",color:"#fff",border:"none"}} onClick={saveEdit}>å„²å­˜</button><button className="btn-edit" onClick={()=>setEditingId(null)}>å–æ¶ˆ</button></div></td></>:<><td><code style={{fontWeight:700,color:"var(--primary)"}}>{s.code||"-"}</code></td><td style={{fontWeight:600}}>{s.name}</td><td><Badge type={roleBadge[s.role]}>{roleLabels[s.role]||s.role}</Badge></td><td><div style={{display:"flex",gap:4}}><button className="btn-edit" onClick={()=>startEdit(s)}>ä¿®æ”¹</button><button className="btn-edit" style={{borderColor:"var(--danger)",color:"var(--danger)"}} onClick={()=>deleteStaff(s)}>åˆªé™¤</button></div></td></>}</tr>)}</tbody></table></div></div>;
}

// ============================================================
// Customers Tab
// ============================================================
function CustomersTab({customers,toast,reloadCustomers}){
  const[showForm,setShowForm]=useState(false);const[form,setForm]=useState({customer_code:"",name:"",contact:"",phone:"",address:""});const[search,setSearch]=useState("");
  const[editingId,setEditingId]=useState(null);const[editForm,setEditForm]=useState({customer_code:"",name:"",contact:"",phone:"",address:""});const[editOriginal,setEditOriginal]=useState(null);
  const create=async()=>{if(!form.customer_code.trim()){toast("è«‹å¡«å¯«å®¢æˆ¶ç·¨ç¢¼","error");return;}if(!form.name.trim()){toast("è«‹å¡«å¯«å®¢æˆ¶åç¨±","error");return;}try{await supaFetch("customers",{method:"POST",body:{customer_code:form.customer_code.trim(),name:form.name.trim(),contact:form.contact||null,phone:form.phone||null,address:form.address||null}});toast(`å®¢æˆ¶ã€Œ${form.name}ã€æ–°å¢æˆåŠŸ`,"success");setForm({customer_code:"",name:"",contact:"",phone:"",address:""});setShowForm(false);reloadCustomers();}catch(e){toast("æ–°å¢å¤±æ•—: "+e.message,"error");}};
  const startEdit=(c)=>{const orig={customer_code:c.customer_code||"",name:c.name,contact:c.contact||"",phone:c.phone||"",address:c.address||""};setEditingId(c.id);setEditForm({...orig});setEditOriginal({...orig});};
  const saveEdit=async()=>{if(!editForm.customer_code.trim()){toast("å®¢æˆ¶ç·¨ç¢¼ä¸èƒ½ç©ºç™½","error");return;}if(!editForm.name.trim()){toast("åç¨±ä¸èƒ½ç©ºç™½","error");return;}const patch={};if(editForm.customer_code.trim()!==editOriginal.customer_code)patch.customer_code=editForm.customer_code.trim();if(editForm.name.trim()!==editOriginal.name)patch.name=editForm.name.trim();if((editForm.contact||null)!==(editOriginal.contact||null))patch.contact=editForm.contact||null;if((editForm.phone||null)!==(editOriginal.phone||null))patch.phone=editForm.phone||null;if((editForm.address||null)!==(editOriginal.address||null))patch.address=editForm.address||null;if(Object.keys(patch).length===0){toast("ç„¡ä»»ä½•è®Šæ›´","warning");setEditingId(null);return;}try{await supaPatch("customers",`id=eq.${editingId}`,patch);toast("å·²ä¿®æ”¹","success");setEditingId(null);reloadCustomers();}catch(e){toast("ä¿®æ”¹å¤±æ•—: "+e.message,"error");}};
  const deleteCustomer=async(c)=>{if(!confirm(`ç¢ºå®šè¦åˆªé™¤å®¢æˆ¶ã€Œ${c.name}ã€ï¼Ÿ`))return;try{await supaPatch("customers",`id=eq.${c.id}`,{is_active:false});toast(`å·²åˆªé™¤ã€Œ${c.name}ã€`,"success");reloadCustomers();}catch(e){toast("åˆªé™¤å¤±æ•—: "+e.message,"error");}};
  const filtered=customers.filter(c=>{if(!search)return true;const q=search.toLowerCase();return(c.customer_code||"").toLowerCase().includes(q)||c.name.toLowerCase().includes(q)||(c.contact||"").toLowerCase().includes(q)||(c.phone||"").includes(q);});
  return <div><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16,flexWrap:"wrap",gap:8}}><div style={{display:"flex",alignItems:"center",gap:10}}><span style={{fontSize:12,color:"var(--muted)"}}>å…± {customers.length} ä½å®¢æˆ¶</span><input className="input" style={{width:200}} placeholder="ğŸ” æœå°‹å®¢æˆ¶..." value={search} onChange={e=>setSearch(e.target.value)}/></div><button className="btn btn-primary" onClick={()=>setShowForm(!showForm)}>{showForm?"å–æ¶ˆ":"+ æ–°å¢å®¢æˆ¶"}</button></div>
  {showForm&&<div className="form-box"><div className="form-title">æ–°å¢å®¢æˆ¶</div><div className="form-row"><input className="input" style={{width:120}} value={form.customer_code} onChange={e=>setForm({...form,customer_code:e.target.value})} placeholder="å®¢æˆ¶ç·¨ç¢¼ *"/><input className="input" style={{flex:1}} value={form.name} onChange={e=>setForm({...form,name:e.target.value})} placeholder="å®¢æˆ¶åç¨± *" onKeyDown={e=>e.key==="Enter"&&create()}/><input className="input" style={{width:120}} value={form.contact} onChange={e=>setForm({...form,contact:e.target.value})} placeholder="è¯çµ¡äºº"/><input className="input" style={{width:130}} value={form.phone} onChange={e=>setForm({...form,phone:e.target.value})} placeholder="é›»è©±"/><input className="input" style={{flex:1}} value={form.address} onChange={e=>setForm({...form,address:e.target.value})} placeholder="åœ°å€"/><button className="btn btn-primary" onClick={create}>æ–°å¢</button></div></div>}
  <div className="table-wrap"><table><thead><tr><th>å®¢æˆ¶ç·¨ç¢¼</th><th>å®¢æˆ¶åç¨±</th><th>è¯çµ¡äºº</th><th>é›»è©±</th><th>åœ°å€</th><th style={{width:120}}>æ“ä½œ</th></tr></thead><tbody>{filtered.map(c=><tr key={c.id}>{editingId===c.id?<><td><input className="input" style={{width:"100%",padding:"4px 8px"}} value={editForm.customer_code} onChange={e=>setEditForm({...editForm,customer_code:e.target.value})}/></td><td><input className="input" style={{width:"100%",padding:"4px 8px"}} value={editForm.name} onChange={e=>setEditForm({...editForm,name:e.target.value})} onKeyDown={e=>e.key==="Enter"&&saveEdit()}/></td><td><input className="input" style={{width:"100%",padding:"4px 8px"}} value={editForm.contact} onChange={e=>setEditForm({...editForm,contact:e.target.value})}/></td><td><input className="input" style={{width:"100%",padding:"4px 8px"}} value={editForm.phone} onChange={e=>setEditForm({...editForm,phone:e.target.value})}/></td><td><input className="input" style={{width:"100%",padding:"4px 8px"}} value={editForm.address} onChange={e=>setEditForm({...editForm,address:e.target.value})}/></td><td><div style={{display:"flex",gap:4}}><button className="btn-edit" style={{background:"var(--primary)",color:"#fff",border:"none"}} onClick={saveEdit}>å„²å­˜</button><button className="btn-edit" onClick={()=>setEditingId(null)}>å–æ¶ˆ</button></div></td></>:<><td><code style={{fontWeight:600}}>{c.customer_code||"-"}</code></td><td style={{fontWeight:600}}>{c.name}</td><td>{c.contact||"-"}</td><td>{c.phone||"-"}</td><td style={{fontSize:12}}>{c.address||"-"}</td><td><div style={{display:"flex",gap:4}}><button className="btn-edit" onClick={()=>startEdit(c)}>ä¿®æ”¹</button><button className="btn-edit" style={{borderColor:"var(--danger)",color:"var(--danger)"}} onClick={()=>deleteCustomer(c)}>åˆªé™¤</button></div></td></>}</tr>)}</tbody></table></div></div>;
}

// ============================================================
// Dashboard
// ============================================================
function DashboardTab({toast,onNavigate}){
  const today=new Date().toISOString().slice(0,10);
  const[stats,setStats]=useState({asmQty:0,pkgQty:0,asmOrders:0,pkgOrders:0,anomalies:0,totalProducts:0});
  const[weekData,setWeekData]=useState([]);
  const[recentAnomalies,setRecentAnomalies]=useState([]);
  const[loading,setLoading]=useState(true);
  const[expandedRow,setExpandedRow]=useState(null);const[expandData,setExpandData]=useState({asm:[],pkg:[],cnv:[]});
  const[orderModal,setOrderModal]=useState({show:false,orderNo:null,orderType:null});
  const[activeCard,setActiveCard]=useState(null);const[cardOrders,setCardOrders]=useState([]);const[cardLoading,setCardLoading]=useState(false);
  const[cardSearch,setCardSearch]=useState("");const[cardStatusFilter,setCardStatusFilter]=useState("");
  const[cardPage,setCardPage]=useState(1);const[cardPageSize,setCardPageSize]=useState(50);
  const d30=new Date(Date.now()-30*86400000).toISOString().slice(0,10);
  const toggleDetail=async(row)=>{const rowKey=typeof row==="string"?row:row.product_code;if(expandedRow===rowKey){setExpandedRow(null);return;}setExpandedRow(rowKey);try{const pid=typeof row==="string"?null:row.product_id;setExpandData(await loadDetailItems(rowKey,d30,today,pid));}catch(e){console.error(e);setExpandData({asm:[],pkg:[],cnv:[]});}};

  const handleCardClick=async(cardKey)=>{
    if(activeCard===cardKey){setActiveCard(null);setCardOrders([]);return;}
    setActiveCard(cardKey);setCardLoading(true);setCardSearch("");setCardStatusFilter("");setCardPage(1);
    try{
      if(cardKey==="products"){
        try{const rec=await supaRpc("fn_reconcile_by_date_range",{p_date_from:d30,p_date_to:today});setCardOrders(rec||[]);}catch(e){setCardOrders([]);}
      }else if(cardKey==="asm"){
        const data=await supaFetch("assembly_orders",{query:`select=*,assembly_items(*,products(product_id,product_name))&order_date=eq.${today}&order=created_at.desc`});
        setCardOrders(data||[]);
      }else if(cardKey==="pkg"){
        const data=await supaFetch("packaging_orders",{query:`select=*,packaging_items(*,products(product_id,product_name)),customers(name,customer_code)&order_date=eq.${today}&order=created_at.desc`});
        setCardOrders(data||[]);
      }else if(cardKey==="orders"){
        const[asm,pkg]=await Promise.all([
          supaFetch("assembly_orders",{query:`select=*,assembly_items(qty)&order_date=eq.${today}&order=created_at.desc`}),
          supaFetch("packaging_orders",{query:`select=*,packaging_items(qty),customers(name)&order_date=eq.${today}&order=created_at.desc`})
        ]);
        const combined=[...(asm||[]).map(o=>({...o,_type:"assembly",_totalQty:(o.assembly_items||[]).reduce((s,i)=>s+(i.qty||0),0)})),...(pkg||[]).map(o=>({...o,_type:"packaging",_totalQty:(o.packaging_items||[]).reduce((s,i)=>s+(i.qty||0),0)}))];
        combined.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
        setCardOrders(combined);
      }else if(cardKey==="anomalies"){
        try{
          const rec=await supaRpc("fn_reconcile_by_date_range",{p_date_from:d30,p_date_to:today});
          const unresolved=(rec||[]).filter(r=>r.status!=="matched"&&!r.hidden&&!r.resolved_at);
          setCardOrders(unresolved);
        }catch(e){setCardOrders(recentAnomalies);}
      }
    }catch(e){console.error(e);setCardOrders([]);}
    setCardLoading(false);
  };

  useEffect(()=>{(async()=>{setLoading(true);try{
    // today stats â€” parallel queries
    const[asmItems,pkgItems,asmOrders,pkgOrders]=await Promise.all([
      supaFetch("assembly_items",{query:`select=qty,assembly_orders!inner(order_date)&assembly_orders.order_date=eq.${today}`}),
      supaFetch("packaging_items",{query:`select=qty,packaging_orders!inner(order_date)&packaging_orders.order_date=eq.${today}`}),
      supaFetch("assembly_orders",{query:`select=id&order_date=eq.${today}`}),
      supaFetch("packaging_orders",{query:`select=id&order_date=eq.${today}`})
    ]);
    const asmQty=(asmItems||[]).reduce((s,r)=>s+(r.qty||0),0);
    const pkgQty=(pkgItems||[]).reduce((s,r)=>s+(r.qty||0),0);

    // anomalies â€” past 30 days
    const d30=new Date(Date.now()-30*86400000).toISOString().slice(0,10);
    let anomalyCount=0;let recentAnom=[];let totalProducts=0;
    try{
      const rec=await supaRpc("fn_reconcile_by_date_range",{p_date_from:d30,p_date_to:today});
      totalProducts=(rec||[]).length;
      const unresolved=(rec||[]).filter(r=>r.status!=="matched"&&!r.hidden&&!r.resolved_at);
      anomalyCount=unresolved.length;
      recentAnom=unresolved.slice(0,5);
    }catch(e){console.error("Dashboard RPC error:",e);}

    setStats({asmQty,pkgQty,asmOrders:(asmOrders||[]).length,pkgOrders:(pkgOrders||[]).length,anomalies:anomalyCount,totalProducts});
    setRecentAnomalies(recentAnom);

    // week trend â€” Mon~Sun
    const now=new Date();const dow=now.getDay();const mondayOffset=dow===0?-6:1-dow;
    const monday=new Date(now);monday.setDate(now.getDate()+mondayOffset);
    const sunday=new Date(monday);sunday.setDate(monday.getDate()+6);
    const wFrom=monday.toISOString().slice(0,10);const wTo=sunday.toISOString().slice(0,10);
    const[wAsm,wPkg]=await Promise.all([
      supaFetch("assembly_items",{query:`select=qty,assembly_orders!inner(order_date)&assembly_orders.order_date=gte.${wFrom}&assembly_orders.order_date=lte.${wTo}`}),
      supaFetch("packaging_items",{query:`select=qty,packaging_orders!inner(order_date)&packaging_orders.order_date=gte.${wFrom}&packaging_orders.order_date=lte.${wTo}`})
    ]);
    const days=[];for(let i=0;i<7;i++){const d=new Date(monday);d.setDate(monday.getDate()+i);days.push(d.toISOString().slice(0,10));}
    const asmByDay={};const pkgByDay={};days.forEach(d=>{asmByDay[d]=0;pkgByDay[d]=0;});
    (wAsm||[]).forEach(r=>{const d=r.assembly_orders?.order_date;if(d&&asmByDay[d]!==undefined)asmByDay[d]+=r.qty||0;});
    (wPkg||[]).forEach(r=>{const d=r.packaging_orders?.order_date;if(d&&pkgByDay[d]!==undefined)pkgByDay[d]+=r.qty||0;});
    setWeekData(days.map(d=>({date:d,asm:asmByDay[d],pkg:pkgByDay[d]})));
  }catch(e){console.error(e);}setLoading(false);})();},[]);

  const dayLabels=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  const maxVal=Math.max(1,...weekData.map(d=>Math.max(d.asm,d.pkg)));

  const cardStyle={display:"flex",alignItems:"center",gap:14,background:"var(--surface)",border:"1px solid var(--border)",borderRadius:8,padding:"16px 20px",flex:1,minWidth:160};

  if(loading)return <div className="spinner"/>;
  return <div>
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))",gap:12,marginBottom:activeCard?12:24}}>
      {[{key:"asm",icon:"ğŸ”§",bg:"var(--accent)",value:stats.asmQty,label:"ä»Šæ—¥çµ„è£æ•¸é‡"},
        {key:"pkg",icon:"ğŸ“¦",bg:"var(--primary)",value:stats.pkgQty,label:"ä»Šæ—¥åŒ…è£æ•¸é‡"},
        {key:"orders",icon:"ğŸ“‹",bg:"#6B7280",value:`${stats.asmOrders} / ${stats.pkgOrders}`,label:"ä»Šæ—¥çµ„è£å–® / åŒ…è£å–®"},
        {key:"products",icon:"ğŸ“¦",bg:"#5B5EA6",value:stats.totalProducts,label:"ç¸½ç”¢å“æ•¸ (30å¤©)"},
        {key:"anomalies",icon:stats.anomalies>0?"âš ":"âœ“",bg:stats.anomalies>0?"var(--danger)":"var(--success)",value:stats.anomalies,label:"å¾…è™•ç†ç•°å¸¸"}
      ].map(c=><div key={c.key} style={{...cardStyle,cursor:"pointer",borderColor:activeCard===c.key?"var(--primary)":"var(--border)",boxShadow:activeCard===c.key?"0 0 0 2px var(--primary)":"none",transition:"all .2s"}} onClick={()=>handleCardClick(c.key)}>
        <div className="stat-icon" style={{background:c.bg}}>{c.icon}</div><div><div className="stat-value">{c.value}</div><div className="stat-label">{c.label}</div></div>
      </div>)}
    </div>

    {activeCard&&<div className="card" style={{marginBottom:24}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
        <div style={{fontWeight:700,fontSize:14}}>{
          activeCard==="asm"?"ä»Šæ—¥çµ„è£å–®æ“š":activeCard==="pkg"?"ä»Šæ—¥åŒ…è£å–®æ“š":activeCard==="orders"?"ä»Šæ—¥å…¨éƒ¨å–®æ“š":activeCard==="products"?"å…¨éƒ¨ç”¢å“æ ¸å°çµæœ (30å¤©)":"å¾…è™•ç†ç•°å¸¸"
        }{!cardLoading&&<span style={{fontWeight:400,fontSize:12,color:"var(--muted)",marginLeft:8}}>å…± {cardOrders.length} ç­†</span>}</div>
        <button className="btn btn-sm btn-secondary" style={{fontSize:12,padding:"2px 8px"}} onClick={()=>{setActiveCard(null);setCardOrders([]);}}>âœ• æ”¶èµ·</button>
      </div>
      {(activeCard==="products"||activeCard==="anomalies")&&!cardLoading&&<div style={{display:"flex",gap:8,marginBottom:10,flexWrap:"wrap",alignItems:"center"}} onClick={e=>e.stopPropagation()}>
        <input className="input" style={{width:200,padding:"5px 8px",fontSize:12}} placeholder="æœå°‹ç”¢å“ç·¨è™Ÿæˆ–åç¨±..." value={cardSearch} onChange={e=>{e.stopPropagation();setCardSearch(e.target.value);setCardPage(1);}} onClick={e=>e.stopPropagation()}/>
        {activeCard==="products"&&<select className="input" style={{width:130,padding:"5px 8px",fontSize:12}} value={cardStatusFilter} onChange={e=>{e.stopPropagation();setCardStatusFilter(e.target.value);setCardPage(1);}} onClick={e=>e.stopPropagation()}>
          <option value="">å…¨éƒ¨ç‹€æ…‹</option>
          <option value="matched">æ ¸å°ä¸€è‡´</option>
          <option value="wip_normal">åœ¨è£½å“</option>
          <option value="qty_mismatch">æ•¸é‡å·®ç•°</option>
          <option value="over_packaged">åŒ…è£è¶…å‡º</option>
          <option value="missing">æ¼å–®</option>
        </select>}
      </div>}
      {cardLoading?<div className="spinner"/>:cardOrders.length===0?<div style={{color:"var(--muted)",textAlign:"center",padding:24}}>æš«ç„¡è³‡æ–™</div>:
        (activeCard==="anomalies"||activeCard==="products")?(()=>{const statusMap2={missing_pkg:"error",missing_asm:"error",over_packaged:"error",qty_mismatch:"warning",wip_normal:"info",matched:"success"};
          const filteredCards=cardOrders.filter(r=>{
            if(cardSearch){const q=cardSearch.toLowerCase();if(!r.product_code.toLowerCase().includes(q)&&!(r.product_name||"").toLowerCase().includes(q))return false;}
            if(cardStatusFilter){if(cardStatusFilter==="missing")return r.status==="missing_pkg"||r.status==="missing_asm";return r.status===cardStatusFilter;}
            if(activeCard==="anomalies")return r.status!=="matched"&&!r.hidden&&!r.resolved_at;
            return true;
          });
          const cardTotalPages=Math.max(1,Math.ceil(filteredCards.length/cardPageSize));
          const cardSafePage=Math.min(cardPage,cardTotalPages);
          const pagedCards=filteredCards.slice((cardSafePage-1)*cardPageSize,cardSafePage*cardPageSize);
          return <><div className="table-wrap"><table><thead><tr><th style={{width:30}}></th><th>æ—¥æœŸ</th><th>ç”¢å“ç·¨è™Ÿ</th><th>ç”¢å“åç¨±</th><th style={{textAlign:"right"}}>çµ„è£æ•¸</th><th style={{textAlign:"right"}}>åŒ…è£æ•¸</th><th style={{textAlign:"right"}}>å·®ç•°</th><th>ç‹€æ…‹</th></tr></thead>
          <tbody>{pagedCards.map((r,i)=>{const isExp=expandedRow===r.product_code;return <React.Fragment key={i}>
            <tr className="clickable" onClick={()=>toggleDetail(r)}>
              <td style={{textAlign:"center",fontSize:16,color:"var(--muted)"}}>{isExp?"â–¼":"â–¶"}</td>
              <td style={{fontFamily:"'JetBrains Mono',monospace",fontSize:12,color:"var(--muted)"}}>{r.order_date||r.first_asm_date||r.first_pkg_date||"-"}</td>
              <td><code style={{fontWeight:600}}>{r.product_code}</code></td><td>{r.product_name}</td>
              <td style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:600,textAlign:"right"}}>{r.assembly_qty}</td>
              <td style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:600,textAlign:"right"}}>{r.packaging_qty}</td>
              <td style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,textAlign:"right",color:r.diff>0?"var(--danger)":r.diff<0?"var(--warning)":"var(--success)"}}>{r.diff>0?`+${r.diff}`:r.diff}</td>
              <td><Badge type={statusMap2[r.status]||"neutral"}>{r.status_desc}</Badge></td>
            </tr>
            {isExp&&<tr className="expand-row"><td colSpan={8}>
              <ExpandDetailSection expandData={expandData} onOrderClick={(no,type)=>setOrderModal({show:true,orderNo:no,orderType:type})}/>
              {expandData.cnv&&expandData.cnv.length>0&&<div className="expand-content" style={{paddingTop:0}}><div className="expand-section" style={{borderLeftColor:"#B8860B"}}><div className="expand-title">ğŸ”„ è½‰æ›è¨˜éŒ„ ({expandData.cnv.length}ç­†)</div><table className="expand-table"><thead><tr><th>å–®è™Ÿ</th><th>è½‰æ›æ—¥æœŸ</th><th>ä¾†æºç”¢å“</th><th>ç›®æ¨™ç”¢å“</th><th style={{textAlign:"right"}}>æ•¸é‡</th><th>ç‹€æ…‹</th><th>è½‰æ›åŸå› </th></tr></thead><tbody>{expandData.cnv.map(c=><tr key={c.id}><td><code style={{fontWeight:600,color:"#B8860B"}}>{c.order_no}</code></td><td>{c.conversion_date}</td><td>{c.from_product?.product_id} - {c.from_product?.product_name}</td><td>{c.to_product?.product_id} - {c.to_product?.product_name}</td><td className="qty-cell">{c.qty}</td><td><Badge type={c.status==="completed"?"success":c.status==="cancelled"?"error":"warning"}>{c.status==="completed"?"å·²å®Œæˆ":c.status==="cancelled"?"å·²å–æ¶ˆ":"å¾…è™•ç†"}</Badge></td><td>{c.reason||"-"}</td></tr>)}</tbody></table></div></div>}
            </td></tr>}
          </React.Fragment>;})}</tbody></table></div>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:10,fontSize:12,color:"var(--muted)",flexWrap:"wrap",gap:8}}>
            <span>é¡¯ç¤º {filteredCards.length>0?(cardSafePage-1)*cardPageSize+1:0}~{Math.min(cardSafePage*cardPageSize,filteredCards.length)} / {filteredCards.length} ç­† (å…± {cardOrders.length} ç­†)</span>
            <div style={{display:"flex",alignItems:"center",gap:8}}>
              <span>æ¯é </span>
              {[50,100].map(n=><button key={n} className={`btn btn-sm ${cardPageSize===n?"btn-primary":"btn-secondary"}`} style={{padding:"2px 8px",fontSize:11,minWidth:36}} onClick={()=>{setCardPageSize(n);setCardPage(1);}}>{n}</button>)}
              <span style={{margin:"0 4px"}}>ç­†</span>
              <button className="btn btn-sm btn-secondary" disabled={cardSafePage<=1} onClick={()=>setCardPage(p=>p-1)}>â† ä¸Šä¸€é </button>
              <span style={{fontWeight:600,color:"var(--text)"}}>ç¬¬ {cardSafePage}/{cardTotalPages} é </span>
              <button className="btn btn-sm btn-secondary" disabled={cardSafePage>=cardTotalPages} onClick={()=>setCardPage(p=>p+1)}>ä¸‹ä¸€é  â†’</button>
              <button className="btn btn-sm btn-secondary" onClick={()=>onNavigate("reconciliation")}>æŸ¥çœ‹å®Œæ•´æ ¸å°å ±å‘Š â†’</button>
            </div>
          </div></>})()
        :activeCard==="orders"?<div className="table-wrap"><table><thead><tr><th>å–®è™Ÿ</th><th>é¡å‹</th><th style={{textAlign:"right"}}>æ•¸é‡</th><th>ç‹€æ…‹</th></tr></thead>
          <tbody>{cardOrders.map((o,i)=><tr key={i} className="clickable" onClick={()=>setOrderModal({show:true,orderNo:o.order_no,orderType:o._type})}>
            <td><code style={{fontWeight:600,color:"var(--primary)"}}>{o.order_no}</code></td>
            <td><Badge type={o._type==="assembly"?"info":"default"}>{o._type==="assembly"?"çµ„è£å–®":"åŒ…è£å–®"}</Badge></td>
            <td style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:600,textAlign:"right"}}>{o._totalQty}</td>
            <td><Badge type={o.status==="approved"?"success":"warning"}>{o.status==="approved"?"å·²æ ¸å‡†":"è‰ç¨¿"}</Badge></td>
          </tr>)}</tbody></table></div>
        :<div className="table-wrap"><table><thead><tr><th>å–®è™Ÿ</th><th>ç”¢å“</th><th style={{textAlign:"right"}}>æ•¸é‡</th>{activeCard==="pkg"&&<th>å®¢æˆ¶</th>}<th>ç‹€æ…‹</th></tr></thead>
          <tbody>{cardOrders.map((o,i)=>{const items=activeCard==="asm"?o.assembly_items:o.packaging_items;return <React.Fragment key={i}>
            <tr className="clickable" onClick={()=>setOrderModal({show:true,orderNo:o.order_no,orderType:activeCard==="asm"?"assembly":"packaging"})}>
              <td><code style={{fontWeight:600,color:"var(--primary)"}}>{o.order_no}</code></td>
              <td>{(items||[]).map(it=>it.products?.product_id||"").filter(Boolean).join(", ")}</td>
              <td style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:600,textAlign:"right"}}>{(items||[]).reduce((s,it)=>s+(it.qty||0),0)}</td>
              {activeCard==="pkg"&&<td>{o.customers?.name||<span style={{color:"var(--muted)"}}>åº«å­˜</span>}</td>}
              <td><Badge type={o.status==="approved"?"success":"warning"}>{o.status==="approved"?"å·²æ ¸å‡†":"è‰ç¨¿"}</Badge></td>
            </tr>
          </React.Fragment>;})}</tbody></table></div>
      }
    </div>}

    <div className="card" style={{marginBottom:24}}>
      <div style={{fontWeight:700,fontSize:14,marginBottom:16}}>æœ¬é€±ç”¢é‡è¶¨å‹¢</div>
      <div style={{display:"flex",alignItems:"flex-end",gap:8,height:180,padding:"0 8px"}}>
        {weekData.map(d=>{const aH=Math.round((d.asm/maxVal)*150);const pH=Math.round((d.pkg/maxVal)*150);const dn=new Date(d.date);const label=`${dn.getMonth()+1}/${dn.getDate()}(${dayLabels[dn.getDay()]})`;const isToday=d.date===today;
        return <div key={d.date} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:4}}>
          <div style={{display:"flex",gap:3,alignItems:"flex-end",height:155}}>
            <div style={{width:18,height:Math.max(aH,2),background:isToday?"#1E6FBF":"var(--accent)",borderRadius:"3px 3px 0 0",position:"relative"}} title={`çµ„è£ ${d.asm}`}>{d.asm>0&&<span style={{position:"absolute",top:-16,left:"50%",transform:"translateX(-50%)",fontSize:10,fontWeight:700,color:"var(--accent)",whiteSpace:"nowrap"}}>{d.asm}</span>}</div>
            <div style={{width:18,height:Math.max(pH,2),background:isToday?"#15803D":"var(--primary)",borderRadius:"3px 3px 0 0",position:"relative"}} title={`åŒ…è£ ${d.pkg}`}>{d.pkg>0&&<span style={{position:"absolute",top:-16,left:"50%",transform:"translateX(-50%)",fontSize:10,fontWeight:700,color:"var(--primary)",whiteSpace:"nowrap"}}>{d.pkg}</span>}</div>
          </div>
          <div style={{fontSize:11,color:isToday?"var(--primary)":"var(--muted)",fontWeight:isToday?700:400}}>{label}</div>
        </div>;})}
      </div>
      <div style={{display:"flex",justifyContent:"center",gap:20,marginTop:12,fontSize:12,color:"var(--muted)"}}>
        <span><span style={{display:"inline-block",width:12,height:12,background:"var(--accent)",borderRadius:2,marginRight:4,verticalAlign:"middle"}}/> çµ„è£</span>
        <span><span style={{display:"inline-block",width:12,height:12,background:"var(--primary)",borderRadius:2,marginRight:4,verticalAlign:"middle"}}/> åŒ…è£</span>
      </div>
    </div>

    <OrderDetailModal show={orderModal.show} orderNo={orderModal.orderNo} orderType={orderModal.orderType} onClose={()=>setOrderModal({show:false,orderNo:null,orderType:null})}/>
    {recentAnomalies.length>0&&activeCard!=="anomalies"&&<div className="card">
      <div style={{fontWeight:700,fontSize:14,marginBottom:12}}>æœ€è¿‘ç•°å¸¸ï¼ˆå¾…è™•ç†ï¼‰</div>
      <div className="table-wrap"><table><thead><tr><th style={{width:30}}></th><th>ç”¢å“ç·¨è™Ÿ</th><th>ç”¢å“åç¨±</th><th style={{textAlign:"right"}}>çµ„è£æ•¸</th><th style={{textAlign:"right"}}>åŒ…è£æ•¸</th><th style={{textAlign:"right"}}>å·®ç•°</th><th>ç‹€æ…‹</th></tr></thead>
      <tbody>{recentAnomalies.map((r,i)=>{const isExp=expandedRow===r.product_code;return <React.Fragment key={i}>
        <tr className="clickable" onClick={()=>toggleDetail(r)}>
          <td style={{textAlign:"center",fontSize:16,color:"var(--muted)"}}>{isExp?"â–¼":"â–¶"}</td>
          <td><code style={{fontWeight:600}}>{r.product_code}</code></td><td>{r.product_name}</td>
          <td style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:600,textAlign:"right"}}>{r.assembly_qty}</td>
          <td style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:600,textAlign:"right"}}>{r.packaging_qty}</td>
          <td style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,textAlign:"right",color:r.diff>0?"var(--danger)":"var(--warning)"}}>{r.diff>0?`+${r.diff}`:r.diff}</td>
          <td><Badge type={r.status==="missing_pkg"||r.status==="missing_asm"||r.status==="over_packaged"?"error":r.status==="wip_normal"?"info":"warning"}>{r.status_desc}</Badge></td>
        </tr>
        {isExp&&<tr className="expand-row"><td colSpan={7}>
          <ExpandDetailSection expandData={expandData} onOrderClick={(no,type)=>setOrderModal({show:true,orderNo:no,orderType:type})}/>
          {expandData.cnv&&expandData.cnv.length>0&&<div className="expand-content" style={{paddingTop:0}}><div className="expand-section" style={{borderLeftColor:"#B8860B"}}><div className="expand-title">ğŸ”„ è½‰æ›è¨˜éŒ„ ({expandData.cnv.length}ç­†)</div><table className="expand-table"><thead><tr><th>å–®è™Ÿ</th><th>è½‰æ›æ—¥æœŸ</th><th>ä¾†æºç”¢å“</th><th>ç›®æ¨™ç”¢å“</th><th style={{textAlign:"right"}}>æ•¸é‡</th><th>ç‹€æ…‹</th><th>è½‰æ›åŸå› </th></tr></thead><tbody>{expandData.cnv.map(c=><tr key={c.id}><td><code style={{fontWeight:600,color:"#B8860B"}}>{c.order_no}</code></td><td>{c.conversion_date}</td><td>{c.from_product?.product_id} - {c.from_product?.product_name}</td><td>{c.to_product?.product_id} - {c.to_product?.product_name}</td><td className="qty-cell">{c.qty}</td><td><Badge type={c.status==="completed"?"success":c.status==="cancelled"?"error":"warning"}>{c.status==="completed"?"å·²å®Œæˆ":c.status==="cancelled"?"å·²å–æ¶ˆ":"å¾…è™•ç†"}</Badge></td><td>{c.reason||"-"}</td></tr>)}</tbody></table></div></div>}
        </td></tr>}
      </React.Fragment>;})}</tbody></table></div>
      <div style={{textAlign:"right",marginTop:8}}><button className="btn btn-sm btn-secondary" onClick={()=>onNavigate("reconciliation")}>æŸ¥çœ‹å®Œæ•´æ ¸å°å ±å‘Š â†’</button></div>
    </div>}
  </div>;
}

// ============================================================
// Edit Logs (æ“ä½œè¨˜éŒ„)
// ============================================================
function EditLogsTab({toast}){
  const today=new Date().toISOString().slice(0,10);
  const[dateFrom,setDateFrom]=useState(today);const[dateTo,setDateTo]=useState(today);
  const[tableFilter,setTableFilter]=useState("");
  const[logs,setLogs]=useState([]);const[loading,setLoading]=useState(true);
  const[page,setPage]=useState(0);const pageSize=50;const[total,setTotal]=useState(0);

  const load=useCallback(async()=>{setLoading(true);try{
    let q=`select=*&order=edited_at.desc&limit=${pageSize}&offset=${page*pageSize}`;
    if(dateFrom)q+=`&edited_at=gte.${dateFrom}T00:00:00`;
    if(dateTo)q+=`&edited_at=lte.${dateTo}T23:59:59`;
    if(tableFilter)q+=`&table_name=eq.${tableFilter}`;
    const data=await supaFetch("edit_logs",{query:q,headers:{"Prefer":"count=exact","Range-Unit":"items","Range":`${page*pageSize}-${(page+1)*pageSize-1}`}});
    setLogs(data||[]);
    // try to get total from header â€” fallback to data length
    setTotal(data?data.length+(page*pageSize):0);
  }catch(e){console.error(e);toast("è¼‰å…¥å¤±æ•—: "+e.message,"error");}setLoading(false);},[dateFrom,dateTo,tableFilter,page]);

  useEffect(()=>{load();},[load]);

  const search=()=>{setPage(0);load();};

  const tableNames=["assembly_items","packaging_items","testing_items","staff","customers","products"];
  const tableLabels={assembly_items:"çµ„è£æ˜ç´°",packaging_items:"åŒ…è£æ˜ç´°",testing_items:"æ¸¬è©¦æ˜ç´°",staff:"äººå“¡",customers:"å®¢æˆ¶",products:"ç”¢å“"};

  return <div>
    <div className="filter-bar">
      <span className="filter-label">æ—¥æœŸç¯„åœï¼š</span>
      <input type="date" className="input" value={dateFrom} onChange={e=>setDateFrom(e.target.value)}/>
      <span style={{color:"var(--muted)"}}>ï½</span>
      <input type="date" className="input" value={dateTo} onChange={e=>setDateTo(e.target.value)}/>
      <span className="filter-label">è³‡æ–™è¡¨ï¼š</span>
      <select className="input" value={tableFilter} onChange={e=>setTableFilter(e.target.value)}>
        <option value="">å…¨éƒ¨</option>
        {tableNames.map(t=><option key={t} value={t}>{tableLabels[t]||t}</option>)}
      </select>
      <button className="btn btn-primary" onClick={search}>æŸ¥è©¢</button>
      <button className="btn btn-secondary" onClick={()=>{setDateFrom(today);setDateTo(today);setTableFilter("");setPage(0);}}>é‡ç½®</button>
    </div>
    {loading?<div className="spinner"/>:logs.length===0?<div style={{textAlign:"center",padding:40,color:"var(--muted)"}}>ç„¡æ“ä½œè¨˜éŒ„</div>:
    <><div className="table-wrap"><table>
      <thead><tr><th>æ™‚é–“</th><th>æ“ä½œè€…</th><th>è³‡æ–™è¡¨</th><th>è¨˜éŒ„ ID</th><th>æ¬„ä½</th><th>èˆŠå€¼</th><th>æ–°å€¼</th><th>åŸå› </th></tr></thead>
      <tbody>{logs.map(l=><tr key={l.id}>
        <td style={{fontFamily:"'JetBrains Mono',monospace",fontSize:11,whiteSpace:"nowrap"}}>{l.edited_at?new Date(l.edited_at).toLocaleString("zh-TW",{hour12:false}):"-"}</td>
        <td style={{fontWeight:600}}>{l.edited_by||"-"}</td>
        <td><Badge type="info">{tableLabels[l.table_name]||l.table_name}</Badge></td>
        <td style={{fontFamily:"'JetBrains Mono',monospace",fontSize:11}}>{l.record_id?l.record_id.slice(0,8)+"...":"-"}</td>
        <td>{l.field_name||"-"}</td>
        <td style={{color:"var(--danger)",fontFamily:"'JetBrains Mono',monospace",fontSize:12}}>{l.old_value||"-"}</td>
        <td style={{color:"var(--primary)",fontFamily:"'JetBrains Mono',monospace",fontSize:12}}>{l.new_value||"-"}</td>
        <td style={{fontSize:12}}>{l.reason||"-"}</td>
      </tr>)}</tbody>
    </table></div>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:12,fontSize:12,color:"var(--muted)"}}>
      <span>ç¬¬ {page+1} é  Â· é¡¯ç¤º {page*pageSize+1}~{page*pageSize+logs.length} ç­†</span>
      <div style={{display:"flex",gap:6}}>
        <button className="btn btn-sm btn-secondary" disabled={page===0} onClick={()=>setPage(p=>p-1)}>â† ä¸Šä¸€é </button>
        <button className="btn btn-sm btn-secondary" disabled={logs.length<pageSize} onClick={()=>setPage(p=>p+1)}>ä¸‹ä¸€é  â†’</button>
      </div>
    </div></>}
  </div>;
}

const TABS=[{key:"dashboard",label:"å„€è¡¨æ¿",icon:"ğŸ“Š"},{key:"reconciliation",label:"æ ¸å°å ±å‘Š",icon:"ğŸ“‹"},{key:"assembly",label:"çµ„è£å–®",icon:"ğŸ”§"},{key:"packaging",label:"åŒ…è£å‡ºè²¨å…¥åº«",icon:"ğŸ“¦"},{key:"testing",label:"æ¸¬è©¦è¡¨",icon:"ğŸ§ª"},{key:"conversion",label:"æˆå“è½‰æ›",icon:"ğŸ”„"},{key:"products",label:"ç”¢å“ä¸»æª”",icon:"ğŸ­"},{key:"customers",label:"å®¢æˆ¶ç®¡ç†",icon:"ğŸ¢"},{key:"staff",label:"äººå“¡ç®¡ç†",icon:"ğŸ‘¥"},{key:"logs",label:"æ“ä½œè¨˜éŒ„",icon:"ğŸ“"}];

function App(){
  const[tab,setTab]=useState("dashboard");const[products,setProducts]=useState([]);const[customers,setCustomers]=useState([]);const[staff,setStaff]=useState([]);
  const[toastMsg,setToastMsg]=useState(null);const[toastType,setToastType]=useState("success");
  const toast=(msg,type="success")=>{setToastMsg(msg);setToastType(type);setTimeout(()=>setToastMsg(null),4000);};
  const loadProducts=useCallback(async()=>{try{setProducts(await supaFetchAll("products","select=*&is_active=eq.true&order=product_id")||[]);}catch(e){}},[]);
  const loadCustomers=useCallback(async()=>{try{setCustomers(await supaFetch("customers",{query:"select=*&is_active=eq.true&order=name"})||[]);}catch(e){}},[]);
  const loadStaff=useCallback(async()=>{try{setStaff(await supaFetch("staff",{query:"select=*&is_active=eq.true&order=name"})||[]);}catch(e){}},[]);
  useEffect(()=>{loadProducts();loadCustomers();loadStaff();},[loadProducts,loadCustomers,loadStaff]);
  return <div>
    <Toast message={toastMsg} type={toastType} onClose={()=>setToastMsg(null)}/>
    <div className="print-header"><h1>I-Reporter</h1><p></p></div>
    <div className="header"><div className="header-inner"><div style={{display:"flex",alignItems:"center",gap:12}}><div className="header-logo">âš™</div><div><div className="header-title">I-Reporter</div><div className="header-sub">æˆå“çµ„è£ Ã— åŒ…è£å…¥åº« Ã— æ¸¬è©¦ æ ¸å°ç³»çµ±</div></div></div><div style={{color:"rgba(255,255,255,.4)",fontSize:11,fontFamily:"'JetBrains Mono',monospace"}}>v1.7 Â· {products.length} products Â· {staff.length} staff</div></div></div>
    <div className="tab-bar"><div className="tab-bar-inner">{TABS.map(t=><button key={t.key} className={`tab-btn ${tab===t.key?"active":""}`} onClick={()=>setTab(t.key)}><span>{t.icon}</span>{t.label}</button>)}</div></div>
    <div className="content">
      {tab==="dashboard"&&<DashboardTab toast={toast} onNavigate={setTab}/>}
      {tab==="reconciliation"&&<ReconciliationTab products={products} customers={customers} staff={staff} toast={toast} reloadStaff={loadStaff}/>}
      {tab==="assembly"&&<AssemblyTab products={products} staff={staff} toast={toast} reloadStaff={loadStaff}/>}
      {tab==="packaging"&&<PackagingTab products={products} customers={customers} staff={staff} toast={toast} reloadStaff={loadStaff}/>}
      {tab==="testing"&&<TestingTab products={products} staff={staff} toast={toast} reloadStaff={loadStaff}/>}
      {tab==="conversion"&&<ConversionTab products={products} toast={toast}/>}
      {tab==="products"&&<ProductsTab products={products} reload={loadProducts} toast={toast}/>}
      {tab==="staff"&&<StaffTab staff={staff} toast={toast} reloadStaff={loadStaff}/>}
      {tab==="customers"&&<CustomersTab customers={customers} toast={toast} reloadCustomers={loadCustomers}/>}
      {tab==="logs"&&<EditLogsTab toast={toast}/>}
    </div>
    <div className="footer">I-Reporter v1.7 Â· æˆå“çµ„è£ Ã— åŒ…è£å…¥åº« Ã— æ¸¬è©¦ æ ¸å°ç³»çµ±</div>
  </div>;
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>