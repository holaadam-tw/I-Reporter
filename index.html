<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>I-Reporter v1.5 | æˆå“çµ„è£ Ã— åŒ…è£å…¥åº« æ ¸å°ç³»çµ±</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#F0EDE6;--surface:#FAFAF7;--border:#D8D3CA;--text:#2C2A26;--muted:#8A857C;--primary:#1A6B4E;--primary-light:#E8F5EE;--primary-dark:#0F4030;--danger:#C4362C;--danger-light:#FDF0EF;--warning:#B8860B;--warning-light:#FFF8E7;--success:#1A6B4E;--success-light:#E8F5EE;--accent:#2D5F8A}
body{font-family:'Noto Sans TC','Helvetica Neue',sans-serif;background:var(--bg);color:var(--text);font-size:14px}
code{font-family:'JetBrains Mono',monospace}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

.header{background:var(--primary-dark);border-bottom:3px solid var(--primary)}
.header-inner{max-width:1400px;margin:0 auto;padding:14px 24px;display:flex;align-items:center;justify-content:space-between}
.header-logo{width:38px;height:38px;border-radius:8px;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:18px}
.header-title{color:#fff;font-size:17px;font-weight:700;letter-spacing:.02em}
.header-sub{color:rgba(255,255,255,.5);font-size:11px}

.tab-bar{background:var(--surface);border-bottom:1px solid var(--border)}
.tab-bar-inner{max-width:1400px;margin:0 auto;padding:0 24px;display:flex;gap:0;overflow-x:auto}
.tab-btn{padding:12px 20px;border:none;background:none;cursor:pointer;font-size:13px;font-weight:500;color:var(--muted);border-bottom:3px solid transparent;transition:all .15s;display:flex;align-items:center;gap:6px;white-space:nowrap;font-family:inherit}
.tab-btn.active{font-weight:700;color:var(--primary);border-bottom-color:var(--primary)}
.tab-btn:hover{color:var(--primary)}

.content{max-width:1400px;margin:0 auto;padding:20px 24px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;transition:all .15s}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-bottom:20px}
.stat-card{display:flex;align-items:center;gap:14px;cursor:pointer;user-select:none}
.stat-card:hover{border-color:var(--primary);transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.06)}
.stat-card.active{border-width:2px;box-shadow:0 2px 12px rgba(0,0,0,.1)}
.stat-icon{width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff;flex-shrink:0}
.stat-value{font-size:26px;font-weight:700;font-family:'JetBrains Mono',monospace}
.stat-label{font-size:12px;color:var(--muted)}

.badge{display:inline-flex;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;white-space:nowrap}
.badge-error{background:var(--danger-light);color:var(--danger);border:1px solid rgba(196,54,44,.2)}
.badge-warning{background:var(--warning-light);color:var(--warning);border:1px solid rgba(184,134,11,.2)}
.badge-success{background:var(--success-light);color:var(--success);border:1px solid rgba(26,107,78,.2)}
.badge-info{background:#EDF4FA;color:var(--accent);border:1px solid rgba(45,95,138,.2)}
.badge-neutral{background:#F0EDE6;color:var(--muted);border:1px solid var(--border)}

table{width:100%;border-collapse:collapse;font-size:13px}
thead tr{background:var(--primary-dark)}
thead th{padding:10px 10px;color:#fff;font-weight:600;text-align:left;font-size:12px;cursor:pointer;user-select:none;white-space:nowrap}
thead th:hover{background:rgba(255,255,255,.1)}
thead th .sort-arrow{margin-left:4px;font-size:10px;opacity:.6}
thead th.sorted .sort-arrow{opacity:1}
tbody td{padding:8px 10px;color:var(--text)}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
tbody tr:nth-child(even){background:var(--surface)}
tbody tr:nth-child(odd){background:#fff}
tbody tr:hover{background:var(--primary-light)}
tbody tr.clickable{cursor:pointer}
.table-wrap{border:1px solid var(--border);border-radius:8px;overflow:hidden;overflow-x:auto}

.expand-row{background:#f8f7f4!important;animation:fadeIn .2s}
.expand-row td{padding:0}
.expand-content{padding:12px 16px}
.expand-section{margin-bottom:12px}
.expand-title{font-size:12px;font-weight:700;color:var(--primary);margin-bottom:6px;display:flex;align-items:center;gap:6px}
.expand-table{width:100%;font-size:12px;border:1px solid var(--border);border-radius:6px;overflow:hidden}
.expand-table thead tr{background:var(--accent)}
.expand-table thead th{padding:6px 8px;font-size:11px;cursor:default}
.expand-table tbody td{padding:6px 8px;font-size:12px}

.btn{padding:7px 16px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;font-family:inherit;transition:all .15s}
.btn-primary{border:none;background:var(--primary);color:#fff}
.btn-primary:hover{background:var(--primary-dark)}
.btn-secondary{border:1px solid var(--border);background:var(--surface);color:var(--text)}
.btn-sm{padding:4px 10px;font-size:12px}
.btn-edit{padding:2px 8px;font-size:11px;border:1px solid var(--accent);background:#EDF4FA;color:var(--accent);border-radius:4px;cursor:pointer;font-weight:600}
.btn-edit:hover{background:var(--accent);color:#fff}

.input{padding:7px 10px;border-radius:6px;border:1px solid var(--border);font-size:13px;color:var(--text);background:#fff;outline:none;font-family:inherit;transition:border .15s}
.input:focus{border-color:var(--primary);box-shadow:0 0 0 2px rgba(26,107,78,.12)}
select.input{cursor:pointer}

.form-box{background:var(--surface);border:2px solid rgba(26,107,78,.2);border-radius:8px;padding:16px;margin-bottom:16px;animation:fadeIn .2s}
.form-title{font-weight:700;margin-bottom:12px;color:var(--primary);font-size:14px}
.form-row{display:flex;gap:6px;margin-bottom:6px;align-items:center;flex-wrap:wrap}

.order-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px 16px;margin-bottom:6px;cursor:pointer;transition:all .15s}
.order-card:hover,.order-card.selected{border-color:var(--primary);background:var(--primary-light)}
.order-no{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:14px}
.order-date{font-size:12px;color:var(--muted);margin-top:2px}

.split-view{display:flex;gap:16px}
.split-left{flex:1;min-width:0;max-height:70vh;overflow-y:auto}
.split-right{flex:1.8;min-width:0}

.search-select{position:relative;display:inline-block}
.search-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--border);border-radius:0 0 6px 6px;max-height:200px;overflow-y:auto;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,.1)}
.search-dropdown-item{padding:6px 10px;cursor:pointer;font-size:13px;border-bottom:1px solid #f0f0f0}
.search-dropdown-item:hover{background:var(--primary-light)}
.search-dropdown-item code{font-size:12px;color:var(--muted);margin-right:6px}

.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite;margin:50px auto}
.toast{position:fixed;top:16px;right:16px;padding:10px 18px;border-radius:8px;color:#fff;font-size:13px;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,.15);display:flex;align-items:center;gap:10px;max-width:400px;animation:fadeIn .2s}
.toast-close{background:none;border:none;color:#fff;font-size:16px;cursor:pointer;padding:0}
.filter-bar{display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.filter-label{font-size:12px;color:var(--muted);font-weight:600}

.row-error{background:var(--danger-light)!important}
.row-warning{background:var(--warning-light)!important}
.row-resolved{opacity:.55}
.row-hidden{opacity:.3}

.resolve-check{width:18px;height:18px;accent-color:var(--primary);cursor:pointer}

.supplement-box{background:#EDF4FA;border:2px solid rgba(45,95,138,.3);border-radius:8px;padding:14px;margin-top:10px;animation:fadeIn .2s}
.supplement-title{font-size:13px;font-weight:700;color:var(--accent);margin-bottom:10px;display:flex;align-items:center;gap:6px}

.staff-select-wrap{position:relative;display:inline-flex;align-items:center;gap:2px}
.staff-add-btn{padding:4px 8px;border:1px solid var(--border);border-radius:4px;background:var(--primary-light);color:var(--primary);font-size:11px;cursor:pointer;font-weight:700;white-space:nowrap}
.staff-add-btn:hover{background:var(--primary);color:#fff}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:500;display:flex;align-items:center;justify-content:center}
.modal{background:#fff;border-radius:12px;padding:24px;max-width:420px;width:90%;box-shadow:0 8px 30px rgba(0,0,0,.2);animation:fadeIn .15s}
.modal-title{font-size:16px;font-weight:700;margin-bottom:16px}
.modal-field{margin-bottom:12px}
.modal-field label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:600}

.resolve-actions{display:flex;align-items:center;gap:6px;white-space:nowrap}
.resolve-tag{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;background:var(--primary-light);color:var(--primary);border:1px solid rgba(26,107,78,.2)}
.hide-tag{background:var(--warning-light);color:var(--warning);border:1px solid rgba(184,134,11,.2)}

.footer{text-align:center;padding:20px;color:var(--muted);font-size:11px;border-top:1px solid var(--border);margin-top:30px}
.show-resolved-toggle{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);cursor:pointer;user-select:none}
.show-resolved-toggle input{accent-color:var(--primary)}

@media(max-width:768px){
  .split-view{flex-direction:column}
  .stat-grid{grid-template-columns:repeat(2,1fr)}
  .form-row{flex-direction:column}
  .form-row .input,.form-row select,.form-row .search-select{width:100%!important;min-width:0!important}
}
@media print{
  .header,.tab-bar,.filter-bar,.stat-grid,.no-print,.footer,.btn,.btn-edit,.resolve-actions,.search-row input{display:none!important}
  .content{padding:0!important;max-width:100%!important}
  .table-wrap{border:none!important;box-shadow:none!important}
  table{font-size:11px!important}
  thead tr{background:#333!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .expand-row,.row-error,.row-warning,.row-resolved{-webkit-print-color-adjust:exact;print-color-adjust:exact}
  body{background:#fff!important}
  .print-header{display:block!important;text-align:center;padding:16px 0;border-bottom:2px solid #333;margin-bottom:16px}
  .print-header h1{font-size:18px;margin:0}
  .print-header p{font-size:12px;color:#666;margin-top:4px}
}
.print-header{display:none}
.action-bar{display:flex;gap:6px;flex-wrap:wrap}
.btn-icon{padding:6px 12px;font-size:12px;display:flex;align-items:center;gap:4px}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const SUPABASE_URL="https://ndyyicskqplybpdtbksm.supabase.co";
const SUPABASE_ANON_KEY="sb_publishable_YPtz-9UqNdO1KyeFdPNrQw_KZH3Wt9a";

async function supaFetch(table,{method="GET",body,query="",headers:extra={}}={}){
  const url=`${SUPABASE_URL}/rest/v1/${table}${query?"?"+query:""}`;
  const headers={apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`,"Content-Type":"application/json",...(method==="POST"||method==="PATCH"?{Prefer:"return=representation"}:{}), ...extra};
  const res=await fetch(url,{method,headers,body:body?JSON.stringify(body):undefined});
  if(!res.ok){const e=await res.text();throw new Error(`${res.status}: ${e}`);}
  const text=await res.text(); return text?JSON.parse(text):null;
}
async function supaRpc(fn,params={}){
  const res=await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`,{method:"POST",headers:{apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`,"Content-Type":"application/json"},body:JSON.stringify(params)});
  if(!res.ok)throw new Error(await res.text()); return res.json();
}
async function supaDelete(table,query){
  const url=`${SUPABASE_URL}/rest/v1/${table}?${query}`;
  const res=await fetch(url,{method:"DELETE",headers:{apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`}});
  if(!res.ok)throw new Error(await res.text());
}
async function supaPatch(table,query,body){
  const url=`${SUPABASE_URL}/rest/v1/${table}?${query}`;
  const res=await fetch(url,{method:"PATCH",headers:{apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`,"Content-Type":"application/json",Prefer:"return=representation"},body:JSON.stringify(body)});
  if(!res.ok)throw new Error(await res.text());
  const text=await res.text();return text?JSON.parse(text):null;
}

const{useState,useEffect,useCallback,useRef}=React;

// ============================================================
// Export & Print Utilities
// ============================================================
function exportToExcel(data,columns,filename){
  const ws_data=[columns.map(c=>c.label)];
  data.forEach(r=>{ws_data.push(columns.map(c=>c.value(r)));});
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  // Auto column widths
  ws['!cols']=columns.map(c=>({wch:Math.max(c.label.length*2.5,12)}));
  XLSX.utils.book_append_sheet(wb,ws,"Sheet1");
  XLSX.writeFile(wb,filename);
}

function printSection(title,subtitle){
  // Insert print header temporarily
  const header=document.querySelector('.print-header');
  if(header){header.querySelector('h1').textContent=title;header.querySelector('p').textContent=subtitle||`åˆ—å°æ—¥æœŸ: ${new Date().toISOString().slice(0,10)}`;}
  window.print();
}

// ============================================================
// Shared Components
// ============================================================
function Toast({message,type,onClose}){
  if(!message)return null;
  const bg=type==="error"?"var(--danger)":type==="success"?"var(--primary)":"var(--warning)";
  return <div className="toast" style={{background:bg}}><span style={{flex:1}}>{message}</span><button className="toast-close" onClick={onClose}>Ã—</button></div>;
}
function Badge({type,children}){return <span className={`badge badge-${type||"neutral"}`}>{children}</span>;}

function StaffSelect({staff,value,onChange,onAdd,placeholder,roleFilter,style,multi}){
  const filtered=roleFilter?staff.filter(s=>s.role===roleFilter||s.role==="general"):staff;
  const[open,setOpen]=useState(false);
  const ref=useRef(null);
  useEffect(()=>{const h=e=>{if(ref.current&&!ref.current.contains(e.target))setOpen(false);};document.addEventListener("mousedown",h);return()=>document.removeEventListener("mousedown",h);},[]);

  if(!multi){
    return <div className="staff-select-wrap" style={style}>
      <select className="input" style={{flex:1,minWidth:0}} value={value||""} onChange={e=>onChange(e.target.value)}>
        <option value="">{placeholder||"é¸æ“‡äººå“¡"}</option>
        {filtered.map(s=><option key={s.id} value={s.name}>{s.name}</option>)}
      </select>
      <button className="staff-add-btn" onClick={onAdd} title="æ–°å¢äººå“¡">ï¼‹</button>
    </div>;
  }

  // Multi-select mode
  const selected=(value||"").split(",").filter(Boolean);
  const toggle=(name)=>{
    const newSel=selected.includes(name)?selected.filter(n=>n!==name):[...selected,name];
    onChange(newSel.join(","));
  };

  return <div className="staff-select-wrap" ref={ref} style={{...style,flexDirection:"column",alignItems:"stretch"}}>
    <div style={{display:"flex",gap:2}}>
      <div className="input" style={{flex:1,minWidth:0,cursor:"pointer",minHeight:34,display:"flex",alignItems:"center",flexWrap:"wrap",gap:3,padding:"4px 8px"}} onClick={()=>setOpen(!open)}>
        {selected.length===0?<span style={{color:"var(--muted)",fontSize:13}}>{placeholder||"é¸æ“‡äººå“¡ï¼ˆå¯è¤‡é¸ï¼‰"}</span>:
        selected.map(n=><span key={n} style={{background:"var(--primary-light)",color:"var(--primary)",padding:"1px 6px",borderRadius:4,fontSize:11,fontWeight:600,display:"inline-flex",alignItems:"center",gap:3}}>{n}<span style={{cursor:"pointer",fontSize:13}} onClick={e=>{e.stopPropagation();toggle(n);}}>Ã—</span></span>)}
      </div>
      <button className="staff-add-btn" onClick={onAdd} title="æ–°å¢äººå“¡">ï¼‹</button>
    </div>
    {open&&<div style={{position:"absolute",top:"100%",left:0,right:0,background:"#fff",border:"1px solid var(--border)",borderRadius:"0 0 6px 6px",maxHeight:180,overflowY:"auto",zIndex:100,boxShadow:"0 4px 12px rgba(0,0,0,.1)"}}>
      {filtered.map(s=><div key={s.id} style={{padding:"8px 10px",cursor:"pointer",fontSize:13,display:"flex",alignItems:"center",gap:6,borderBottom:"1px solid #f0f0f0",background:selected.includes(s.name)?"var(--primary-light)":"transparent"}} onClick={()=>toggle(s.name)}>
        <span style={{width:16,height:16,borderRadius:3,border:"2px solid "+(selected.includes(s.name)?"var(--primary)":"var(--border)"),background:selected.includes(s.name)?"var(--primary)":"transparent",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:11,flexShrink:0}}>{selected.includes(s.name)?"âœ“":""}</span>
        {s.name}
      </div>)}
    </div>}
  </div>;
}

function AddStaffModal({show,onClose,onSave,defaultRole}){
  const[name,setName]=useState("");const[role,setRole]=useState(defaultRole||"general");
  if(!show)return null;
  const save=()=>{if(!name.trim())return;onSave(name.trim(),role);setName("");onClose();};
  return <div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}>
    <div className="modal-title">æ–°å¢äººå“¡</div>
    <div className="modal-field"><label>å§“å</label><input className="input" style={{width:"100%"}} value={name} onChange={e=>setName(e.target.value)} placeholder="è«‹è¼¸å…¥å§“å" autoFocus onKeyDown={e=>e.key==="Enter"&&save()}/></div>
    <div className="modal-field"><label>è§’è‰²</label><select className="input" style={{width:"100%"}} value={role} onChange={e=>setRole(e.target.value)}><option value="assembler">çµ„è£äººå“¡</option><option value="tester">æ¸¬è©¦äººå“¡</option><option value="inspector">æª¢é©—äººå“¡</option><option value="general">ä¸€èˆ¬</option></select></div>
    <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}><button className="btn btn-secondary" onClick={onClose}>å–æ¶ˆ</button><button className="btn btn-primary" onClick={save}>æ–°å¢</button></div>
  </div></div>;
}

// Edit Qty Modal - requires person, reason, logs the change
function EditQtyModal({show,onClose,onSave,item,tableName,staff,onAddStaff}){
  const[newQty,setNewQty]=useState(item?.qty||0);
  const[editedBy,setEditedBy]=useState("");
  const[reason,setReason]=useState("");
  useEffect(()=>{if(item){setNewQty(item.qty);setEditedBy("");setReason("");}},[item]);
  if(!show||!item)return null;
  const save=()=>{
    if(!editedBy.trim()){alert("è«‹é¸æ“‡ä¿®æ”¹äººå“¡");return;}
    if(!reason.trim()){alert("è«‹å¡«å¯«ä¿®æ”¹åŸå› ");return;}
    if(parseInt(newQty)===item.qty){alert("æ•¸é‡æœªè®Šæ›´");return;}
    onSave({recordId:item.id,tableName,oldQty:item.qty,newQty:parseInt(newQty),editedBy:editedBy.trim(),reason:reason.trim()});
  };
  return <div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}>
    <div className="modal-title">âœï¸ ä¿®æ”¹æ•¸é‡</div>
    <div style={{background:"#f8f7f4",borderRadius:6,padding:10,marginBottom:14,fontSize:12}}>
      <div><strong>å–®è™Ÿï¼š</strong>{item.orderNo}</div>
      <div><strong>ç”¢å“ï¼š</strong>{item.productCode} - {item.productName}</div>
    </div>
    <div className="modal-field">
      <label>åŸå§‹æ•¸é‡</label>
      <div style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:18,color:"var(--muted)"}}>{item.qty}</div>
    </div>
    <div className="modal-field">
      <label>æ–°æ•¸é‡ <span style={{color:"var(--danger)"}}>*</span></label>
      <input type="number" className="input" style={{width:"100%",fontSize:16,fontWeight:700}} min="0" value={newQty} onChange={e=>setNewQty(e.target.value)} autoFocus/>
    </div>
    <div className="modal-field">
      <label>ä¿®æ”¹äººå“¡ <span style={{color:"var(--danger)"}}>*</span></label>
      <StaffSelect staff={staff} value={editedBy} onChange={setEditedBy} onAdd={onAddStaff} style={{width:"100%"}}/>
    </div>
    <div className="modal-field">
      <label>ä¿®æ”¹åŸå›  <span style={{color:"var(--danger)"}}>*</span></label>
      <input className="input" style={{width:"100%"}} value={reason} onChange={e=>setReason(e.target.value)} placeholder="ä¾‹ï¼šæ•¸é‡è¨ˆç®—éŒ¯èª¤ã€è£œæ•¸ã€å®¢æˆ¶è¦æ±‚è®Šæ›´..." onKeyDown={e=>e.key==="Enter"&&save()}/>
    </div>
    <div style={{fontSize:11,color:"var(--muted)",marginBottom:12}}>ä¿®æ”¹æ—¥æœŸï¼š{new Date().toISOString().slice(0,10)} Â· æ‰€æœ‰ä¿®æ”¹è¨˜éŒ„å°‡è¢«ä¿å­˜</div>
    <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}><button className="btn btn-secondary" onClick={onClose}>å–æ¶ˆ</button><button className="btn btn-primary" onClick={save}>ç¢ºèªä¿®æ”¹</button></div>
  </div></div>;
}

function ProductSearch({products,value,onChange,style}){
  const[search,setSearch]=useState("");const[open,setOpen]=useState(false);const ref=useRef(null);
  const selected=products.find(p=>p.id===value);
  useEffect(()=>{const h=e=>{if(ref.current&&!ref.current.contains(e.target))setOpen(false);};document.addEventListener("mousedown",h);return()=>document.removeEventListener("mousedown",h);},[]);
  const filtered=products.filter(p=>{if(!search)return true;const s=search.toLowerCase();return p.product_id.toLowerCase().includes(s)||p.product_name.toLowerCase().includes(s);}).slice(0,50);
  return <div className="search-select" ref={ref} style={style}>
    <input className="input" style={{width:"100%"}} placeholder={selected?`${selected.product_id} - ${selected.product_name}`:"ğŸ” æœå°‹ç”¢å“..."} value={open?search:""} onFocus={()=>{setOpen(true);setSearch("");}} onChange={e=>{setSearch(e.target.value);setOpen(true);}}/>
    {open&&<div className="search-dropdown">{filtered.length===0&&<div style={{padding:10,color:"var(--muted)",textAlign:"center"}}>ç„¡ç¬¦åˆç”¢å“</div>}{filtered.map(p=><div key={p.id} className="search-dropdown-item" onClick={()=>{onChange(p.id);setOpen(false);setSearch("");}}><code>{p.product_id}</code>{p.product_name}</div>)}</div>}
  </div>;
}

// ============================================================
// Reconciliation Tab
// ============================================================
function ReconciliationTab({products,customers,staff,toast,reloadStaff}){
  const[data,setData]=useState([]);const[loading,setLoading]=useState(true);
  const[dateFrom,setDateFrom]=useState("");const[dateTo,setDateTo]=useState("");
  const[filter,setFilter]=useState("all");const[sortCol,setSortCol]=useState("status");const[sortDir,setSortDir]=useState("asc");
  const[colSearch,setColSearch]=useState({product_code:"",product_name:"",status_desc:""});
  const[expandedRow,setExpandedRow]=useState(null);const[expandData,setExpandData]=useState({asm:[],pkg:[]});
  const[showHidden,setShowHidden]=useState(false);
  const[supplementing,setSupplementing]=useState(null);
  const[suppForm,setSuppForm]=useState({qty:1,assembler:"",tester:"",inspector:"",customer_id:"",assembly_date:"",note:""});
  const[staffModal,setStaffModal]=useState({show:false,role:"general"});
  const[editModal,setEditModal]=useState({show:false,item:null,tableName:""});

  const load=useCallback(async()=>{setLoading(true);try{setData(await supaFetch("v_reconciliation",{query:"select=*"})||[]);}catch(e){console.error(e);}setLoading(false);},[]);
  useEffect(()=>{load();},[load]);

  const searchByDate=async()=>{if(!dateFrom||!dateTo)return;setLoading(true);try{setData(await supaRpc("fn_reconcile_by_date",{p_date_from:dateFrom,p_date_to:dateTo})||[]);}catch(e){console.error(e);load();}setLoading(false);};

  const loadDetail=async(productId,productCode)=>{
    if(expandedRow===productCode){setExpandedRow(null);return;}
    setExpandedRow(productCode);setSupplementing(null);
    try{
      const[asmItems,pkgItems]=await Promise.all([
        supaFetch("assembly_items",{query:`select=*,assembly_orders(order_no,order_date),products!inner(product_id,product_name)&products.product_id=eq.${encodeURIComponent(productCode)}`}),
        supaFetch("packaging_items",{query:`select=*,packaging_orders(order_no,order_date),products!inner(product_id,product_name),customers(name)&products.product_id=eq.${encodeURIComponent(productCode)}`})
      ]);
      setExpandData({asm:asmItems||[],pkg:pkgItems||[]});
    }catch(e){console.error(e);setExpandData({asm:[],pkg:[]});}
  };

  // Two-step: å·²è™•ç† â†’ ä¸å†é¡¯ç¤º (local state update, no full reload)
  const updateLocal=(productId,updates)=>{
    setData(prev=>prev.map(r=>r.product_id===productId?{...r,...updates}:r));
  };
  const markResolved=async(productId)=>{
    updateLocal(productId,{resolved_at:new Date().toISOString(),resolved_by:"ç³»çµ±ä½¿ç”¨è€…",hidden:false});
    try{await supaFetch("reconciliation_resolved",{method:"POST",body:{product_id:productId,resolved_by:"ç³»çµ±ä½¿ç”¨è€…",note:"å·²è™•ç†",hidden:false}});}catch(e){toast("æ¨™è¨˜å¤±æ•—: "+e.message,"error");updateLocal(productId,{resolved_at:null,resolved_by:null,hidden:false});}
  };
  const unmarkResolved=async(productId)=>{
    const prev=data.find(r=>r.product_id===productId);
    updateLocal(productId,{resolved_at:null,resolved_by:null,hidden:false});
    try{await supaDelete("reconciliation_resolved",`product_id=eq.${productId}`);}catch(e){toast("å–æ¶ˆå¤±æ•—: "+e.message,"error");if(prev)updateLocal(productId,{resolved_at:prev.resolved_at,resolved_by:prev.resolved_by,hidden:prev.hidden});}
  };
  const markHidden=async(productId)=>{
    updateLocal(productId,{hidden:true});
    try{await supaPatch("reconciliation_resolved",`product_id=eq.${productId}`,{hidden:true});}catch(e){toast("æ¨™è¨˜å¤±æ•—: "+e.message,"error");updateLocal(productId,{hidden:false});}
  };
  const unmarkHidden=async(productId)=>{
    updateLocal(productId,{hidden:false});
    try{await supaPatch("reconciliation_resolved",`product_id=eq.${productId}`,{hidden:false});}catch(e){toast("å–æ¶ˆå¤±æ•—: "+e.message,"error");updateLocal(productId,{hidden:true});}
  };

  // Edit qty
  const handleEditQty=async({recordId,tableName,oldQty,newQty,editedBy,reason})=>{
    try{
      // 1. Log the edit
      await supaFetch("edit_logs",{method:"POST",body:{table_name:tableName,record_id:recordId,field_name:"qty",old_value:String(oldQty),new_value:String(newQty),edited_by:editedBy,reason}});
      // 2. Update the qty
      await supaPatch(tableName,`id=eq.${recordId}`,{qty:newQty});
      toast(`æ•¸é‡å·²å¾ ${oldQty} ä¿®æ”¹ç‚º ${newQty}`,"success");
      setEditModal({show:false,item:null,tableName:""});
      // Reload expand data
      if(expandedRow){const pc=expandedRow;setExpandedRow(null);setTimeout(()=>loadDetail(null,pc),100);}
      load();
    }catch(e){toast("ä¿®æ”¹å¤±æ•—: "+e.message,"error");}
  };

  const submitSupplement=async()=>{
    if(!supplementing)return;const{product_id,type}=supplementing;const qty=parseInt(suppForm.qty);
    if(!qty||qty<=0){toast("è«‹è¼¸å…¥æ­£ç¢ºæ•¸é‡","error");return;}
    try{
      if(type==="asm"){
        const[order]=await supaFetch("assembly_orders",{method:"POST",body:{order_date:suppForm.order_date||new Date().toISOString().slice(0,10),status:"draft"}});
        await supaFetch("assembly_items",{method:"POST",body:{order_id:order.id,product_id,qty,assembler:suppForm.assembler||null,warehouse_date:suppForm.assembly_date||null,note:suppForm.note||"è£œå–®"}});
        toast(`çµ„è£è£œå–®æˆåŠŸï¼${order.order_no}`,"success");
      }else{
        const[order]=await supaFetch("packaging_orders",{method:"POST",body:{order_date:new Date().toISOString().slice(0,10),status:"draft"}});
        await supaFetch("packaging_items",{method:"POST",body:{order_id:order.id,product_id,qty,customer_id:suppForm.customer_id||null,is_stock:!suppForm.customer_id,tester:suppForm.tester||null,inspector:suppForm.inspector||null,assembly_date:suppForm.assembly_date||null,note:suppForm.note||"è£œå–®"}});
        toast(`åŒ…è£è£œå–®æˆåŠŸï¼${order.order_no}`,"success");
      }
      setSupplementing(null);setSuppForm({qty:1,assembler:"",tester:"",inspector:"",customer_id:"",assembly_date:"",note:""});load();
    }catch(e){toast("è£œå–®å¤±æ•—: "+e.message,"error");}
  };

  // Filters
  const statusFilter=r=>{if(filter==="all")return true;if(filter==="matched")return r.status==="matched";if(filter==="mismatch")return r.status==="qty_mismatch";if(filter==="missing")return r.status==="missing_pkg"||r.status==="missing_asm";return true;};
  const colFilter=r=>{for(const[k,v] of Object.entries(colSearch)){if(!v)continue;if(!String(r[k]||"").toLowerCase().includes(v.toLowerCase()))return false;}return true;};
  const hiddenFilter=r=>{if(showHidden)return true;return !r.hidden;};

  const statusOrder={missing_pkg:0,missing_asm:1,qty_mismatch:2,matched:3};
  const sortFn=(a,b)=>{let va,vb;if(sortCol==="status"){va=statusOrder[a.status]??4;vb=statusOrder[b.status]??4;}else if(["assembly_qty","packaging_qty","diff"].includes(sortCol)){va=Number(a[sortCol])||0;vb=Number(b[sortCol])||0;}else if(sortCol==="first_asm_date"){va=a.first_asm_date||"9999";vb=b.first_asm_date||"9999";}else{va=String(a[sortCol]||"").toLowerCase();vb=String(b[sortCol]||"").toLowerCase();}if(va<vb)return sortDir==="asc"?-1:1;if(va>vb)return sortDir==="asc"?1:-1;return 0;};
  const toggleSort=col=>{if(sortCol===col)setSortDir(d=>d==="asc"?"desc":"asc");else{setSortCol(col);setSortDir("asc");}};

  const filtered=data.filter(statusFilter).filter(colFilter).filter(hiddenFilter).sort(sortFn);
  const allVisible=data.filter(hiddenFilter);
  const errors=allVisible.filter(d=>d.status==="missing_pkg"||d.status==="missing_asm").length;
  const warnings=allVisible.filter(d=>d.status==="qty_mismatch").length;
  const matched=allVisible.filter(d=>d.status==="matched").length;
  const hiddenCount=data.filter(d=>d.hidden).length;

  const statusMap={missing_pkg:"error",missing_asm:"warning",qty_mismatch:"warning",matched:"success"};
  const iconBg={total:"var(--accent)",success:"var(--success)",warning:"var(--warning)",error:"var(--danger)"};
  const SortTh=({col,children,style:s})=>(<th onClick={()=>toggleSort(col)} className={sortCol===col?"sorted":""} style={s}>{children}<span className="sort-arrow">{sortCol===col?(sortDir==="asc"?"â–²":"â–¼"):"â‡…"}</span></th>);
  const stats=[{key:"all",l:"ç¸½ç”¢å“æ•¸",v:allVisible.length,t:"total",i:"ğŸ“¦"},{key:"matched",l:"æ ¸å°ä¸€è‡´",v:matched,t:"success",i:"âœ“"},{key:"mismatch",l:"æ•¸é‡å·®ç•°",v:warnings,t:"warning",i:"âš "},{key:"missing",l:"æ¼å–®",v:errors,t:"error",i:"âœ•"}];
  const addStaff=async(name,role)=>{try{await supaFetch("staff",{method:"POST",body:{name,role}});toast(`äººå“¡ã€Œ${name}ã€æ–°å¢æˆåŠŸ`,"success");reloadStaff();}catch(e){toast("æ–°å¢å¤±æ•—: "+e.message,"error");}};

  return <div>
    <AddStaffModal show={staffModal.show} defaultRole={staffModal.role} onClose={()=>setStaffModal({show:false,role:"general"})} onSave={addStaff}/>
    <EditQtyModal show={editModal.show} item={editModal.item} tableName={editModal.tableName} staff={staff} onClose={()=>setEditModal({show:false,item:null,tableName:""})} onSave={handleEditQty} onAddStaff={()=>setStaffModal({show:true,role:"general"})}/>

    <div className="filter-bar">
      <span className="filter-label">æ—¥æœŸç¯„åœï¼š</span>
      <input type="date" className="input" value={dateFrom} onChange={e=>setDateFrom(e.target.value)}/>
      <span style={{color:"var(--muted)"}}>ï½</span>
      <input type="date" className="input" value={dateTo} onChange={e=>setDateTo(e.target.value)}/>
      <button className="btn btn-primary" onClick={searchByDate}>æŸ¥è©¢</button>
      <button className="btn btn-secondary" onClick={()=>{setDateFrom("");setDateTo("");load();}}>é‡ç½®</button>
      {filter!=="all"&&<button className="btn btn-sm btn-secondary" style={{color:"var(--danger)"}} onClick={()=>setFilter("all")}>âœ• æ¸…é™¤ç¯©é¸</button>}
      <div className="action-bar no-print">
        <button className="btn btn-secondary btn-sm btn-icon" onClick={()=>{
          exportToExcel(filtered,[
            {label:"æ—¥æœŸ",value:r=>r.first_asm_date||r.first_pkg_date||""},
            {label:"ç”¢å“ç·¨è™Ÿ",value:r=>r.product_code},
            {label:"ç”¢å“åç¨±",value:r=>r.product_name},
            {label:"çµ„è£æ•¸",value:r=>r.assembly_qty},
            {label:"åŒ…è£æ•¸",value:r=>r.packaging_qty},
            {label:"å·®ç•°",value:r=>r.diff},
            {label:"ç‹€æ…‹",value:r=>r.status_desc}
          ],`æ ¸å°å ±å‘Š_${new Date().toISOString().slice(0,10)}.xlsx`);
          toast("å·²åŒ¯å‡º Excel","success");
        }}>ğŸ“¥ åŒ¯å‡ºExcel</button>
        <button className="btn btn-secondary btn-sm btn-icon" onClick={()=>printSection("æ ¸å°å ±å‘Š",`${dateFrom||"å…¨éƒ¨"}ï½${dateTo||"å…¨éƒ¨"} Â· ${filtered.length}ç­†`)}>ğŸ–¨ åˆ—å°</button>
      </div>
      <div style={{flex:1}}/>
      <label className="show-resolved-toggle"><input type="checkbox" checked={showHidden} onChange={e=>setShowHidden(e.target.checked)}/>é¡¯ç¤ºå·²éš±è— ({hiddenCount})</label>
    </div>

    <div className="stat-grid">
      {stats.map(s=>(<div key={s.key} className={`card stat-card ${filter===s.key?"active":""}`} style={filter===s.key?{borderColor:iconBg[s.t],borderWidth:2}:{}} onClick={()=>setFilter(filter===s.key?"all":s.key)}><div className="stat-icon" style={{background:iconBg[s.t]}}>{s.i}</div><div><div className="stat-value">{s.v}</div><div className="stat-label">{s.l}{filter===s.key?" âœ“":""}</div></div></div>))}
    </div>

    {loading?<div className="spinner"/>:filtered.length===0?<div style={{textAlign:"center",padding:40,color:"var(--muted)"}}>ç„¡ç¬¦åˆè³‡æ–™</div>:
    <div className="table-wrap"><table>
      <thead>
        <tr>
          <th style={{width:30}}></th>
          <SortTh col="first_asm_date">æ—¥æœŸ</SortTh>
          <SortTh col="product_code">ç”¢å“ç·¨è™Ÿ</SortTh>
          <SortTh col="product_name">ç”¢å“åç¨±</SortTh>
          <SortTh col="assembly_qty" style={{textAlign:"right"}}>çµ„è£æ•¸</SortTh>
          <SortTh col="packaging_qty" style={{textAlign:"right"}}>åŒ…è£æ•¸</SortTh>
          <SortTh col="diff" style={{textAlign:"right"}}>å·®ç•°</SortTh>
          <SortTh col="status">ç‹€æ…‹</SortTh>
          <th style={{width:130}}>è™•ç†</th>
        </tr>
        <tr style={{background:"#1a3a2e"}}>
          <th></th><th></th>
          <th><input className="input" style={{width:"100%",padding:"3px 6px",fontSize:11}} placeholder="æœå°‹..." value={colSearch.product_code} onChange={e=>setColSearch({...colSearch,product_code:e.target.value})}/></th>
          <th><input className="input" style={{width:"100%",padding:"3px 6px",fontSize:11}} placeholder="æœå°‹..." value={colSearch.product_name} onChange={e=>setColSearch({...colSearch,product_name:e.target.value})}/></th>
          <th></th><th></th><th></th>
          <th><input className="input" style={{width:"100%",padding:"3px 6px",fontSize:11}} placeholder="æœå°‹..." value={colSearch.status_desc} onChange={e=>setColSearch({...colSearch,status_desc:e.target.value})}/></th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {filtered.map((r,i)=>{
          const isResolved=!!r.resolved_at;
          const isHidden=!!r.hidden;
          const needsAction=r.status!=="matched";
          const cls=(r.status==="missing_pkg"||r.status==="missing_asm"?"row-error":r.status==="qty_mismatch"?"row-warning":"")+(isHidden?" row-hidden":isResolved?" row-resolved":"")+" clickable";
          const isExpanded=expandedRow===r.product_code;
          return <React.Fragment key={r.product_code||i}>
            <tr className={cls} onClick={()=>loadDetail(r.product_id,r.product_code)}>
              <td style={{textAlign:"center",fontSize:16,color:"var(--muted)"}}>{isExpanded?"â–¼":"â–¶"}</td>
              <td style={{fontFamily:"'JetBrains Mono',monospace",fontSize:12,color:"var(--muted)"}}>{r.first_asm_date||r.first_pkg_date||"-"}</td>
              <td><code style={{fontWeight:600}}>{r.product_code}</code></td>
              <td>{r.product_name}</td>
              <td style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:600,textAlign:"right"}}>{r.assembly_qty}</td>
              <td style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:600,textAlign:"right"}}>{r.packaging_qty}</td>
              <td style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,textAlign:"right",color:r.diff>0?"var(--danger)":r.diff<0?"var(--warning)":"var(--success)"}}>{r.diff>0?`+${r.diff}`:r.diff}</td>
              <td><Badge type={statusMap[r.status]}>{r.status_desc}</Badge>
                {isResolved&&!isHidden&&<span className="resolve-tag" style={{marginLeft:4}}>å·²è™•ç†</span>}
                {isHidden&&<span className="resolve-tag hide-tag" style={{marginLeft:4}}>å·²éš±è—</span>}
              </td>
              <td style={{textAlign:"center"}} onClick={e=>e.stopPropagation()}>
                {needsAction&&<div className="resolve-actions">
                  <label title="å·²è™•ç†" style={{display:"flex",alignItems:"center",gap:2,cursor:"pointer",fontSize:11}}><input type="checkbox" className="resolve-check" style={{width:15,height:15}} checked={isResolved} onChange={e=>{e.stopPropagation();isResolved?unmarkResolved(r.product_id):markResolved(r.product_id);}}/><span>å·²è™•ç†</span></label>
                  {isResolved&&<label title="ä¸å†é¡¯ç¤º" style={{display:"flex",alignItems:"center",gap:2,cursor:"pointer",fontSize:11}}><input type="checkbox" className="resolve-check" style={{width:15,height:15}} checked={isHidden} onChange={e=>{e.stopPropagation();isHidden?unmarkHidden(r.product_id):markHidden(r.product_id);}}/><span>éš±è—</span></label>}
                </div>}
              </td>
            </tr>
            {isExpanded&&<tr className="expand-row"><td colSpan={9}>
              <div className="expand-content">
                <div className="expand-section">
                  <div className="expand-title">ğŸ”§ çµ„è£å–®è¨˜éŒ„ ({expandData.asm.length}ç­†)</div>
                  {expandData.asm.length>0?<table className="expand-table">
                    <thead><tr><th>å–®è™Ÿ</th><th>çµ„è£æ—¥æœŸ</th><th>æ•¸é‡</th><th>çµ„è£äººå“¡</th><th>å…¥åº«æ—¥æœŸ</th><th>å‚™è¨»</th><th style={{width:50}}>æ“ä½œ</th></tr></thead>
                    <tbody>{expandData.asm.map(a=><tr key={a.id}>
                      <td><code style={{fontWeight:600,color:"var(--accent)"}}>{a.assembly_orders?.order_no}</code></td>
                      <td>{a.assembly_orders?.order_date}</td>
                      <td style={{fontWeight:700}}>{a.qty}</td>
                      <td>{a.assembler||"-"}</td>
                      <td>{a.warehouse_date||"-"}</td>
                      <td>{a.note||"-"}</td>
                      <td><button className="btn-edit" onClick={e=>{e.stopPropagation();setEditModal({show:true,tableName:"assembly_items",item:{id:a.id,qty:a.qty,orderNo:a.assembly_orders?.order_no,productCode:a.products?.product_id,productName:a.products?.product_name}});}}>ä¿®æ”¹</button></td>
                    </tr>)}</tbody>
                  </table>:<div style={{color:"var(--muted)",fontSize:12,padding:4}}>ç„¡çµ„è£è¨˜éŒ„</div>}
                </div>
                <div className="expand-section">
                  <div className="expand-title">ğŸ“¦ åŒ…è£å‡ºè²¨å…¥åº«è¨˜éŒ„ ({expandData.pkg.length}ç­†)</div>
                  {expandData.pkg.length>0?<table className="expand-table">
                    <thead><tr><th>å–®è™Ÿ</th><th>åŒ…è£æ—¥æœŸ</th><th>æ•¸é‡</th><th>å®¢æˆ¶</th><th>æ¸¬è©¦äººå“¡</th><th>æª¢é©—äººå“¡</th><th>çµ„è£æ—¥æœŸ</th><th>å‚™è¨»</th><th style={{width:50}}>æ“ä½œ</th></tr></thead>
                    <tbody>{expandData.pkg.map(p=><tr key={p.id}>
                      <td><code style={{fontWeight:600,color:"var(--accent)"}}>{p.packaging_orders?.order_no}</code></td>
                      <td>{p.packaging_orders?.order_date}</td>
                      <td style={{fontWeight:700}}>{p.qty}</td>
                      <td>{p.is_stock?"åº«å­˜":p.customers?.name||"-"}</td>
                      <td>{p.tester||"-"}</td>
                      <td>{p.inspector||"-"}</td>
                      <td>{p.assembly_date||"-"}</td>
                      <td>{p.note||"-"}</td>
                      <td><button className="btn-edit" onClick={e=>{e.stopPropagation();setEditModal({show:true,tableName:"packaging_items",item:{id:p.id,qty:p.qty,orderNo:p.packaging_orders?.order_no,productCode:p.products?.product_id,productName:p.products?.product_name}});}}>ä¿®æ”¹</button></td>
                    </tr>)}</tbody>
                  </table>:<div style={{color:"var(--muted)",fontSize:12,padding:4}}>ç„¡åŒ…è£è¨˜éŒ„</div>}
                </div>

                {needsAction&&!supplementing&&<div style={{display:"flex",gap:8,marginTop:8}}>
                  <button className="btn btn-sm btn-primary" onClick={e=>{e.stopPropagation();setSupplementing({product_id:r.product_id,product_code:r.product_code,type:"asm",diff:Math.abs(r.diff)});setSuppForm({...suppForm,qty:Math.abs(r.diff)||1});}}>ï¼‹ è£œçµ„è£å–®</button>
                  <button className="btn btn-sm btn-primary" style={{background:"var(--accent)"}} onClick={e=>{e.stopPropagation();setSupplementing({product_id:r.product_id,product_code:r.product_code,type:"pkg",diff:Math.abs(r.diff)});setSuppForm({...suppForm,qty:Math.abs(r.diff)||1});}}>ï¼‹ è£œåŒ…è£å‡ºè²¨å–®</button>
                </div>}

                {supplementing&&supplementing.product_code===r.product_code&&(
                  <div className="supplement-box">
                    <div className="supplement-title">{supplementing.type==="asm"?"ğŸ”§ è£œå»ºçµ„è£å–®":"ğŸ“¦ è£œå»ºåŒ…è£å‡ºè²¨å–®"} â€” {r.product_code} {r.product_name}</div>
                    <div className="form-row">
                      <span className="filter-label">æ•¸é‡ï¼š</span>
                      <input type="number" className="input" style={{width:80}} min="1" value={suppForm.qty} onChange={e=>setSuppForm({...suppForm,qty:e.target.value})}/>
                      {supplementing.type==="asm"&&<><span className="filter-label">çµ„è£äººå“¡ï¼š</span><StaffSelect staff={staff} value={suppForm.assembler} onChange={v=>setSuppForm({...suppForm,assembler:v})} onAdd={()=>setStaffModal({show:true,role:"assembler"})} roleFilter="assembler" multi style={{width:180}}/><span className="filter-label">çµ„è£æ—¥æœŸï¼š</span><input type="date" className="input" style={{width:140}} value={suppForm.order_date||""} onChange={e=>setSuppForm({...suppForm,order_date:e.target.value})}/><span className="filter-label">å…¥åº«æ—¥æœŸï¼š</span><input type="date" className="input" style={{width:140}} value={suppForm.assembly_date} onChange={e=>setSuppForm({...suppForm,assembly_date:e.target.value})}/></>}
                      {supplementing.type==="pkg"&&<><span className="filter-label">å®¢æˆ¶ï¼š</span><select className="input" style={{width:110}} value={suppForm.customer_id} onChange={e=>setSuppForm({...suppForm,customer_id:e.target.value})}><option value="">åº«å­˜</option>{customers.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select><span className="filter-label">æ¸¬è©¦äººå“¡ï¼š</span><StaffSelect staff={staff} value={suppForm.tester} onChange={v=>setSuppForm({...suppForm,tester:v})} onAdd={()=>setStaffModal({show:true,role:"tester"})} roleFilter="tester" multi style={{width:160}}/><span className="filter-label">æª¢é©—äººå“¡ï¼š</span><StaffSelect staff={staff} value={suppForm.inspector} onChange={v=>setSuppForm({...suppForm,inspector:v})} onAdd={()=>setStaffModal({show:true,role:"inspector"})} roleFilter="inspector" style={{width:130}}/></>}
                    </div>
                    <div className="form-row" style={{marginTop:6}}>
                      <span className="filter-label">å‚™è¨»ï¼š</span><input className="input" style={{flex:1}} value={suppForm.note} onChange={e=>setSuppForm({...suppForm,note:e.target.value})} placeholder="è£œå–®åŸå› "/>
                      <button className="btn btn-primary" onClick={submitSupplement}>ç¢ºèªè£œå–®</button>
                      <button className="btn btn-secondary" onClick={()=>setSupplementing(null)}>å–æ¶ˆ</button>
                    </div>
                  </div>
                )}
              </div>
            </td></tr>}
          </React.Fragment>;
        })}
      </tbody>
    </table></div>}
    <div style={{marginTop:8,fontSize:11,color:"var(--muted)",textAlign:"right"}}>
      é¡¯ç¤º {filtered.length} / {data.length} ç­† Â· é»æ“Šåˆ—å±•é–‹ Â· å·²éš±è— {hiddenCount} ç­†
    </div>
  </div>;
}

// ============================================================
// Assembly Tab
// ============================================================
function AssemblyTab({products,staff,toast,reloadStaff}){
  const[orders,setOrders]=useState([]);const[items,setItems]=useState([]);const[sel,setSel]=useState(null);const[loading,setLoading]=useState(true);const[showForm,setShowForm]=useState(false);const[orderDate,setOrderDate]=useState(new Date().toISOString().slice(0,10));const[newItems,setNewItems]=useState([{product_id:"",qty:1,assembler:"",warehouse_date:"",note:""}]);
  const[staffModal,setStaffModal]=useState(false);
  const[editModal,setEditModal]=useState({show:false,item:null});
  const load=useCallback(async()=>{setLoading(true);try{setOrders(await supaFetch("assembly_orders",{query:"select=*&order=order_date.desc,created_at.desc"})||[]);}catch(e){}setLoading(false);},[]);
  useEffect(()=>{load();},[load]);
  const loadItems=async id=>{try{setItems(await supaFetch("assembly_items",{query:`select=*,products(product_id,product_name)&order_id=eq.${id}`})||[]);setSel(id);}catch(e){}};
  const create=async()=>{const valid=newItems.filter(it=>it.product_id&&it.qty>0);if(!valid.length){toast("è«‹è‡³å°‘æ–°å¢ä¸€å€‹ç”¢å“","error");return;}try{const[order]=await supaFetch("assembly_orders",{method:"POST",body:{order_date:orderDate,status:"draft"}});for(const it of valid)await supaFetch("assembly_items",{method:"POST",body:{order_id:order.id,product_id:it.product_id,qty:parseInt(it.qty),assembler:it.assembler,warehouse_date:it.warehouse_date||null,note:it.note}});toast("çµ„è£å–®å»ºç«‹æˆåŠŸï¼å–®è™Ÿ: "+order.order_no,"success");setShowForm(false);setNewItems([{product_id:"",qty:1,assembler:"",warehouse_date:"",note:""}]);load();}catch(e){toast("å»ºç«‹å¤±æ•—: "+e.message,"error");}};
  const approveOrder=async(id)=>{try{await supaPatch("assembly_orders",`id=eq.${id}`,{status:"approved"});toast("å·²æ ¸å‡†","success");load();}catch(e){toast("æ ¸å‡†å¤±æ•—: "+e.message,"error");}};
  const revertDraft=async(id)=>{try{await supaPatch("assembly_orders",`id=eq.${id}`,{status:"draft"});toast("å·²é€€å›è‰ç¨¿","success");load();}catch(e){toast("æ“ä½œå¤±æ•—: "+e.message,"error");}};
  const handleEdit=async({recordId,tableName,oldQty,newQty,editedBy,reason})=>{
    try{await supaFetch("edit_logs",{method:"POST",body:{table_name:tableName,record_id:recordId,field_name:"qty",old_value:String(oldQty),new_value:String(newQty),edited_by:editedBy,reason}});await supaPatch(tableName,`id=eq.${recordId}`,{qty:newQty});toast(`æ•¸é‡å·²ä¿®æ”¹: ${oldQty} â†’ ${newQty}`,"success");setEditModal({show:false,item:null});if(sel)loadItems(sel);}catch(e){toast("ä¿®æ”¹å¤±æ•—: "+e.message,"error");}
  };
  const addStaff=async(name,role)=>{try{await supaFetch("staff",{method:"POST",body:{name,role}});toast(`äººå“¡ã€Œ${name}ã€æ–°å¢æˆåŠŸ`,"success");reloadStaff();}catch(e){toast("æ–°å¢å¤±æ•—: "+e.message,"error");}};
  const sC={draft:"neutral",submitted:"info",approved:"success",rejected:"error"};const sL={draft:"è‰ç¨¿",submitted:"å·²é€ç°½",approved:"å·²æ ¸å‡†",rejected:"å·²é€€å›"};
  const selOrder=orders.find(o=>o.id===sel);
  return <div>
    <AddStaffModal show={staffModal} defaultRole="assembler" onClose={()=>setStaffModal(false)} onSave={addStaff}/>
    <EditQtyModal show={editModal.show} item={editModal.item} tableName="assembly_items" staff={staff} onClose={()=>setEditModal({show:false,item:null})} onSave={handleEdit} onAddStaff={()=>setStaffModal(true)}/>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16,flexWrap:"wrap",gap:8}}>
      <span style={{fontSize:12,color:"var(--muted)"}}>å…± {orders.length} ç­†çµ„è£å–®</span>
      <div className="action-bar">
        {sel&&items.length>0&&<><button className="btn btn-secondary btn-sm btn-icon" onClick={()=>{
          const o=selOrder;
          exportToExcel(items,[
            {label:"ç”¢å“ç·¨è™Ÿ",value:r=>r.products?.product_id},
            {label:"ç”¢å“åç¨±",value:r=>r.products?.product_name},
            {label:"æ•¸é‡",value:r=>r.qty},
            {label:"çµ„è£äººå“¡",value:r=>r.assembler||""},
            {label:"å…¥åº«æ—¥æœŸ",value:r=>r.warehouse_date||""},
            {label:"å‚™è¨»",value:r=>r.note||""}
          ],`çµ„è£å–®_${o?.order_no||"export"}.xlsx`);toast("å·²åŒ¯å‡º","success");
        }}>ğŸ“¥ Excel</button>
        <button className="btn btn-secondary btn-sm btn-icon" onClick={()=>printSection(`çµ„è£å–® ${selOrder?.order_no}`,`çµ„è£æ—¥æœŸ: ${selOrder?.order_date}`)}>ğŸ–¨ åˆ—å°</button></>}
        <button className="btn btn-primary" onClick={()=>setShowForm(!showForm)}>{showForm?"å–æ¶ˆ":"+ æ–°å¢çµ„è£å–®"}</button>
      </div>
    </div>
    {showForm&&<div className="form-box"><div className="form-title">æ–°å¢çµ„è£å–®</div><div className="form-row" style={{marginBottom:12}}><span className="filter-label">çµ„è£æ—¥æœŸï¼š</span><input type="date" className="input" value={orderDate} onChange={e=>setOrderDate(e.target.value)} style={{width:160}}/></div>{newItems.map((it,idx)=><div key={idx} className="form-row"><ProductSearch products={products} value={it.product_id} onChange={v=>{const n=[...newItems];n[idx].product_id=v;setNewItems(n);}} style={{minWidth:240,flex:2}}/><input type="number" className="input" style={{width:65}} min="1" value={it.qty} onChange={e=>{const n=[...newItems];n[idx].qty=e.target.value;setNewItems(n);}} placeholder="æ•¸é‡"/><StaffSelect staff={staff} value={it.assembler} onChange={v=>{const n=[...newItems];n[idx].assembler=v;setNewItems(n);}} onAdd={()=>setStaffModal(true)} roleFilter="assembler" placeholder="çµ„è£äººå“¡" multi style={{width:180}}/><input type="date" className="input" style={{width:140}} value={it.warehouse_date} onChange={e=>{const n=[...newItems];n[idx].warehouse_date=e.target.value;setNewItems(n);}}/><input className="input" style={{flex:1,minWidth:80}} value={it.note} onChange={e=>{const n=[...newItems];n[idx].note=e.target.value;setNewItems(n);}} placeholder="å‚™è¨»"/>{newItems.length>1&&<button className="btn btn-secondary btn-sm" style={{color:"var(--danger)"}} onClick={()=>setNewItems(newItems.filter((_,i)=>i!==idx))}>âœ•</button>}</div>)}<div style={{display:"flex",gap:8,marginTop:10}}><button className="btn btn-secondary btn-sm" onClick={()=>setNewItems([...newItems,{product_id:"",qty:1,assembler:"",warehouse_date:"",note:""}])}>+ æ–°å¢ç”¢å“è¡Œ</button><button className="btn btn-primary" onClick={create}>ç¢ºèªå»ºç«‹</button></div></div>}
    {loading?<div className="spinner"/>:<div className="split-view"><div className="split-left">{orders.map(o=><div key={o.id} className={`order-card ${sel===o.id?"selected":""}`} onClick={()=>loadItems(o.id)}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><code className="order-no">{o.order_no}</code><Badge type={sC[o.status]}>{sL[o.status]}</Badge></div><div className="order-date">ğŸ“… {o.order_date}</div></div>)}{!orders.length&&<div style={{textAlign:"center",padding:30,color:"var(--muted)"}}>å°šç„¡çµ„è£å–®</div>}</div>{sel&&<div className="split-right">
      {selOrder&&selOrder.status==="draft"&&<div style={{display:"flex",gap:8,marginBottom:10}}><button className="btn btn-primary btn-sm" style={{background:"var(--success)"}} onClick={()=>approveOrder(sel)}>âœ“ æ ¸å‡†</button><button className="btn btn-secondary btn-sm" style={{color:"var(--danger)"}} onClick={()=>{if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤çµ„è£å–®ï¼Ÿ")){(async()=>{try{await supaDelete("assembly_items",`order_id=eq.${sel}`);await supaDelete("assembly_orders",`id=eq.${sel}`);toast("å·²åˆªé™¤","success");setSel(null);load();}catch(e){toast("åˆªé™¤å¤±æ•—: "+e.message,"error");}})();}}}>ğŸ—‘ åˆªé™¤</button></div>}
      {selOrder&&selOrder.status==="approved"&&<div style={{display:"flex",gap:8,marginBottom:10}}><button className="btn btn-secondary btn-sm" onClick={()=>revertDraft(sel)}>â†© é€€å›è‰ç¨¿</button></div>}
      <div className="table-wrap"><table><thead><tr>{["ç”¢å“ç·¨è™Ÿ","ç”¢å“åç¨±","æ•¸é‡","çµ„è£äººå“¡","å…¥åº«æ—¥æœŸ","å‚™è¨»",""].map(h=><th key={h}>{h}</th>)}</tr></thead><tbody>{items.map(it=><tr key={it.id}><td><code style={{fontWeight:600}}>{it.products?.product_id}</code></td><td>{it.products?.product_name}</td><td style={{fontWeight:700,fontFamily:"'JetBrains Mono',monospace"}}>{it.qty}</td><td>{it.assembler||"-"}</td><td>{it.warehouse_date||"-"}</td><td>{it.note||"-"}</td><td><button className="btn-edit" onClick={()=>setEditModal({show:true,item:{id:it.id,qty:it.qty,orderNo:selOrder?.order_no,productCode:it.products?.product_id,productName:it.products?.product_name}})}>ä¿®æ”¹</button></td></tr>)}</tbody></table></div></div>}</div>}
  </div>;
}

// ============================================================
// Packaging Tab
// ============================================================
function PackagingTab({products,customers,staff,toast,reloadStaff}){
  const[orders,setOrders]=useState([]);const[items,setItems]=useState([]);const[sel,setSel]=useState(null);const[loading,setLoading]=useState(true);const[showForm,setShowForm]=useState(false);const[orderDate,setOrderDate]=useState(new Date().toISOString().slice(0,10));const[newItems,setNewItems]=useState([{product_id:"",qty:1,customer_id:"",tester:"",inspector:"",assembly_date:"",note:""}]);
  const[staffModal,setStaffModal]=useState({show:false,role:"tester"});
  const[editModal,setEditModal]=useState({show:false,item:null});
  const load=useCallback(async()=>{setLoading(true);try{setOrders(await supaFetch("packaging_orders",{query:"select=*&order=order_date.desc,created_at.desc"})||[]);}catch(e){}setLoading(false);},[]);
  useEffect(()=>{load();},[load]);
  const loadItems=async id=>{try{setItems(await supaFetch("packaging_items",{query:`select=*,products(product_id,product_name),customers(name)&order_id=eq.${id}`})||[]);setSel(id);}catch(e){console.error(e);}};
  const create=async()=>{const valid=newItems.filter(it=>it.product_id&&it.qty>0);if(!valid.length){toast("è«‹è‡³å°‘æ–°å¢ä¸€å€‹ç”¢å“","error");return;}try{const[order]=await supaFetch("packaging_orders",{method:"POST",body:{order_date:orderDate,status:"draft"}});for(const it of valid)await supaFetch("packaging_items",{method:"POST",body:{order_id:order.id,product_id:it.product_id,qty:parseInt(it.qty),customer_id:it.customer_id||null,is_stock:!it.customer_id,tester:it.tester,inspector:it.inspector,assembly_date:it.assembly_date||null,note:it.note}});toast("åŒ…è£å‡ºè²¨å…¥åº«å–®å»ºç«‹æˆåŠŸï¼å–®è™Ÿ: "+order.order_no,"success");setShowForm(false);setNewItems([{product_id:"",qty:1,customer_id:"",tester:"",inspector:"",assembly_date:"",note:""}]);load();}catch(e){toast("å»ºç«‹å¤±æ•—: "+e.message,"error");}};
  const handleEdit=async({recordId,tableName,oldQty,newQty,editedBy,reason})=>{
    try{await supaFetch("edit_logs",{method:"POST",body:{table_name:tableName,record_id:recordId,field_name:"qty",old_value:String(oldQty),new_value:String(newQty),edited_by:editedBy,reason}});await supaPatch(tableName,`id=eq.${recordId}`,{qty:newQty});toast(`æ•¸é‡å·²ä¿®æ”¹: ${oldQty} â†’ ${newQty}`,"success");setEditModal({show:false,item:null});if(sel)loadItems(sel);}catch(e){toast("ä¿®æ”¹å¤±æ•—: "+e.message,"error");}
  };
  const approveOrder=async(id)=>{try{await supaPatch("packaging_orders",`id=eq.${id}`,{status:"approved"});toast("å·²æ ¸å‡†","success");load();}catch(e){toast("æ ¸å‡†å¤±æ•—: "+e.message,"error");}};
  const revertDraft=async(id)=>{try{await supaPatch("packaging_orders",`id=eq.${id}`,{status:"draft"});toast("å·²é€€å›è‰ç¨¿","success");load();}catch(e){toast("æ“ä½œå¤±æ•—: "+e.message,"error");}};
  const addStaff=async(name,role)=>{try{await supaFetch("staff",{method:"POST",body:{name,role}});toast(`äººå“¡ã€Œ${name}ã€æ–°å¢æˆåŠŸ`,"success");reloadStaff();}catch(e){toast("æ–°å¢å¤±æ•—: "+e.message,"error");}};
  const sC={draft:"neutral",submitted:"info",approved:"success",rejected:"error"};const sL={draft:"è‰ç¨¿",submitted:"å·²é€ç°½",approved:"å·²æ ¸å‡†",rejected:"å·²é€€å›"};
  const selOrder=orders.find(o=>o.id===sel);
  return <div>
    <AddStaffModal show={staffModal.show} defaultRole={staffModal.role} onClose={()=>setStaffModal({show:false,role:"tester"})} onSave={addStaff}/>
    <EditQtyModal show={editModal.show} item={editModal.item} tableName="packaging_items" staff={staff} onClose={()=>setEditModal({show:false,item:null})} onSave={handleEdit} onAddStaff={()=>setStaffModal({show:true,role:"general"})}/>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16,flexWrap:"wrap",gap:8}}>
      <span style={{fontSize:12,color:"var(--muted)"}}>å…± {orders.length} ç­†åŒ…è£å–®</span>
      <div className="action-bar">
        {sel&&items.length>0&&<><button className="btn btn-secondary btn-sm btn-icon" onClick={()=>{
          const o=selOrder;
          exportToExcel(items,[
            {label:"ç”¢å“ç·¨è™Ÿ",value:r=>r.products?.product_id},
            {label:"ç”¢å“åç¨±",value:r=>r.products?.product_name},
            {label:"æ•¸é‡",value:r=>r.qty},
            {label:"å®¢æˆ¶",value:r=>r.is_stock?"åº«å­˜":r.customers?.name||""},
            {label:"æ¸¬è©¦äººå“¡",value:r=>r.tester||""},
            {label:"æª¢é©—äººå“¡",value:r=>r.inspector||""},
            {label:"çµ„è£æ—¥æœŸ",value:r=>r.assembly_date||""},
            {label:"å‚™è¨»",value:r=>r.note||""}
          ],`åŒ…è£å–®_${o?.order_no||"export"}.xlsx`);toast("å·²åŒ¯å‡º","success");
        }}>ğŸ“¥ Excel</button>
        <button className="btn btn-secondary btn-sm btn-icon" onClick={()=>printSection(`åŒ…è£å‡ºè²¨å…¥åº«å–® ${selOrder?.order_no}`,`åŒ…è£æ—¥æœŸ: ${selOrder?.order_date}`)}>ğŸ–¨ åˆ—å°</button></>}
        <button className="btn btn-primary" onClick={()=>setShowForm(!showForm)}>{showForm?"å–æ¶ˆ":"+ æ–°å¢åŒ…è£å–®"}</button>
      </div>
    </div>
    {showForm&&<div className="form-box"><div className="form-title">æ–°å¢åŒ…è£å‡ºè²¨å…¥åº«å–®</div><div className="form-row" style={{marginBottom:12}}><span className="filter-label">åŒ…è£æ—¥æœŸï¼š</span><input type="date" className="input" value={orderDate} onChange={e=>setOrderDate(e.target.value)} style={{width:160}}/></div>{newItems.map((it,idx)=><div key={idx} className="form-row"><ProductSearch products={products} value={it.product_id} onChange={v=>{const n=[...newItems];n[idx].product_id=v;setNewItems(n);}} style={{minWidth:200,flex:2}}/><input type="number" className="input" style={{width:60}} min="1" value={it.qty} onChange={e=>{const n=[...newItems];n[idx].qty=e.target.value;setNewItems(n);}} placeholder="æ•¸é‡"/><select className="input" style={{width:100}} value={it.customer_id} onChange={e=>{const n=[...newItems];n[idx].customer_id=e.target.value;setNewItems(n);}}><option value="">åº«å­˜</option>{customers.map(cu=><option key={cu.id} value={cu.id}>{cu.name}</option>)}</select><StaffSelect staff={staff} value={it.tester} onChange={v=>{const n=[...newItems];n[idx].tester=v;setNewItems(n);}} onAdd={()=>setStaffModal({show:true,role:"tester"})} roleFilter="tester" placeholder="æ¸¬è©¦äººå“¡" multi style={{width:160}}/><StaffSelect staff={staff} value={it.inspector} onChange={v=>{const n=[...newItems];n[idx].inspector=v;setNewItems(n);}} onAdd={()=>setStaffModal({show:true,role:"inspector"})} roleFilter="inspector" placeholder="æª¢é©—äººå“¡" style={{width:120}}/><input type="date" className="input" style={{width:135}} value={it.assembly_date} onChange={e=>{const n=[...newItems];n[idx].assembly_date=e.target.value;setNewItems(n);}}/><input className="input" style={{flex:1,minWidth:60}} value={it.note} onChange={e=>{const n=[...newItems];n[idx].note=e.target.value;setNewItems(n);}} placeholder="å‚™è¨»"/>{newItems.length>1&&<button className="btn btn-secondary btn-sm" style={{color:"var(--danger)"}} onClick={()=>setNewItems(newItems.filter((_,i)=>i!==idx))}>âœ•</button>}</div>)}<div style={{display:"flex",gap:8,marginTop:10}}><button className="btn btn-secondary btn-sm" onClick={()=>setNewItems([...newItems,{product_id:"",qty:1,customer_id:"",tester:"",inspector:"",assembly_date:"",note:""}])}>+ æ–°å¢ç”¢å“è¡Œ</button><button className="btn btn-primary" onClick={create}>ç¢ºèªå»ºç«‹</button></div></div>}
    {loading?<div className="spinner"/>:<div className="split-view"><div className="split-left">{orders.map(o=><div key={o.id} className={`order-card ${sel===o.id?"selected":""}`} onClick={()=>loadItems(o.id)}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><code className="order-no">{o.order_no}</code><Badge type={sC[o.status]}>{sL[o.status]}</Badge></div><div className="order-date">ğŸ“… {o.order_date}</div></div>)}{!orders.length&&<div style={{textAlign:"center",padding:30,color:"var(--muted)"}}>å°šç„¡åŒ…è£å–®</div>}</div>{sel&&<div className="split-right">
      {selOrder&&selOrder.status==="draft"&&<div style={{display:"flex",gap:8,marginBottom:10}}><button className="btn btn-primary btn-sm" style={{background:"var(--success)"}} onClick={()=>approveOrder(sel)}>âœ“ æ ¸å‡†</button><button className="btn btn-secondary btn-sm" style={{color:"var(--danger)"}} onClick={()=>{if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤åŒ…è£å–®ï¼Ÿ")){(async()=>{try{await supaDelete("packaging_items",`order_id=eq.${sel}`);await supaDelete("packaging_orders",`id=eq.${sel}`);toast("å·²åˆªé™¤","success");setSel(null);load();}catch(e){toast("åˆªé™¤å¤±æ•—: "+e.message,"error");}})();}}}>ğŸ—‘ åˆªé™¤</button></div>}
      {selOrder&&selOrder.status==="approved"&&<div style={{display:"flex",gap:8,marginBottom:10}}><button className="btn btn-secondary btn-sm" onClick={()=>revertDraft(sel)}>â†© é€€å›è‰ç¨¿</button></div>}
      <div className="table-wrap"><table><thead><tr>{["ç”¢å“ç·¨è™Ÿ","ç”¢å“åç¨±","æ•¸é‡","å®¢æˆ¶","æ¸¬è©¦äººå“¡","æª¢é©—äººå“¡","çµ„è£æ—¥æœŸ","å‚™è¨»",""].map(h=><th key={h}>{h}</th>)}</tr></thead><tbody>{items.map(it=><tr key={it.id}><td><code style={{fontWeight:600}}>{it.products?.product_id}</code></td><td>{it.products?.product_name}</td><td style={{fontWeight:700,fontFamily:"'JetBrains Mono',monospace"}}>{it.qty}</td><td>{it.is_stock?"åº«å­˜":it.customers?.name||"-"}</td><td>{it.tester||"-"}</td><td>{it.inspector||"-"}</td><td>{it.assembly_date||"-"}</td><td>{it.note||"-"}</td><td><button className="btn-edit" onClick={()=>setEditModal({show:true,item:{id:it.id,qty:it.qty,orderNo:selOrder?.order_no,productCode:it.products?.product_id,productName:it.products?.product_name}})}>ä¿®æ”¹</button></td></tr>)}</tbody></table></div></div>}</div>}
  </div>;
}

// ============================================================
// Testing Tab
// ============================================================
function TestingTab({products,staff,toast,reloadStaff}){
  const[orders,setOrders]=useState([]);const[items,setItems]=useState([]);const[sel,setSel]=useState(null);const[loading,setLoading]=useState(true);const[showForm,setShowForm]=useState(false);const[orderDate,setOrderDate]=useState(new Date().toISOString().slice(0,10));const[newItems,setNewItems]=useState([{product_id:"",qty:1,tester:"",note:""}]);
  const[staffModal,setStaffModal]=useState(false);
  const load=useCallback(async()=>{setLoading(true);try{setOrders(await supaFetch("testing_orders",{query:"select=*&order=order_date.desc,created_at.desc"})||[]);}catch(e){}setLoading(false);},[]);
  useEffect(()=>{load();},[load]);
  const loadItems=async id=>{try{setItems(await supaFetch("testing_items",{query:`select=*,products(product_id,product_name)&order_id=eq.${id}`})||[]);setSel(id);}catch(e){}};
  const create=async()=>{const valid=newItems.filter(it=>it.product_id&&it.qty>0);if(!valid.length){toast("è«‹è‡³å°‘æ–°å¢ä¸€å€‹ç”¢å“","error");return;}try{const[order]=await supaFetch("testing_orders",{method:"POST",body:{order_date:orderDate,status:"draft"}});for(const it of valid)await supaFetch("testing_items",{method:"POST",body:{order_id:order.id,product_id:it.product_id,qty:parseInt(it.qty),tester:it.tester,note:it.note}});toast("æ¸¬è©¦å–®å»ºç«‹æˆåŠŸï¼å–®è™Ÿ: "+order.order_no,"success");setShowForm(false);setNewItems([{product_id:"",qty:1,tester:"",note:""}]);load();}catch(e){toast("å»ºç«‹å¤±æ•—: "+e.message,"error");}};
  const addStaff=async(name,role)=>{try{await supaFetch("staff",{method:"POST",body:{name,role}});toast(`äººå“¡ã€Œ${name}ã€æ–°å¢æˆåŠŸ`,"success");reloadStaff();}catch(e){toast("æ–°å¢å¤±æ•—: "+e.message,"error");}};
  const sC={draft:"neutral",submitted:"info",approved:"success",rejected:"error"};const sL={draft:"è‰ç¨¿",submitted:"å·²é€ç°½",approved:"å·²æ ¸å‡†",rejected:"å·²é€€å›"};
  return <div>
    <AddStaffModal show={staffModal} defaultRole="tester" onClose={()=>setStaffModal(false)} onSave={addStaff}/>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}><span style={{fontSize:12,color:"var(--muted)"}}>å…± {orders.length} ç­†æ¸¬è©¦å–®</span><button className="btn btn-primary" onClick={()=>setShowForm(!showForm)}>{showForm?"å–æ¶ˆ":"+ æ–°å¢æ¸¬è©¦å–®"}</button></div>
    {showForm&&<div className="form-box"><div className="form-title">æ–°å¢æ¸¬è©¦å–®</div><div className="form-row" style={{marginBottom:12}}><span className="filter-label">æ¸¬è©¦æ—¥æœŸï¼š</span><input type="date" className="input" value={orderDate} onChange={e=>setOrderDate(e.target.value)} style={{width:160}}/></div>{newItems.map((it,idx)=><div key={idx} className="form-row"><ProductSearch products={products} value={it.product_id} onChange={v=>{const n=[...newItems];n[idx].product_id=v;setNewItems(n);}} style={{minWidth:240,flex:2}}/><input type="number" className="input" style={{width:65}} min="1" value={it.qty} onChange={e=>{const n=[...newItems];n[idx].qty=e.target.value;setNewItems(n);}} placeholder="æ•¸é‡"/><StaffSelect staff={staff} value={it.tester} onChange={v=>{const n=[...newItems];n[idx].tester=v;setNewItems(n);}} onAdd={()=>setStaffModal(true)} roleFilter="tester" placeholder="æ¸¬è©¦äººå“¡" multi style={{width:180}}/><input className="input" style={{flex:1,minWidth:80}} value={it.note} onChange={e=>{const n=[...newItems];n[idx].note=e.target.value;setNewItems(n);}} placeholder="å‚™è¨»"/>{newItems.length>1&&<button className="btn btn-secondary btn-sm" style={{color:"var(--danger)"}} onClick={()=>setNewItems(newItems.filter((_,i)=>i!==idx))}>âœ•</button>}</div>)}<div style={{display:"flex",gap:8,marginTop:10}}><button className="btn btn-secondary btn-sm" onClick={()=>setNewItems([...newItems,{product_id:"",qty:1,tester:"",note:""}])}>+ æ–°å¢ç”¢å“è¡Œ</button><button className="btn btn-primary" onClick={create}>ç¢ºèªå»ºç«‹</button></div></div>}
    {loading?<div className="spinner"/>:<div className="split-view"><div className="split-left">{orders.map(o=><div key={o.id} className={`order-card ${sel===o.id?"selected":""}`} onClick={()=>loadItems(o.id)}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><code className="order-no">{o.order_no}</code><Badge type={sC[o.status]}>{sL[o.status]}</Badge></div><div className="order-date">ğŸ“… {o.order_date}</div></div>)}{!orders.length&&<div style={{textAlign:"center",padding:30,color:"var(--muted)"}}>å°šç„¡æ¸¬è©¦å–®</div>}</div>{sel&&<div className="split-right"><div className="table-wrap"><table><thead><tr>{["ç”¢å“ç·¨è™Ÿ","ç”¢å“åç¨±","æ¸¬è©¦æ•¸é‡","æ¸¬è©¦äººå“¡","çµæœ","å‚™è¨»"].map(h=><th key={h}>{h}</th>)}</tr></thead><tbody>{items.map(it=><tr key={it.id}><td><code style={{fontWeight:600}}>{it.products?.product_id}</code></td><td>{it.products?.product_name}</td><td style={{fontWeight:700,fontFamily:"'JetBrains Mono',monospace"}}>{it.qty}</td><td>{it.tester||"-"}</td><td><Badge type={it.test_result==="pass"?"success":it.test_result==="fail"?"error":"neutral"}>{it.test_result==="pass"?"é€šé":it.test_result==="fail"?"ä¸åˆæ ¼":"å¾…æ¸¬è©¦"}</Badge></td><td>{it.note||"-"}</td></tr>)}</tbody></table></div></div>}</div>}
  </div>;
}

// ============================================================
// Products Tab
// ============================================================
function ProductsTab({products,reload,toast}){
  const[showForm,setShowForm]=useState(false);const[form,setForm]=useState({product_id:"",product_name:"",category:"",spec:""});const[search,setSearch]=useState("");
  const create=async()=>{if(!form.product_id||!form.product_name){toast("è«‹å¡«å¯«ç”¢å“ç·¨è™Ÿå’Œåç¨±","error");return;}try{await supaFetch("products",{method:"POST",body:form});toast("ç”¢å“æ–°å¢æˆåŠŸ","success");setForm({product_id:"",product_name:"",category:"",spec:""});setShowForm(false);reload();}catch(e){toast("æ–°å¢å¤±æ•—: "+e.message,"error");}};
  const filtered=products.filter(p=>{if(!search)return true;const s=search.toLowerCase();return p.product_id.toLowerCase().includes(s)||p.product_name.toLowerCase().includes(s)||(p.category||"").toLowerCase().includes(s);});
  return <div>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16,flexWrap:"wrap",gap:8}}><div style={{display:"flex",alignItems:"center",gap:10}}><span style={{fontSize:12,color:"var(--muted)"}}>å…± {products.length} å€‹ç”¢å“</span><input className="input" style={{width:250}} placeholder="ğŸ” æœå°‹ç”¢å“..." value={search} onChange={e=>setSearch(e.target.value)}/>{search&&<span style={{fontSize:12,color:"var(--muted)"}}>æ‰¾åˆ° {filtered.length} ç­†</span>}</div><button className="btn btn-primary" onClick={()=>setShowForm(!showForm)}>{showForm?"å–æ¶ˆ":"+ æ–°å¢ç”¢å“"}</button></div>
    {showForm&&<div className="form-box"><div className="form-title">æ–°å¢ç”¢å“</div><div className="form-row"><input className="input" style={{width:150}} value={form.product_id} onChange={e=>setForm({...form,product_id:e.target.value})} placeholder="ç”¢å“ç·¨è™Ÿ"/><input className="input" style={{flex:1}} value={form.product_name} onChange={e=>setForm({...form,product_name:e.target.value})} placeholder="ç”¢å“åç¨±"/><input className="input" style={{width:80}} value={form.category} onChange={e=>setForm({...form,category:e.target.value})} placeholder="åˆ†é¡"/><input className="input" style={{flex:1}} value={form.spec} onChange={e=>setForm({...form,spec:e.target.value})} placeholder="è¦æ ¼"/><button className="btn btn-primary" onClick={create}>æ–°å¢</button></div></div>}
    <div className="table-wrap"><table><thead><tr>{["ç”¢å“ç·¨è™Ÿ","ç”¢å“åç¨±","åˆ†é¡"].map(h=><th key={h}>{h}</th>)}</tr></thead><tbody>{filtered.slice(0,200).map(p=><tr key={p.id}><td><code style={{fontWeight:600}}>{p.product_id}</code></td><td>{p.product_name}</td><td><Badge type="info">{p.category||"-"}</Badge></td></tr>)}{filtered.length>200&&<tr><td colSpan={3} style={{textAlign:"center",padding:10,color:"var(--muted)"}}>é¡¯ç¤ºå‰ 200 ç­†</td></tr>}</tbody></table></div>
  </div>;
}

// ============================================================
// Staff Management Tab
// ============================================================
function StaffTab({staff,toast,reloadStaff}){
  const[showForm,setShowForm]=useState(false);
  const[form,setForm]=useState({name:"",role:"general"});
  const[search,setSearch]=useState("");
  const[editingId,setEditingId]=useState(null);
  const[editForm,setEditForm]=useState({name:"",role:""});

  const roleLabels={assembler:"çµ„è£äººå“¡",tester:"æ¸¬è©¦äººå“¡",inspector:"æª¢é©—äººå“¡",general:"ä¸€èˆ¬"};
  const roleBadge={assembler:"info",tester:"warning",inspector:"success",general:"neutral"};

  const create=async()=>{if(!form.name.trim()){toast("è«‹å¡«å¯«å§“å","error");return;}try{await supaFetch("staff",{method:"POST",body:{name:form.name.trim(),role:form.role}});toast(`äººå“¡ã€Œ${form.name}ã€æ–°å¢æˆåŠŸ`,"success");setForm({name:"",role:"general"});setShowForm(false);reloadStaff();}catch(e){toast("æ–°å¢å¤±æ•—: "+e.message,"error");}};

  const startEdit=(s)=>{setEditingId(s.id);setEditForm({name:s.name,role:s.role});};
  const saveEdit=async()=>{if(!editForm.name.trim()){toast("å§“åä¸èƒ½ç©ºç™½","error");return;}try{await supaPatch("staff",`id=eq.${editingId}`,{name:editForm.name.trim(),role:editForm.role});toast("å·²ä¿®æ”¹","success");setEditingId(null);reloadStaff();}catch(e){toast("ä¿®æ”¹å¤±æ•—: "+e.message,"error");}};

  const deleteStaff=async(s)=>{if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${s.name}ã€ï¼Ÿ`))return;try{await supaPatch("staff",`id=eq.${s.id}`,{is_active:false});toast(`å·²åˆªé™¤ã€Œ${s.name}ã€`,"success");reloadStaff();}catch(e){toast("åˆªé™¤å¤±æ•—: "+e.message,"error");}};

  const filtered=staff.filter(s=>{if(!search)return true;const q=search.toLowerCase();return s.name.toLowerCase().includes(q)||(roleLabels[s.role]||"").includes(q);});

  return <div>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16,flexWrap:"wrap",gap:8}}>
      <div style={{display:"flex",alignItems:"center",gap:10}}>
        <span style={{fontSize:12,color:"var(--muted)"}}>å…± {staff.length} ä½äººå“¡</span>
        <input className="input" style={{width:200}} placeholder="ğŸ” æœå°‹äººå“¡..." value={search} onChange={e=>setSearch(e.target.value)}/>
      </div>
      <button className="btn btn-primary" onClick={()=>setShowForm(!showForm)}>{showForm?"å–æ¶ˆ":"+ æ–°å¢äººå“¡"}</button>
    </div>
    {showForm&&<div className="form-box"><div className="form-title">æ–°å¢äººå“¡</div><div className="form-row">
      <input className="input" style={{flex:1}} value={form.name} onChange={e=>setForm({...form,name:e.target.value})} placeholder="å§“å" onKeyDown={e=>e.key==="Enter"&&create()}/>
      <select className="input" style={{width:120}} value={form.role} onChange={e=>setForm({...form,role:e.target.value})}>
        <option value="assembler">çµ„è£äººå“¡</option><option value="tester">æ¸¬è©¦äººå“¡</option><option value="inspector">æª¢é©—äººå“¡</option><option value="general">ä¸€èˆ¬</option>
      </select>
      <button className="btn btn-primary" onClick={create}>æ–°å¢</button>
    </div></div>}
    <div className="table-wrap"><table>
      <thead><tr><th>å§“å</th><th>è§’è‰²</th><th style={{width:120}}>æ“ä½œ</th></tr></thead>
      <tbody>{filtered.map(s=><tr key={s.id}>
        {editingId===s.id?<>
          <td><input className="input" style={{width:"100%",padding:"4px 8px"}} value={editForm.name} onChange={e=>setEditForm({...editForm,name:e.target.value})} onKeyDown={e=>e.key==="Enter"&&saveEdit()}/></td>
          <td><select className="input" style={{width:"100%",padding:"4px 8px"}} value={editForm.role} onChange={e=>setEditForm({...editForm,role:e.target.value})}>
            <option value="assembler">çµ„è£äººå“¡</option><option value="tester">æ¸¬è©¦äººå“¡</option><option value="inspector">æª¢é©—äººå“¡</option><option value="general">ä¸€èˆ¬</option>
          </select></td>
          <td><div style={{display:"flex",gap:4}}><button className="btn-edit" style={{background:"var(--primary)",color:"#fff",border:"none"}} onClick={saveEdit}>å„²å­˜</button><button className="btn-edit" onClick={()=>setEditingId(null)}>å–æ¶ˆ</button></div></td>
        </>:<>
          <td style={{fontWeight:600}}>{s.name}</td>
          <td><Badge type={roleBadge[s.role]}>{roleLabels[s.role]||s.role}</Badge></td>
          <td><div style={{display:"flex",gap:4}}><button className="btn-edit" onClick={()=>startEdit(s)}>ä¿®æ”¹</button><button className="btn-edit" style={{borderColor:"var(--danger)",color:"var(--danger)"}} onClick={()=>deleteStaff(s)}>åˆªé™¤</button></div></td>
        </>}
      </tr>)}</tbody>
    </table></div>
  </div>;
}

// ============================================================
// Main App
// ============================================================
const TABS=[{key:"reconciliation",label:"æ ¸å°å ±å‘Š",icon:"ğŸ“Š"},{key:"assembly",label:"çµ„è£å–®",icon:"ğŸ”§"},{key:"packaging",label:"åŒ…è£å‡ºè²¨å…¥åº«",icon:"ğŸ“¦"},{key:"testing",label:"æ¸¬è©¦è¡¨",icon:"ğŸ§ª"},{key:"products",label:"ç”¢å“ä¸»æª”",icon:"ğŸ­"},{key:"staff",label:"äººå“¡ç®¡ç†",icon:"ğŸ‘¥"}];

function App(){
  const[tab,setTab]=useState("reconciliation");const[products,setProducts]=useState([]);const[customers,setCustomers]=useState([]);const[staff,setStaff]=useState([]);
  const[toastMsg,setToastMsg]=useState(null);const[toastType,setToastType]=useState("success");
  const toast=(msg,type="success")=>{setToastMsg(msg);setToastType(type);setTimeout(()=>setToastMsg(null),4000);};
  const loadProducts=useCallback(async()=>{try{setProducts(await supaFetch("products",{query:"select=*&is_active=eq.true&order=product_id"})||[]);}catch(e){}},[]);
  const loadCustomers=useCallback(async()=>{try{setCustomers(await supaFetch("customers",{query:"select=*&is_active=eq.true&order=name"})||[]);}catch(e){}},[]);
  const loadStaff=useCallback(async()=>{try{setStaff(await supaFetch("staff",{query:"select=*&is_active=eq.true&order=name"})||[]);}catch(e){}},[]);
  useEffect(()=>{loadProducts();loadCustomers();loadStaff();},[loadProducts,loadCustomers,loadStaff]);

  return <div>
    <Toast message={toastMsg} type={toastType} onClose={()=>setToastMsg(null)}/>
    <div className="print-header"><h1>I-Reporter</h1><p></p></div>
    <div className="header"><div className="header-inner"><div style={{display:"flex",alignItems:"center",gap:12}}><div className="header-logo">âš™</div><div><div className="header-title">I-Reporter</div><div className="header-sub">æˆå“çµ„è£ Ã— åŒ…è£å…¥åº« Ã— æ¸¬è©¦ æ ¸å°ç³»çµ±</div></div></div><div style={{color:"rgba(255,255,255,.4)",fontSize:11,fontFamily:"'JetBrains Mono',monospace"}}>v1.4 Â· {products.length} products Â· {staff.length} staff</div></div></div>
    <div className="tab-bar"><div className="tab-bar-inner">{TABS.map(t=><button key={t.key} className={`tab-btn ${tab===t.key?"active":""}`} onClick={()=>setTab(t.key)}><span>{t.icon}</span>{t.label}</button>)}</div></div>
    <div className="content">
      {tab==="reconciliation"&&<ReconciliationTab products={products} customers={customers} staff={staff} toast={toast} reloadStaff={loadStaff}/>}
      {tab==="assembly"&&<AssemblyTab products={products} staff={staff} toast={toast} reloadStaff={loadStaff}/>}
      {tab==="packaging"&&<PackagingTab products={products} customers={customers} staff={staff} toast={toast} reloadStaff={loadStaff}/>}
      {tab==="testing"&&<TestingTab products={products} staff={staff} toast={toast} reloadStaff={loadStaff}/>}
      {tab==="products"&&<ProductsTab products={products} reload={loadProducts} toast={toast}/>}
      {tab==="staff"&&<StaffTab staff={staff} toast={toast} reloadStaff={loadStaff}/>}
    </div>
    <div className="footer">I-Reporter v1.4 Â· æˆå“çµ„è£ Ã— åŒ…è£å…¥åº« Ã— æ¸¬è©¦ æ ¸å°ç³»çµ±</div>
  </div>;
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
